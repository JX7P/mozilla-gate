diff -ruN comm-release/autom4te.cache/output.0t comm-patched/autom4te.cache/output.0t
--- comm-release/autom4te.cache/output.0t	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/autom4te.cache/output.0t	2014-04-27 14:10:17.707784168 +0100
@@ -0,0 +1 @@
+@%:@! /bin/sh
diff -ruN comm-release/autom4te.cache/traces.0t comm-patched/autom4te.cache/traces.0t
--- comm-release/autom4te.cache/traces.0t	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/autom4te.cache/traces.0t	2014-04-27 14:10:17.708005140 +0100
@@ -0,0 +1,200 @@
+m4trace:mozilla/build/autoconf/config.status.m4:186: -1- AC_SUBST([MOZ_PSEUDO_DERECURSE])
+m4trace:mozilla/build/autoconf/config.status.m4:186: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:aclocal.m4:23: -1- _m4_warn([syntax], [AC_INIT_BINSH is m4_require'd but not m4_defun'd], [mozilla/build/autoconf/mozprog.m4:5: MOZ_PROG_CHECKMSYS is expanded from...
+aclocal.m4:23: the top level])
+m4trace:aclocal.m4:29: -1- _m4_warn([syntax], [AC_INIT_BINSH is m4_require'd but not m4_defun'd], [mozilla/build/autoconf/altoptions.m4:117: MOZ_READ_MOZCONFIG is expanded from...
+aclocal.m4:29: the top level])
+m4trace:configure.in:11: -1- AC_INIT([config/config.mk])
+m4trace:configure.in:11: -1- m4_pattern_forbid([^_?A[CHUM]_])
+m4trace:configure.in:11: -1- m4_pattern_forbid([_AC_])
+m4trace:configure.in:11: -1- m4_pattern_forbid([^LIBOBJS$], [do not use LIBOBJS directly, use AC_LIBOBJ (see section `AC_LIBOBJ vs LIBOBJS'])
+m4trace:configure.in:11: -1- m4_pattern_allow([^AS_FLAGS$])
+m4trace:configure.in:11: -1- m4_pattern_forbid([^_?m4_])
+m4trace:configure.in:11: -1- m4_pattern_forbid([^dnl$])
+m4trace:configure.in:11: -1- m4_pattern_forbid([^_?AS_])
+m4trace:configure.in:11: -1- AC_SUBST([SHELL])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PATH_SEPARATOR])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PACKAGE_NAME], [m4_ifdef([AC_PACKAGE_NAME],      ['AC_PACKAGE_NAME'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PACKAGE_TARNAME], [m4_ifdef([AC_PACKAGE_TARNAME],   ['AC_PACKAGE_TARNAME'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PACKAGE_VERSION], [m4_ifdef([AC_PACKAGE_VERSION],   ['AC_PACKAGE_VERSION'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PACKAGE_STRING], [m4_ifdef([AC_PACKAGE_STRING],    ['AC_PACKAGE_STRING'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PACKAGE_BUGREPORT], [m4_ifdef([AC_PACKAGE_BUGREPORT], ['AC_PACKAGE_BUGREPORT'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([PACKAGE_URL], [m4_ifdef([AC_PACKAGE_URL],       ['AC_PACKAGE_URL'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([exec_prefix], [NONE])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([prefix], [NONE])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([program_transform_name], [s,x,x,])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([bindir], ['${exec_prefix}/bin'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([sbindir], ['${exec_prefix}/sbin'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([libexecdir], ['${exec_prefix}/libexec'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([datarootdir], ['${prefix}/share'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([datadir], ['${datarootdir}'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([sysconfdir], ['${prefix}/etc'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([sharedstatedir], ['${prefix}/com'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([localstatedir], ['${prefix}/var'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([includedir], ['${prefix}/include'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([oldincludedir], ['/usr/include'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([docdir], [m4_ifset([AC_PACKAGE_TARNAME],
+				     ['${datarootdir}/doc/${PACKAGE_TARNAME}'],
+				     ['${datarootdir}/doc/${PACKAGE}'])])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([infodir], ['${datarootdir}/info'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([htmldir], ['${docdir}'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([dvidir], ['${docdir}'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([pdfdir], ['${docdir}'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([psdir], ['${docdir}'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([libdir], ['${exec_prefix}/lib'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([localedir], ['${datarootdir}/locale'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([mandir], ['${datarootdir}/man'])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_NAME])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_NAME$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_NAME])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_NAME$])
+m4trace:configure.in:11: -2- AH_OUTPUT([PACKAGE_NAME], [/* Define to the full name of this package. */
+@%:@undef PACKAGE_NAME])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_NAME])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_NAME$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_TARNAME])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_TARNAME$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_TARNAME])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_TARNAME$])
+m4trace:configure.in:11: -2- AH_OUTPUT([PACKAGE_TARNAME], [/* Define to the one symbol short name of this package. */
+@%:@undef PACKAGE_TARNAME])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_TARNAME])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_TARNAME$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_VERSION])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_VERSION$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_VERSION])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_VERSION$])
+m4trace:configure.in:11: -2- AH_OUTPUT([PACKAGE_VERSION], [/* Define to the version of this package. */
+@%:@undef PACKAGE_VERSION])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_VERSION])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_VERSION$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_STRING])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_STRING$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_STRING])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_STRING$])
+m4trace:configure.in:11: -2- AH_OUTPUT([PACKAGE_STRING], [/* Define to the full name and version of this package. */
+@%:@undef PACKAGE_STRING])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_STRING])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_STRING$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_BUGREPORT])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_BUGREPORT$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_BUGREPORT])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_BUGREPORT$])
+m4trace:configure.in:11: -2- AH_OUTPUT([PACKAGE_BUGREPORT], [/* Define to the address where bug reports for this package should be sent. */
+@%:@undef PACKAGE_BUGREPORT])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_BUGREPORT])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_BUGREPORT$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_URL])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_URL$])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_URL])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_URL$])
+m4trace:configure.in:11: -2- AH_OUTPUT([PACKAGE_URL], [/* Define to the home page for this package. */
+@%:@undef PACKAGE_URL])
+m4trace:configure.in:11: -2- AC_DEFINE_TRACE_LITERAL([PACKAGE_URL])
+m4trace:configure.in:11: -2- m4_pattern_allow([^PACKAGE_URL$])
+m4trace:configure.in:11: -1- AC_SUBST([DEFS])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([ECHO_C])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([ECHO_N])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([ECHO_T])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([LIBS])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([build_alias])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([host_alias])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:11: -1- AC_SUBST([target_alias])
+m4trace:configure.in:11: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:13: -1- AC_CONFIG_AUX_DIR([${MOZILLA_SRCDIR}/build/autoconf])
+m4trace:configure.in:14: -1- AC_CANONICAL_SYSTEM
+m4trace:configure.in:14: -1- _m4_warn([obsolete], [The macro `AC_CANONICAL_SYSTEM' is obsolete.
+You should run autoupdate.], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_CANONICAL_TARGET
+m4trace:configure.in:14: -1- AC_CANONICAL_HOST
+m4trace:configure.in:14: -1- AC_CANONICAL_BUILD
+m4trace:configure.in:14: -1- AC_REQUIRE_AUX_FILE([config.sub])
+m4trace:configure.in:14: -1- AC_REQUIRE_AUX_FILE([config.guess])
+m4trace:configure.in:14: -1- AC_SUBST([build], [$ac_cv_build])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([build_cpu], [$[1]])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([build_vendor], [$[2]])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([build_os])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([host], [$ac_cv_host])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([host_cpu], [$[1]])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([host_vendor], [$[2]])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([host_os])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([target], [$ac_cv_target])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([target_cpu], [$[1]])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([target_vendor], [$[2]])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:14: -1- AC_SUBST([target_os])
+m4trace:configure.in:14: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/general.m4:1857: AC_CANONICAL_SYSTEM is expanded from...
+configure.in:14: the top level])
+m4trace:configure.in:60: -1- AC_SUBST([PYTHON])
+m4trace:configure.in:60: -2- _m4_warn([syntax], [prefer named diversions], [../../lib/autoconf/programs.m4:155: AC_PATH_PROG is expanded from...
+../../lib/autoconf/programs.m4:164: AC_PATH_PROGS is expanded from...
+mozilla/build/autoconf/mozprog.m4:28: MOZ_PATH_PROGS is expanded from...
+mozilla/build/autoconf/python-virtualenv.m4:5: MOZ_PYTHON is expanded from...
+configure.in:60: the top level])
+m4trace:configure.in:60: -1- AC_SUBST([PYTHON])
+m4trace:configure.in:60: -1- AC_SUBST([PYTHON_SITE_PACKAGES])
+m4trace:configure.in:60: -2- _m4_warn([syntax], [prefer named diversions], [mozilla/build/autoconf/python-virtualenv.m4:5: MOZ_PYTHON is expanded from...
+configure.in:60: the top level])
+m4trace:configure.in:177: -1- AC_SUBST([WIN_TOP_SRC])
+m4trace:configure.in:177: -2- _m4_warn([syntax], [prefer named diversions], [])
+m4trace:configure.in:177: -1- AC_SUBST([top_srcdir])
+m4trace:configure.in:177: -2- _m4_warn([syntax], [prefer named diversions], [])
diff -ruN comm-release/config/baseconfig.mk comm-patched/config/baseconfig.mk
--- comm-release/config/baseconfig.mk	2014-03-19 01:33:03.000000000 +0000
+++ comm-patched/config/baseconfig.mk	2014-04-27 14:07:20.221468402 +0100
@@ -1,7 +1,7 @@
-includedir := $(includedir)/$(MOZ_APP_NAME)-$(MOZ_APP_VERSION)
-idldir = $(datadir)/idl/$(MOZ_APP_NAME)-$(MOZ_APP_VERSION)
-installdir = $(libdir)/$(MOZ_APP_NAME)-$(MOZ_APP_VERSION)
-sdkdir = $(libdir)/$(MOZ_APP_NAME)-devel-$(MOZ_APP_VERSION)
+includedir := $(includedir)/$(MOZILLA_PKG_NAME)
+idldir = $(datadir)/idl/$(MOZILLA_PKG_NAME)
+installdir = $(libdir)/$(MOZILLA_PKG_NAME)
+sdkdir = $(libdir)/$(MOZILLA_PKG_NAME)-sdk
 MOZILLA_SRCDIR = $(topsrcdir)/mozilla
 MOZDEPTH = $(DEPTH)/mozilla
 DIST = $(MOZDEPTH)/dist
diff -ruN comm-release/config/config.mk comm-patched/config/config.mk
--- comm-release/config/config.mk	2014-03-19 01:33:03.000000000 +0000
+++ comm-patched/config/config.mk	2014-04-27 14:07:20.222515610 +0100
@@ -401,6 +401,7 @@
 # Default command macros; can be overridden in <arch>.mk.
 #
 CCC		= $(CXX)
+XPIDL_LINK = $(PYTHON) $(LIBXUL_DIST)/sdk/bin/xpt.py link
 
 OS_INCLUDES += $(NSPR_CFLAGS) $(NSS_CFLAGS) $(MOZ_JPEG_CFLAGS) $(MOZ_PNG_CFLAGS) $(MOZ_ZLIB_CFLAGS)
 
diff -ruN comm-release/ldap/sdks/c-sdk/build.mk comm-patched/ldap/sdks/c-sdk/build.mk
--- comm-release/ldap/sdks/c-sdk/build.mk	2014-03-19 01:42:29.000000000 +0000
+++ comm-patched/ldap/sdks/c-sdk/build.mk	2014-04-27 14:07:20.223627694 +0100
@@ -488,21 +488,21 @@
 LINK_LIB2       = $(RM) $@; $(AR) $@ $(OBJS2); $(RANLIB) $@
 ifneq ($(LD),$(CC))
 ifdef SONAMEFLAG_PREFIX
-LINK_DLL        = $(LD) $(DSO_LDOPTS) $(LDRPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) \
+LINK_DLL        = $(LD) $(DSO_LDOPTS) $(LDRPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) $(OS_LDFLAGS) \
                         $(DLL_LDFLAGS) $(DLL_EXPORT_FLAGS) \
                         -o $@ $(SONAMEFLAG_PREFIX)$(notdir $@) $(OBJS)
 else # SONAMEFLAG_PREFIX
-LINK_DLL        = $(LD) $(DSO_LDOPTS) $(LDRPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) \
+LINK_DLL        = $(LD) $(DSO_LDOPTS) $(LDRPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) $(OS_LDFLAGS) \
                         $(DLL_LDFLAGS) $(DLL_EXPORT_FLAGS) \
                         -o $@ $(OBJS)
 endif # SONAMEFLAG_PREFIX
 else  # $(CC) is used to link libs
 ifdef SONAMEFLAG_PREFIX
-LINK_DLL        = $(LD) $(DSO_LDOPTS) $(RPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) \
+LINK_DLL        = $(LD) $(DSO_LDOPTS) $(RPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) $(OS_LDFLAGS) \
                         $(DLL_LDFLAGS) $(DLL_EXPORT_FLAGS) \
                         -o $@ $(SONAMEFLAG_PREFIX)$(notdir $@) $(OBJS)
 else # SONAMEFLAG_PREFIX
-LINK_DLL        = $(LD) $(DSO_LDOPTS) $(RPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) \
+LINK_DLL        = $(LD) $(DSO_LDOPTS) $(RPATHFLAG_PREFIX)$(RPATHFLAG) $(ALDFLAGS) $(OS_LDFLAGS) \
                         $(DLL_LDFLAGS) $(DLL_EXPORT_FLAGS) \
                         -o $@ $(OBJS)
 endif # SONAMEFLAG_PREFIX
@@ -517,7 +517,7 @@
 endif
 
 ifneq (,$(filter BeOS Darwin NetBSD,$(OS_ARCH)))
-LINK_DLL	= $(MKSHLIB) $(OBJS)
+LINK_DLL	= $(MKSHLIB) $(OBJS) $(OS_LDFLAGS)
 endif
 
 ifeq ($(OS_ARCH), HP-UX)
diff -ruN comm-release/ldap/sdks/c-sdk/ldap/include/portable.h comm-patched/ldap/sdks/c-sdk/ldap/include/portable.h
--- comm-release/ldap/sdks/c-sdk/ldap/include/portable.h	2014-03-19 01:42:29.000000000 +0000
+++ comm-patched/ldap/sdks/c-sdk/ldap/include/portable.h	2014-04-27 14:07:20.224519850 +0100
@@ -122,8 +122,11 @@
  * some systems don't have the BSD re_comp and re_exec routines
  */
 #ifndef NEED_BSDREGEX
-#if ( defined( SYSV ) || defined( NETBSD ) || defined( FREEBSD ) || defined(__OpenBSD__) || defined( linux ) || defined( DARWIN )) && !defined(sgi)
+#if ( defined( SYSV ) || defined( NETBSD ) || defined(DRAGONFLY) || defined( FREEBSD ) || defined(__OpenBSD__) || defined( linux ) || defined( DARWIN )) && !defined(sgi)
 #define NEED_BSDREGEX
+/* there are conflicting prototypes in unistd.h on DragonFly */
+#define re_comp ldap_compat_re_comp
+#define re_exec ldap_compat_re_exec
 #endif
 #endif
 
diff -ruN comm-release/mail/app/Makefile.in comm-patched/mail/app/Makefile.in
--- comm-release/mail/app/Makefile.in	2014-03-19 01:33:03.000000000 +0000
+++ comm-patched/mail/app/Makefile.in	2014-04-27 14:07:20.225279855 +0100
@@ -57,6 +57,10 @@
 DEFINES += -DXPCOM_GLUE
 STL_FLAGS=
 
+ifeq ($(OS_ARCH),NetBSD)
+LIBS += -lossaudio
+endif
+
 LIBS += \
 	$(XPCOM_STANDALONE_GLUE_LDOPTS) \
 	$(NULL)
diff -ruN comm-release/mailnews/base/search/src/nsMsgSearchTerm.cpp comm-patched/mailnews/base/search/src/nsMsgSearchTerm.cpp
--- comm-release/mailnews/base/search/src/nsMsgSearchTerm.cpp	2014-03-19 01:33:04.000000000 +0000
+++ comm-patched/mailnews/base/search/src/nsMsgSearchTerm.cpp	2014-04-27 14:07:20.227003570 +0100
@@ -197,7 +197,7 @@
     }
   }
   if (!found)
-    *string = ""; // don't leave the string uninitialized
+    *string = NULL; // don't leave the string uninitialized
 
   // we no longer return invalid attribute. If we cannot find the string in the table,
   // then it is an arbitrary header. Return success regardless if found or not
diff -ruN comm-release/mozilla/browser/app/nsBrowserApp.cpp comm-patched/mozilla/browser/app/nsBrowserApp.cpp
--- comm-release/mozilla/browser/app/nsBrowserApp.cpp	2014-03-19 01:41:43.000000000 +0000
+++ comm-patched/mozilla/browser/app/nsBrowserApp.cpp	2014-04-27 14:07:20.228859226 +0100
@@ -586,6 +586,7 @@
   TriggerQuirks();
 #endif
 
+  setenv("MOZ_PLUGIN_PATH", "%%LOCALBASE%%/lib/browser_plugins/symlinks/gecko", 0);
   int gotCounters;
 #if defined(XP_UNIX)
   struct rusage initialRUsage;
diff -ruN comm-release/mozilla/browser/app/profile/firefox.js comm-patched/mozilla/browser/app/profile/firefox.js
--- comm-release/mozilla/browser/app/profile/firefox.js	2014-03-19 01:41:43.000000000 +0000
+++ comm-patched/mozilla/browser/app/profile/firefox.js	2014-04-27 14:07:20.230352727 +0100
@@ -380,6 +380,7 @@
 pref("browser.search.order.1",                "chrome://browser-region/locale/region.properties");
 pref("browser.search.order.2",                "chrome://browser-region/locale/region.properties");
 pref("browser.search.order.3",                "chrome://browser-region/locale/region.properties");
+pref("browser.search.order.4",                "chrome://browser-region/locale/region.properties");
 
 // search bar results always open in a new tab
 pref("browser.search.openintab", false);
diff -ruN comm-release/mozilla/browser/branding/unofficial/locales/en-US/brand.dtd comm-patched/mozilla/browser/branding/unofficial/locales/en-US/brand.dtd
--- comm-release/mozilla/browser/branding/unofficial/locales/en-US/brand.dtd	2014-03-19 01:41:44.000000000 +0000
+++ comm-patched/mozilla/browser/branding/unofficial/locales/en-US/brand.dtd	2014-04-27 14:07:20.280189224 +0100
@@ -2,7 +2,7 @@
    - License, v. 2.0. If a copy of the MPL was not distributed with this
    - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
 
-<!ENTITY  brandShortName        "Mozilla Developer Preview">
-<!ENTITY  brandFullName         "Mozilla Developer Preview">
+<!ENTITY  brandShortName        "Browser">
+<!ENTITY  brandFullName         "Browser">
 <!ENTITY  vendorShortName       "mozilla.org">
 <!ENTITY  trademarkInfo.part1   " ">
diff -ruN comm-release/mozilla/browser/installer/package-manifest.in comm-patched/mozilla/browser/installer/package-manifest.in
--- comm-release/mozilla/browser/installer/package-manifest.in	2014-03-19 01:41:45.000000000 +0000
+++ comm-patched/mozilla/browser/installer/package-manifest.in	2014-04-27 14:07:20.230795241 +0100
@@ -732,7 +732,7 @@
 #endif
 
 ; for Solaris SPARC
-#ifdef SOLARIS
+#if defined(SOLARIS) && defined(SPARC)
 bin/libfreebl_32fpu_3.so
 bin/libfreebl_32int_3.so
 bin/libfreebl_32int64_3.so
diff -ruN comm-release/mozilla/browser/locales/en-US/chrome/browser-region/region.properties comm-patched/mozilla/browser/locales/en-US/chrome/browser-region/region.properties
--- comm-release/mozilla/browser/locales/en-US/chrome/browser-region/region.properties	2014-03-19 01:41:45.000000000 +0000
+++ comm-patched/mozilla/browser/locales/en-US/chrome/browser-region/region.properties	2014-04-27 14:07:20.231065138 +0100
@@ -9,6 +9,7 @@
 browser.search.order.1=Google
 browser.search.order.2=Yahoo
 browser.search.order.3=Bing
+browser.search.order.4=DuckDuckGo
 
 # This is the default set of web based feed handlers shown in the reader
 # selection UI
diff -ruN comm-release/mozilla/browser/locales/en-US/searchplugins/duckduckgo.xml comm-patched/mozilla/browser/locales/en-US/searchplugins/duckduckgo.xml
--- comm-release/mozilla/browser/locales/en-US/searchplugins/duckduckgo.xml	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/browser/locales/en-US/searchplugins/duckduckgo.xml	2014-04-27 14:07:20.231323898 +0100
@@ -0,0 +1,11 @@
+<SearchPlugin xmlns="http://www.mozilla.org/2006/browser/search/">
+<ShortName>DuckDuckGo</ShortName>
+<Description>We believe in better search and not tracking.</Description>
+<InputEncoding>UTF-8</InputEncoding>
+<Image height="16" width="16" type="image/x-icon">data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAANcNAADXDQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJyDsJmlk8pf6+v3s/v7+++zr/fcnIOyzJyDsgCcg7CYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAnIOwBJyDscCcg7PZttJ7/7Pfs//////++xO7/S5GA/ycg7P8nIOz2JyDscCcg7AEAAAAAAAAAAAAAAAAnIOwBJyDstScg7P8nIOz/Y8p5/2fHZf9Yv0z/YcF2/1rBUv8nIOz/JyDs/ycg7P8nIOy1JyDsAQAAAAAAAAAAJyDscCcg7P8nIOz/JyDs/4jQoP/p9+n//////05X3v9LkYD/JyDs/ycg7P8nIOz/JyDs/ycg7HAAAAAAJyDsJicg7PYnIOz/JyDs/zUu7f/+/v////////////89N+7/JyDs/yUo7f8nIOz/JyDs/ycg7P8nIOz2JyDsJicg7IAnIOz/JyDs/ycg7P9hXPH////////////t/P//GIr2/wfD+/8Gyfz/DKv5/yM57/8nIOz/JyDs/ycg7H8nIOyzJyDs/ycg7P8nIOz/jov1////////////Otz9/w3G/P8cWfH/JSvt/ycg7P8nIOz/JyDs/ycg7P8nIOyzJyDs5icg7P8nIOz/JyDs/7u5+f///////////27l/v8E0v3/BNL9/wTQ/f8Oofn/IT7v/ycg7P8nIOz/JyDs5icg7OYnIOz/JyDs/ycg7P/p6P3/uWsC////////////5fr//6Po/f8Thfb/DKv5/w6f+f8nIOz/JyDs/ycg7OYnIOyzJyDs/ycg7P8nIOz/9/b+/////////////////7lrAv/V1Pv/JyDs/ycg7P8nIOz/JyDs/ycg7P8nIOyzJyDsgCcg7P8nIOz/JyDs/8/N+///////////////////////iIX1/ycg7P8nIOz/JyDs/ycg7P8nIOz/JyDsfycg7CYnIOz2JyDs/ycg7P9FP+7/q6n4/+7u/f/n5v3/fXn0/yoj7P8nIOz/JyDs/ycg7P8nIOz/JyDs9icg7CYAAAAAJyDscCcg7P8nIOz/wsD6/+no/f/Y1/z/eHTz/ycg7P8nIOz/JyDs/ycg7P8nIOz/JyDs/ycg7HAAAAAAAAAAACcg7AEnIOy1JyDs/ycg7P8nIOz/JyDs/ycg7P8nIOz/JyDs/ycg7P8nIOz/JyDs/ycg7LUnIOwBAAAAAAAAAAAAAAAAJyDsAScg7HAnIOz2JyDs/ycg7P8nIOz/JyDs/ycg7P8nIOz/JyDs9icg7HAnIOwBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJyDsJicg7IAnIOyzJyDs5icg7OYnIOyzJyDsgCcg7CYAAAAAAAAAAAAAAAAAAAAA+B8AAPAPAADAAwAAwAMAAIABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAABAACAAQAAwAMAAMADAADwDwAA+B8AAA==</Image>
+<Url type="text/html" method="GET" template="https://duckduckgo.com/">
+<Param name="q" value="{searchTerms}"/>
+<Param name="t" value="freebsd"/>
+</Url>
+<SearchForm>https://duckduckgo.com/</SearchForm>
+</SearchPlugin>
diff -ruN comm-release/mozilla/browser/locales/en-US/searchplugins/list.txt comm-patched/mozilla/browser/locales/en-US/searchplugins/list.txt
--- comm-release/mozilla/browser/locales/en-US/searchplugins/list.txt	2014-03-19 01:41:45.000000000 +0000
+++ comm-patched/mozilla/browser/locales/en-US/searchplugins/list.txt	2014-04-27 14:07:20.231496089 +0100
@@ -1,5 +1,6 @@
 amazondotcom
 bing
+duckduckgo
 eBay
 google
 twitter
diff -ruN comm-release/mozilla/browser/themes/shared/devtools/common.css comm-patched/mozilla/browser/themes/shared/devtools/common.css
--- comm-release/mozilla/browser/themes/shared/devtools/common.css	2014-03-19 01:41:45.000000000 +0000
+++ comm-patched/mozilla/browser/themes/shared/devtools/common.css	2014-04-27 14:07:20.231837827 +0100
@@ -11,13 +11,13 @@
 .devtools-monospace {
 %ifdef XP_MACOSX
   font-family: Menlo, monospace;
-%endif
-%ifdef XP_LINUX
+%elifdef XP_WIN
+  font-family: Consolas, monospace;
+%else
   font-family: monospace;
-  font-size: 80%;
 %endif
-%ifdef XP_WIN
-  font-family: Consolas, monospace;
+%if defined(MOZ_WIDGET_GTK) || defined(MOZ_WIDGET_QT)
+  font-size: 80%;
 %endif
 }
 
@@ -62,7 +62,7 @@
   background-image: linear-gradient(to bottom, hsla(209,18%,18%,0.9), hsl(210,11%,16%));
   border-radius: 3px;
   overflow-x: hidden;
-%ifdef XP_LINUX
+%if defined(MOZ_WIDGET_GTK) || defined(MOZ_WIDGET_QT)
   max-height: 32rem;
 %else
   max-height: 40rem;
diff -ruN comm-release/mozilla/browser/themes/shared/devtools/highlighter.inc.css comm-patched/mozilla/browser/themes/shared/devtools/highlighter.inc.css
--- comm-release/mozilla/browser/themes/shared/devtools/highlighter.inc.css	2014-03-19 01:41:45.000000000 +0000
+++ comm-patched/mozilla/browser/themes/shared/devtools/highlighter.inc.css	2014-04-27 14:07:20.232077535 +0100
@@ -54,7 +54,7 @@
   padding: 0;
   width: 26px;
   min-height: 26px;
-%ifndef XP_LINUX
+%if !defined(MOZ_WIDGET_GTK) && !defined(MOZ_WIDGET_QT)
   background-color: transparent;
 %endif
 }
Binary files comm-release/mozilla/build/ConfigStatus.pyc and comm-patched/mozilla/build/ConfigStatus.pyc differ
diff -ruN comm-release/mozilla/build/autoconf/nss.m4 comm-patched/mozilla/build/autoconf/nss.m4
--- comm-release/mozilla/build/autoconf/nss.m4	2014-03-19 01:41:45.000000000 +0000
+++ comm-patched/mozilla/build/autoconf/nss.m4	2014-04-27 14:07:20.232380026 +0100
@@ -22,18 +22,18 @@
 	if test -n "$nss_config_exec_prefix"; then
 		nss_config_args="$nss_config_args --exec-prefix=$nss_config_exec_prefix"
 		if test -z "$NSS_CONFIG"; then
-			NSS_CONFIG=$nss_config_exec_prefix/bin/nss-config
+			NSS_CONFIG=$nss_config_exec_prefix/bin/pkg-config
 		fi
 	fi
 	if test -n "$nss_config_prefix"; then
 		nss_config_args="$nss_config_args --prefix=$nss_config_prefix"
 		if test -z "$NSS_CONFIG"; then
-			NSS_CONFIG=$nss_config_prefix/bin/nss-config
+			NSS_CONFIG=$nss_config_prefix/bin/pkg-config
 		fi
 	fi
 
 	unset ac_cv_path_NSS_CONFIG
-	AC_PATH_PROG(NSS_CONFIG, nss-config, no)
+	AC_PATH_PROG(NSS_CONFIG, pkg-config, no)
 	min_nss_version=ifelse([$1], ,3.0.0,$1)
 	AC_MSG_CHECKING(for NSS - version >= $min_nss_version)
 
@@ -41,14 +41,14 @@
 	if test "$NSS_CONFIG" = "no"; then
 		no_nss="yes"
 	else
-		NSS_CFLAGS=`$NSS_CONFIG $nss_config_args --cflags`
-		NSS_LIBS=`$NSS_CONFIG $nss_config_args --libs`
+		NSS_CFLAGS=`$NSS_CONFIG $nss_config_args nss --cflags`
+		NSS_LIBS=`$NSS_CONFIG $nss_config_args nss --libs`
 
-		nss_config_major_version=`$NSS_CONFIG $nss_config_args --version | \
+		nss_config_major_version=`$NSS_CONFIG $nss_config_args nss --modversion | \
 			sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\1/'`
-		nss_config_minor_version=`$NSS_CONFIG $nss_config_args --version | \
+		nss_config_minor_version=`$NSS_CONFIG $nss_config_args nss --modversion | \
 			sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\2/'`
-		nss_config_micro_version=`$NSS_CONFIG $nss_config_args --version | \
+		nss_config_micro_version=`$NSS_CONFIG $nss_config_args nss --modversion | \
 			sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\3/'`
 		min_nss_major_version=`echo $min_nss_version | \
 			sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\1/'`
diff -ruN comm-release/mozilla/build/pgo/profileserver.py comm-patched/mozilla/build/pgo/profileserver.py
--- comm-release/mozilla/build/pgo/profileserver.py	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/build/pgo/profileserver.py	2014-04-27 14:07:20.232618093 +0100
@@ -59,7 +59,7 @@
       env["MOZ_JAR_LOG_FILE"] = os.path.abspath(jarlog)
       print "jarlog: %s" % env["MOZ_JAR_LOG_FILE"]
 
-    cmdargs = ["http://localhost:%d/index.html" % PORT]
+    cmdargs = ["http://127.0.0.1:%d/index.html" % PORT]
     runner = FirefoxRunner(profile=profile,
                            binary=build.get_binary_path(where="staged-package"),
                            cmdargs=cmdargs,
diff -ruN comm-release/mozilla/config/Makefile.in comm-patched/mozilla/config/Makefile.in
--- comm-release/mozilla/config/Makefile.in	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/config/Makefile.in	2014-04-27 14:07:20.233343002 +0100
@@ -73,6 +73,11 @@
 		-DMOZ_NATIVE_LIBEVENT=$(MOZ_NATIVE_LIBEVENT) \
 		-DMOZ_NATIVE_LIBVPX=$(MOZ_NATIVE_LIBVPX) \
 		-DMOZ_NATIVE_ICU=$(MOZ_NATIVE_ICU) \
+		-DMOZ_NATIVE_GRAPHITE2=$(MOZ_NATIVE_GRAPHITE2) \
+		-DMOZ_NATIVE_HARFBUZZ=$(MOZ_NATIVE_HARFBUZZ) \
+		-DMOZ_NATIVE_OGG=$(MOZ_NATIVE_OGG) \
+		-DMOZ_NATIVE_VORBIS=$(MOZ_NATIVE_VORBIS) \
+		-DMOZ_NATIVE_OPUS=$(MOZ_NATIVE_OPUS) \
 		$(srcdir)/system-headers | $(PERL) $(topsrcdir)/nsprpub/config/make-system-wrappers.pl system_wrappers
 	$(INSTALL) system_wrappers $(DIST)
 
Binary files comm-release/mozilla/config/MozZipFile.pyc and comm-patched/mozilla/config/MozZipFile.pyc differ
diff -ruN comm-release/mozilla/config/baseconfig.mk comm-patched/mozilla/config/baseconfig.mk
--- comm-release/mozilla/config/baseconfig.mk	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/config/baseconfig.mk	2014-04-27 14:07:20.232878408 +0100
@@ -1,7 +1,7 @@
-includedir := $(includedir)/$(MOZ_APP_NAME)-$(MOZ_APP_VERSION)
-idldir = $(datadir)/idl/$(MOZ_APP_NAME)-$(MOZ_APP_VERSION)
-installdir = $(libdir)/$(MOZ_APP_NAME)-$(MOZ_APP_VERSION)
-sdkdir = $(libdir)/$(MOZ_APP_NAME)-devel-$(MOZ_APP_VERSION)
+includedir := $(includedir)/${MOZILLA_PKG_NAME}
+idldir = $(datadir)/idl/${MOZILLA_PKG_NAME}
+installdir = $(libdir)/${MOZILLA_PKG_NAME}
+sdkdir = $(libdir)/${MOZILLA_PKG_NAME}-sdk
 DIST = $(DEPTH)/dist
 
 # We do magic with OBJ_SUFFIX in config.mk, the following ensures we don't
Binary files comm-release/mozilla/config/createprecomplete.pyc and comm-patched/mozilla/config/createprecomplete.pyc differ
Binary files comm-release/mozilla/config/expandlibs.pyc and comm-patched/mozilla/config/expandlibs.pyc differ
Binary files comm-release/mozilla/config/expandlibs_config.pyc and comm-patched/mozilla/config/expandlibs_config.pyc differ
diff -ruN comm-release/mozilla/config/external/moz.build comm-patched/mozilla/config/external/moz.build
--- comm-release/mozilla/config/external/moz.build	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/config/external/moz.build	2014-04-27 14:07:20.233131190 +0100
@@ -15,13 +15,13 @@
     if not CONFIG['MOZ_NATIVE_BZ2']:
         external_dirs += ['modules/libbz2']
 
-if CONFIG['MOZ_VORBIS']:
+if CONFIG['MOZ_VORBIS'] and not CONFIG['MOZ_NATIVE_VORBIS']:
     external_dirs += ['media/libvorbis']
 
 if CONFIG['MOZ_TREMOR']:
     external_dirs += ['media/libtremor']
 
-if CONFIG['MOZ_OPUS']:
+if CONFIG['MOZ_OPUS'] and not CONFIG['MOZ_NATIVE_OPUS']:
     external_dirs += ['media/libopus']
 
 if CONFIG['MOZ_WEBM']:
@@ -31,7 +31,9 @@
     external_dirs += ['media/libvpx']
 
 if CONFIG['MOZ_OGG']:
-    external_dirs += ['media/libogg', 'media/libtheora']
+    if not CONFIG['MOZ_NATIVE_OGG']:
+        external_dirs += ['media/libogg']
+    external_dirs += ['media/libtheora']
 
 if not CONFIG['MOZ_NATIVE_PNG']:
     external_dirs += ['media/libpng']
diff -ruN comm-release/mozilla/config/stl_wrappers/ios comm-patched/mozilla/config/stl_wrappers/ios
--- comm-release/mozilla/config/stl_wrappers/ios	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/config/stl_wrappers/ios	2014-04-27 14:07:20.233570326 +0100
@@ -0,0 +1,3 @@
+#pragma GCC visibility push(default)
+#include_next <ios>
+#pragma GCC visibility pop
diff -ruN comm-release/mozilla/config/stl_wrappers/ostream comm-patched/mozilla/config/stl_wrappers/ostream
--- comm-release/mozilla/config/stl_wrappers/ostream	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/config/stl_wrappers/ostream	2014-04-27 14:07:20.233718810 +0100
@@ -0,0 +1,3 @@
+#pragma GCC visibility push(default)
+#include_next <ostream>
+#pragma GCC visibility pop
diff -ruN comm-release/mozilla/config/system-headers comm-patched/mozilla/config/system-headers
--- comm-release/mozilla/config/system-headers	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/config/system-headers	2014-04-27 14:07:20.234223560 +0100
@@ -1144,4 +1144,28 @@
 unicode/ustring.h
 unicode/utypes.h
 #endif
+cairo-qt.h
+#if MOZ_NATIVE_GRAPHITE2==1
+unwind.h
+graphite2/Font.h
+graphite2/Segment.h
+#endif
+#if MOZ_NATIVE_HARFBUZZ==1
+harfbuzz/hb-ot.h
+harfbuzz/hb.h
+#endif
+#if MOZ_NATIVE_OGG==1
+ogg/ogg.h
+ogg/os_types.h
+#endif
+#if MOZ_NATIVE_VORBIS==1
+vorbis/codec.h
+vorbis/vorbisenc.h
+#endif
+#if MOZ_NATIVE_OPUS==1
+opus.h
+opus_multistream.h
+opus/opus.h
+opus/opus_multistream.h
+#endif
 libutil.h
diff -ruN comm-release/mozilla/config/system_wrappers/unwind.h comm-patched/mozilla/config/system_wrappers/unwind.h
--- comm-release/mozilla/config/system_wrappers/unwind.h	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/config/system_wrappers/unwind.h	2014-04-27 14:07:20.233916004 +0100
@@ -0,0 +1,4 @@
+#pragma GCC system_header
+#pragma GCC visibility push(default)
+#include_next <unwind.h>
+#pragma GCC visibility pop
diff -ruN comm-release/mozilla/configure.in comm-patched/mozilla/configure.in
--- comm-release/mozilla/configure.in	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/configure.in	2014-04-27 14:07:20.202856453 +0100
@@ -2544,118 +2544,15 @@
 
 AC_LANG_C
 
-dnl Check for .hidden assembler directive and visibility attribute.
-dnl Borrowed from glibc configure.in
+dnl Setup default hidden visibility and wrapped system headers.
 dnl ===============================================================
 if test "$GNU_CC"; then
-  AC_CACHE_CHECK(for visibility(hidden) attribute,
-                 ac_cv_visibility_hidden,
-                 [cat > conftest.c <<EOF
-                  int foo __attribute__ ((visibility ("hidden"))) = 1;
-EOF
-                  ac_cv_visibility_hidden=no
-                  if ${CC-cc} -Werror -S conftest.c -o conftest.s >/dev/null 2>&1; then
-                    if egrep '\.(hidden|private_extern).*foo' conftest.s >/dev/null; then
-                      ac_cv_visibility_hidden=yes
-                    fi
-                  fi
-                  rm -f conftest.[cs]
-                 ])
-  if test "$ac_cv_visibility_hidden" = "yes"; then
-    AC_DEFINE(HAVE_VISIBILITY_HIDDEN_ATTRIBUTE)
-
-    AC_CACHE_CHECK(for visibility(default) attribute,
-                   ac_cv_visibility_default,
-                   [cat > conftest.c <<EOF
-                    int foo __attribute__ ((visibility ("default"))) = 1;
-EOF
-                    ac_cv_visibility_default=no
-                    if ${CC-cc} -fvisibility=hidden -Werror -S conftest.c -o conftest.s >/dev/null 2>&1; then
-                      if ! egrep '\.(hidden|private_extern).*foo' conftest.s >/dev/null; then
-                        ac_cv_visibility_default=yes
-                      fi
-                    fi
-                    rm -f conftest.[cs]
-                   ])
-    if test "$ac_cv_visibility_default" = "yes"; then
-      AC_DEFINE(HAVE_VISIBILITY_ATTRIBUTE)
-
-      AC_CACHE_CHECK(for visibility pragma support,
-                     ac_cv_visibility_pragma,
-                     [cat > conftest.c <<EOF
-#pragma GCC visibility push(hidden)
-                      int foo_hidden = 1;
-#pragma GCC visibility push(default)
-                      int foo_default = 1;
-EOF
-                      ac_cv_visibility_pragma=no
-                      if ${CC-cc} -Werror -S conftest.c -o conftest.s >/dev/null 2>&1; then
-                        if egrep '\.(hidden|private_extern).*foo_hidden' conftest.s >/dev/null; then
-                          if ! egrep '\.(hidden|private_extern).*foo_default' conftest.s > /dev/null; then
-                            ac_cv_visibility_pragma=yes
-                          fi
-                        fi
-                      fi
-                      rm -f conftest.[cs]
-                    ])
-      if test "$ac_cv_visibility_pragma" = "yes"; then
-        AC_CACHE_CHECK(For gcc visibility bug with class-level attributes (GCC bug 26905),
-                       ac_cv_have_visibility_class_bug,
-                       [cat > conftest.c <<EOF
-#pragma GCC visibility push(hidden)
-struct __attribute__ ((visibility ("default"))) TestStruct {
-  static void Init();
-};
-__attribute__ ((visibility ("default"))) void TestFunc() {
-  TestStruct::Init();
-}
-EOF
-                       ac_cv_have_visibility_class_bug=no
-                       if ! ${CXX-g++} ${CXXFLAGS} ${DSO_PIC_CFLAGS} ${DSO_LDOPTS} -S -o conftest.S conftest.c > /dev/null 2>&1 ; then
-                         ac_cv_have_visibility_class_bug=yes
-                       else
-                         if test `egrep -c '@PLT|\\$stub' conftest.S` = 0; then
-                           ac_cv_have_visibility_class_bug=yes
-                         fi
-                       fi
-                       rm -rf conftest.{c,S}
-                       ])
-
-        AC_CACHE_CHECK(For x86_64 gcc visibility bug with builtins (GCC bug 20297),
-                       ac_cv_have_visibility_builtin_bug,
-                       [cat > conftest.c <<EOF
-#pragma GCC visibility push(hidden)
-#pragma GCC visibility push(default)
-#include <string.h>
-#pragma GCC visibility pop
-
-__attribute__ ((visibility ("default"))) void Func() {
-  char c[[100]];
-  memset(c, 0, sizeof(c));
-}
-EOF
-                       ac_cv_have_visibility_builtin_bug=no
-                       if ! ${CC-cc} ${CFLAGS} ${DSO_PIC_CFLAGS} ${DSO_LDOPTS} -O2 -S -o conftest.S conftest.c > /dev/null 2>&1 ; then
-                         ac_cv_have_visibility_builtin_bug=yes
-                       else
-                         if test `grep -c "@PLT" conftest.S` = 0; then
-                           ac_cv_visibility_builtin_bug=yes
-                         fi
-                       fi
-                       rm -f conftest.{c,S}
-                       ])
-        if test "$ac_cv_have_visibility_builtin_bug" = "no" -a \
-                "$ac_cv_have_visibility_class_bug" = "no"; then
-          VISIBILITY_FLAGS='-I$(DIST)/system_wrappers -include $(topsrcdir)/config/gcc_hidden.h'
-          WRAP_SYSTEM_INCLUDES=1
-          STL_FLAGS='-I$(DIST)/stl_wrappers'
-          WRAP_STL_INCLUDES=1
-        else
-          VISIBILITY_FLAGS='-fvisibility=hidden'
-        fi # have visibility pragma bug
-      fi   # have visibility pragma
-    fi     # have visibility(default) attribute
-  fi       # have visibility(hidden) attribute
+  AC_DEFINE(HAVE_VISIBILITY_HIDDEN_ATTRIBUTE)
+  AC_DEFINE(HAVE_VISIBILITY_ATTRIBUTE)
+  VISIBILITY_FLAGS='-I$(DIST)/system_wrappers -include $(topsrcdir)/config/gcc_hidden.h'
+  WRAP_SYSTEM_INCLUDES=1
+  STL_FLAGS='-I$(DIST)/stl_wrappers'
+  WRAP_STL_INCLUDES=1
 fi         # GNU_CC
 
 # visibility hidden flag for Sun Studio on Solaris
@@ -3724,6 +3621,14 @@
   _YASM_BUILD=`        echo ${YASM_VERSION} | $AWK -F\. '{ print $4 }'`
 fi
 
+if test -n "${LIBXUL_SDK_DIR}"; then
+    AC_MSG_WARN([pkgsrc: LIBXUL_SDK_DIR is set; assuming we want nss and nspr from xulrunner.])
+    NSPR_CFLAGS="-I${prefix}/include/xulrunner/unstable `pkg-config --cflags nspr`"
+    NSPR_LIBS="`pkg-config --libs nspr`"
+    NSS_CFLAGS="`pkg-config --cflags nss`"
+    NSS_LIBS="`pkg-config --libs nss`"
+fi
+
 if test -z "$SKIP_LIBRARY_CHECKS"; then
 dnl system JPEG support
 dnl ========================================================
@@ -3751,11 +3656,7 @@
                      #include <jpeglib.h> ],
                    [ #if JPEG_LIB_VERSION < $MOZJPEG
                      #error "Insufficient JPEG library version ($MOZJPEG required)."
-                     #endif
-                     #ifndef JCS_EXTENSIONS
-                     #error "libjpeg-turbo JCS_EXTENSIONS required"
-                     #endif
-                     ],
+                     #endif ],
                    MOZ_NATIVE_JPEG=1,
                    AC_MSG_ERROR([Insufficient JPEG library version for --with-system-jpeg]))
 fi
@@ -3921,6 +3822,22 @@
 AC_SUBST(MOZ_NATIVE_ICU)
 
 dnl ========================================================
+dnl system icu support
+dnl ========================================================
+MOZ_NATIVE_ICU=
+MOZ_ARG_WITH_BOOL(system-icu,
+[  --with-system-icu
+                          Use system icu (located with pkgconfig)],
+    MOZ_NATIVE_ICU=1)
+
+if test -n "$MOZ_NATIVE_ICU"; then
+    PKG_CHECK_MODULES(MOZ_ICU, icu-i18n >= 50.1)
+    MOZ_JS_STATIC_LIBS="$MOZ_JS_STATIC_LIBS $MOZ_ICU_LIBS"
+fi
+
+AC_SUBST(MOZ_NATIVE_ICU)
+
+dnl ========================================================
 dnl Java SDK support
 dnl ========================================================
 
@@ -3955,6 +3872,7 @@
 MOZ_SAMPLE_TYPE_S16=
 MOZ_OPUS=1
 MOZ_WEBM=1
+MOZ_GSTREAMER=
 MOZ_DIRECTSHOW=
 MOZ_WMF=
 MOZ_FMP4=
@@ -5136,6 +5054,9 @@
     MOZ_VP8=1
     MOZ_VP8_ERROR_CONCEALMENT=1
 
+    dnl with libv4l2 we can support more cameras
+    PKG_CHECK_MODULES(MOZ_LIBV4L2, libv4l2)
+
 dnl enable once Signaling lands
     MOZ_WEBRTC_SIGNALING=1
     AC_DEFINE(MOZ_WEBRTC_SIGNALING)
@@ -5158,15 +5079,18 @@
 
 dnl Use integers over floats for audio on B2G and Android, because audio
 dnl backends for those platforms don't support floats.
-if test "$OS_TARGET" = "Android"; then
+case "$OS_TARGET" in
+ndroid|DragonFly|FreeBSD|NetBSD|OpenBSD)
     MOZ_SAMPLE_TYPE_S16=1
     AC_DEFINE(MOZ_SAMPLE_TYPE_S16)
     AC_SUBST(MOZ_SAMPLE_TYPE_S16)
-else
+    ;;
+*)
     MOZ_SAMPLE_TYPE_FLOAT32=1
     AC_DEFINE(MOZ_SAMPLE_TYPE_FLOAT32)
     AC_SUBST(MOZ_SAMPLE_TYPE_FLOAT32)
-fi
+    ;;
+esac
 
 dnl ========================================================
 dnl = Disable Speech API code
@@ -5230,6 +5154,40 @@
 fi
 
 dnl ========================================================
+dnl Check for libogg
+dnl ========================================================
+
+MOZ_ARG_WITH_BOOL(system-ogg,
+[  --with-system-ogg       Use system libogg (located with pkgconfig)],
+MOZ_NATIVE_OGG=1,
+MOZ_NATIVE_OGG= )
+
+if test -n "$MOZ_NATIVE_OGG"; then
+    PKG_CHECK_MODULES(MOZ_OGG, ogg >= 1.2.1)
+fi
+
+AC_SUBST(MOZ_NATIVE_OGG)
+AC_SUBST(MOZ_OGG_CFLAGS)
+AC_SUBST(MOZ_OGG_LIBS)
+
+dnl ========================================================
+dnl Check for libvorbis
+dnl ========================================================
+
+MOZ_ARG_WITH_BOOL(system-vorbis,
+[  --with-system-vorbis    Use system libvorbis (located with pkgconfig)],
+MOZ_NATIVE_VORBIS=1,
+MOZ_NATIVE_VORBIS= )
+
+if test -n "$MOZ_NATIVE_VORBIS"; then
+    PKG_CHECK_MODULES(MOZ_VORBIS, vorbis vorbisenc >= 1.3.4)
+fi
+
+AC_SUBST(MOZ_NATIVE_VORBIS)
+AC_SUBST(MOZ_VORBIS_CFLAGS)
+AC_SUBST(MOZ_VORBIS_LIBS)
+
+dnl ========================================================
 dnl = Disable Opus audio codec support
 dnl ========================================================
 MOZ_ARG_DISABLE_BOOL(opus,
@@ -5238,6 +5196,25 @@
     MOZ_OPUS=1)
 
 dnl ========================================================
+dnl Check for libopus
+dnl ========================================================
+
+MOZ_ARG_WITH_BOOL(system-opus,
+[  --with-system-opus      Use system libopus (located with pkgconfig)],
+MOZ_NATIVE_OPUS=1,
+MOZ_NATIVE_OPUS= )
+
+if test -n "$MOZ_NATIVE_OPUS"; then
+    PKG_CHECK_MODULES(MOZ_OPUS, opus >= 1.1)
+else
+    MOZ_OPUS_CFLAGS='-I$(topsrcdir)/media/libopus/include'
+fi
+
+AC_SUBST(MOZ_NATIVE_OPUS)
+AC_SUBST(MOZ_OPUS_CFLAGS)
+AC_SUBST(MOZ_OPUS_LIBS)
+
+dnl ========================================================
 dnl = Disable VP8 decoder support
 dnl ========================================================
 MOZ_ARG_DISABLE_BOOL(webm,
@@ -5606,43 +5583,60 @@
 dnl ========================================================
 if test "$OS_TARGET" = "Linux"; then
   MOZ_GSTREAMER=1
+  GST_API_VERSION=0.10
 fi
 
-MOZ_ARG_ENABLE_BOOL(gstreamer,
-[  --enable-gstreamer           Enable GStreamer support],
-MOZ_GSTREAMER=1,
-MOZ_GSTREAMER=)
-
-if test "$MOZ_GSTREAMER"; then
-    # API version, eg 0.10, 1.0 etc
+MOZ_ARG_ENABLE_STRING(gstreamer,
+[  --enable-gstreamer[=0.10]           Enable GStreamer support],
+[ MOZ_GSTREAMER=1
+  # API version, eg 0.10, 1.0 etc
+  if test -z "$enableval" -o "$enableval" = "yes"; then
     GST_API_VERSION=0.10
+  elif test "$enableval" = "no"; then
+    MOZ_GSTREAMER=
+  else
+    GST_API_VERSION=$enableval
+  fi],
+)
+
+if test -n "$MOZ_GSTREAMER"; then
     # core/base release number
-    GST_VERSION=0.10.25
+    if test "$GST_API_VERSION" = "1.0"; then
+      GST_VERSION=1.0
+    else
+      GST_VERSION=0.10.25
+    fi
+
     PKG_CHECK_MODULES(GSTREAMER,
                       gstreamer-$GST_API_VERSION >= $GST_VERSION
                       gstreamer-app-$GST_API_VERSION
-                      gstreamer-plugins-base-$GST_API_VERSION, ,
-                      AC_MSG_ERROR([gstreamer and gstreamer-plugins-base development packages are needed to build gstreamer backend. Install them or disable gstreamer support with --disable-gstreamer]))
-    if test -n "$GSTREAMER_LIBS"; then
-       _SAVE_LDFLAGS=$LDFLAGS
-       LDFLAGS="$LDFLAGS $GSTREAMER_LIBS -lgstvideo-$GST_API_VERSION"
-       AC_TRY_LINK(,[return 0;],_HAVE_LIBGSTVIDEO=1,_HAVE_LIBGSTVIDEO=)
-       if test -n "$_HAVE_LIBGSTVIDEO" ; then
-          GSTREAMER_LIBS="$GSTREAMER_LIBS -lgstvideo-$GST_API_VERSION"
-       else
-          AC_MSG_ERROR([gstreamer-plugins-base found, but no libgstvideo. Something has gone terribly wrong. Try reinstalling gstreamer-plugins-base; failing that, disable the gstreamer backend with --disable-gstreamer.])
-       fi
-       LDFLAGS=$_SAVE_LDFLAGS
+                      gstreamer-plugins-base-$GST_API_VERSION,
+                      [_HAVE_GSTREAMER=1],
+                      [_HAVE_GSTREAMER=])
+    if test -z "$_HAVE_GSTREAMER"; then
+        AC_MSG_ERROR([gstreamer and gstreamer-plugins-base development packages are needed to build gstreamer backend. Install them or disable gstreamer support with --disable-gstreamer])
+    fi
+
+    _SAVE_LDFLAGS=$LDFLAGS
+    LDFLAGS="$LDFLAGS $GSTREAMER_LIBS -lgstvideo-$GST_API_VERSION"
+    AC_TRY_LINK(,[return 0;],_HAVE_LIBGSTVIDEO=1,_HAVE_LIBGSTVIDEO=)
+    if test -n "$_HAVE_LIBGSTVIDEO" ; then
+        GSTREAMER_LIBS="$GSTREAMER_LIBS -lgstvideo-$GST_API_VERSION"
     else
-       AC_MSG_ERROR([gstreamer and gstreamer-plugins-base development packages are needed to build gstreamer backend. Install them or disable gstreamer support with --disable-gstreamer])
+        AC_MSG_ERROR([gstreamer-plugins-base found, but no libgstvideo. Something has gone terribly wrong. Try reinstalling gstreamer-plugins-base; failing that, disable the gstreamer backend with --disable-gstreamer.])
     fi
+    LDFLAGS=$_SAVE_LDFLAGS
+
+    AC_SUBST(GSTREAMER_CFLAGS)
+    AC_SUBST(GSTREAMER_LIBS)
 fi
-AC_SUBST(GSTREAMER_CFLAGS)
-AC_SUBST(GSTREAMER_LIBS)
+
 AC_SUBST(MOZ_GSTREAMER)
+AC_SUBST(GST_API_VERSION)
 
 if test -n "$MOZ_GSTREAMER"; then
-   AC_DEFINE(MOZ_GSTREAMER)
+     AC_DEFINE(MOZ_GSTREAMER)
+     AC_DEFINE_UNQUOTED(GST_API_VERSION, "$GST_API_VERSION")
 fi
 
 
@@ -7424,7 +7418,10 @@
 dnl = Support for gcc stack unwinding (from gcc 3.3)
 dnl ========================================================
 if test -z "$SKIP_LIBRARY_CHECKS"; then
+    AC_LANG_SAVE
+    AC_LANG_CPLUSPLUS
     MOZ_CHECK_HEADER(unwind.h, AC_CHECK_FUNCS(_Unwind_Backtrace))
+    AC_LANG_RESTORE
 fi
 
 dnl ========================================================
@@ -7870,6 +7867,34 @@
 fi
 
 dnl ========================================================
+dnl Check for graphite2 and harfbuzz
+dnl ========================================================
+
+MOZ_ARG_WITH_BOOL(system-harfbuzz,
+[  --with-system-harfbuzz  Use system harfbuzz (located with pkgconfig)],
+MOZ_NATIVE_HARFBUZZ=1,
+MOZ_NATIVE_HARFBUZZ= )
+
+if test -n "$MOZ_NATIVE_HARFBUZZ"; then
+    PKG_CHECK_MODULES(MOZ_HARFBUZZ, harfbuzz >= 0.9.25)
+fi
+AC_SUBST(MOZ_NATIVE_HARFBUZZ)
+AC_SUBST(MOZ_HARFBUZZ_CFLAGS)
+AC_SUBST(MOZ_HARFBUZZ_LIBS)
+
+MOZ_ARG_WITH_BOOL(system-graphite2,
+[  --with-system-graphite2 Use system graphite2 (located with pkgconfig)],
+MOZ_NATIVE_GRAPHITE2=1,
+MOZ_NATIVE_GRAPHITE2= )
+
+if test -n "$MOZ_NATIVE_GRAPHITE2"; then
+    PKG_CHECK_MODULES(MOZ_GRAPHITE2, graphite2 >= 1.2.4)
+fi
+AC_SUBST(MOZ_NATIVE_GRAPHITE2)
+AC_SUBST(MOZ_GRAPHITE2_CFLAGS)
+AC_SUBST(MOZ_GRAPHITE2_LIBS)
+
+dnl ========================================================
 dnl Check for pixman and cairo
 dnl ========================================================
 
@@ -8118,7 +8143,7 @@
       NECKO_WIFI=1
     fi
     ;;
-  Darwin|SunOS|WINNT)
+  Darwin|FreeBSD|SunOS|WINNT)
     NECKO_WIFI=1
     ;;
   Linux)
@@ -8665,6 +8690,20 @@
 AC_SUBST(MOZ_SZIP_FLAGS)
 
 if test -n "$COMPILE_ENVIRONMENT"; then
+AC_MSG_CHECKING([for posix_fadvise])
+AC_TRY_LINK([#define _XOPEN_SOURCE 600
+  #include <fcntl.h>],
+                 [posix_fadvise(0, 0, 0, 0);],
+                 [ac_cv___posix_fadvise=true],
+                 [ac_cv___posix_fadvise=false])
+
+if test "$ac_cv___posix_fadvise" = true ; then
+  AC_DEFINE(HAVE_POSIX_FADVISE)
+  AC_MSG_RESULT(yes)
+else
+  AC_MSG_RESULT(no)
+fi
+
 AC_MSG_CHECKING([for posix_fallocate])
 AC_TRY_LINK([#define _XOPEN_SOURCE 600
   #include <fcntl.h>],
@@ -8918,6 +8957,10 @@
   fi
 fi
 
+if test -n "$MOZ_LIBV4L2_LIBS"; then
+   EXTRA_GYP_DEFINES="$EXTRA_GYP_DEFINES -D use_libv4l2=1"
+fi
+
 if test -n "$MOZ_WEBRTC"; then
    AC_MSG_RESULT("generating WebRTC Makefiles...")
 
diff -ruN comm-release/mozilla/content/base/src/Makefile.in comm-patched/mozilla/content/base/src/Makefile.in
--- comm-release/mozilla/content/base/src/Makefile.in	2014-03-19 01:41:46.000000000 +0000
+++ comm-patched/mozilla/content/base/src/Makefile.in	2014-04-27 14:07:20.234485916 +0100
@@ -5,6 +5,10 @@
 
 include $(topsrcdir)/config/rules.mk
 
+ifdef MOZ_NATIVE_HARFBUZZ
+nsContentUtils.$(OBJ_SUFFIX): CXXFLAGS+=$(MOZ_HARFBUZZ_CFLAGS)
+endif
+
 # gcc requires -msse2 for this file since it uses SSE2 intrinsics.  (See bug
 # 585538 comment 12.)
 ifneq (,$(INTEL_ARCHITECTURE))
diff -ruN comm-release/mozilla/content/media/Makefile.in comm-patched/mozilla/content/media/Makefile.in
--- comm-release/mozilla/content/media/Makefile.in	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/Makefile.in	2014-04-27 14:07:20.238415018 +0100
@@ -7,4 +7,16 @@
 CFLAGS   += $(GSTREAMER_CFLAGS)
 CXXFLAGS += $(GSTREAMER_CFLAGS)
 
+ifdef MOZ_NATIVE_OGG
+CXXFLAGS += $(MOZ_OGG_CFLAGS)
+endif
+
+ifdef MOZ_NATIVE_VORBIS
+CXXFLAGS += $(MOZ_VORBIS_CFLAGS)
+endif
+
+ifdef MOZ_NATIVE_OPUS
+CXXFLAGS += $(MOZ_OPUS_CFLAGS)
+endif
+
 AudioNodeEngineNEON.$(OBJ_SUFFIX): CXXFLAGS += -mfpu=neon
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerAllocator.cpp comm-patched/mozilla/content/media/gstreamer/GStreamerAllocator.cpp
--- comm-release/mozilla/content/media/gstreamer/GStreamerAllocator.cpp	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerAllocator.cpp	2014-04-27 14:07:20.234800075 +0100
@@ -0,0 +1,198 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include "GStreamerAllocator.h"
+
+#include <gst/video/video.h>
+#include <gst/video/gstvideometa.h>
+
+#include "GStreamerLoader.h"
+
+using namespace mozilla::layers;
+
+namespace mozilla {
+
+typedef struct
+{
+  GstAllocator parent;
+  GStreamerReader *reader;
+} MozGfxMemoryAllocator;
+
+typedef struct
+{
+  GstAllocatorClass parent;
+} MozGfxMemoryAllocatorClass;
+
+typedef struct
+{
+  GstMemory memory;
+  PlanarYCbCrImage* image;
+  guint8* data;
+} MozGfxMemory;
+
+typedef struct
+{
+  GstMeta meta;
+} MozGfxMeta;
+
+typedef struct
+{
+  GstVideoBufferPoolClass parent_class;
+} MozGfxBufferPoolClass;
+
+typedef struct
+{
+  GstVideoBufferPool pool;
+} MozGfxBufferPool;
+
+G_DEFINE_TYPE(MozGfxMemoryAllocator, moz_gfx_memory_allocator, GST_TYPE_ALLOCATOR);
+G_DEFINE_TYPE(MozGfxBufferPool, moz_gfx_buffer_pool, GST_TYPE_VIDEO_BUFFER_POOL);
+
+void
+moz_gfx_memory_reset(MozGfxMemory *mem)
+{
+  if (mem->image)
+    mem->image->Release();
+
+  ImageContainer* container = ((MozGfxMemoryAllocator*) mem->memory.allocator)->reader->GetImageContainer();
+  ImageFormat format = PLANAR_YCBCR;
+  mem->image = reinterpret_cast<PlanarYCbCrImage*>(container->CreateImage(&format, 1).get());
+  mem->data = mem->image->AllocateAndGetNewBuffer(mem->memory.size);
+}
+
+static GstMemory*
+moz_gfx_memory_allocator_alloc(GstAllocator* aAllocator, gsize aSize,
+    GstAllocationParams* aParams)
+{
+  MozGfxMemory* mem = g_slice_new (MozGfxMemory);
+  gsize maxsize = aSize + aParams->prefix + aParams->padding;
+  gst_memory_init(GST_MEMORY_CAST (mem),
+                  (GstMemoryFlags)aParams->flags,
+                  aAllocator, NULL, maxsize, aParams->align,
+                  aParams->prefix, aSize);
+  mem->image = NULL;
+  moz_gfx_memory_reset(mem);
+
+  return (GstMemory *) mem;
+}
+
+static void
+moz_gfx_memory_allocator_free (GstAllocator * allocator, GstMemory * gmem)
+{
+  MozGfxMemory *mem = (MozGfxMemory *) gmem;
+
+  if (mem->memory.parent)
+    goto sub_mem;
+
+  if (mem->image)
+    mem->image->Release();
+
+sub_mem:
+  g_slice_free (MozGfxMemory, mem);
+}
+
+static gpointer
+moz_gfx_memory_map (MozGfxMemory * mem, gsize maxsize, GstMapFlags flags)
+{
+  // check that the allocation didn't fail
+  if (mem->data == nullptr)
+    return nullptr;
+
+  return mem->data + mem->memory.offset;
+}
+
+static gboolean
+moz_gfx_memory_unmap (MozGfxMemory * mem)
+{
+  return TRUE;
+}
+
+static MozGfxMemory *
+moz_gfx_memory_share (MozGfxMemory * mem, gssize offset, gsize size)
+{
+  MozGfxMemory *sub;
+  GstMemory *parent;
+
+  /* find the real parent */
+  if ((parent = mem->memory.parent) == NULL)
+    parent = (GstMemory *) mem;
+
+  if (size == (gsize) -1)
+    size = mem->memory.size - offset;
+
+  /* the shared memory is always readonly */
+  sub = g_slice_new (MozGfxMemory);
+
+  gst_memory_init (GST_MEMORY_CAST (sub),
+      (GstMemoryFlags) (GST_MINI_OBJECT_FLAGS (parent) | GST_MINI_OBJECT_FLAG_LOCK_READONLY),
+      mem->memory.allocator, &mem->memory, mem->memory.maxsize, mem->memory.align,
+      mem->memory.offset + offset, size);
+
+  sub->image = mem->image;
+  sub->data = mem->data;
+
+  return sub;
+}
+
+static void
+moz_gfx_memory_allocator_class_init (MozGfxMemoryAllocatorClass * klass)
+{
+  GstAllocatorClass *allocator_class;
+
+  allocator_class = (GstAllocatorClass *) klass;
+
+  allocator_class->alloc = moz_gfx_memory_allocator_alloc;
+  allocator_class->free = moz_gfx_memory_allocator_free;
+}
+
+static void
+moz_gfx_memory_allocator_init (MozGfxMemoryAllocator * allocator)
+{
+  GstAllocator *alloc = GST_ALLOCATOR_CAST (allocator);
+
+  alloc->mem_type = "moz-gfx-image";
+  alloc->mem_map = (GstMemoryMapFunction) moz_gfx_memory_map;
+  alloc->mem_unmap = (GstMemoryUnmapFunction) moz_gfx_memory_unmap;
+  alloc->mem_share = (GstMemoryShareFunction) moz_gfx_memory_share;
+  /* fallback copy and is_span */
+}
+
+void
+moz_gfx_memory_allocator_set_reader(GstAllocator* aAllocator, GStreamerReader* aReader)
+{
+  MozGfxMemoryAllocator *allocator = (MozGfxMemoryAllocator *) aAllocator;
+  allocator->reader = aReader;
+}
+
+nsRefPtr<PlanarYCbCrImage>
+moz_gfx_memory_get_image(GstMemory *aMemory)
+{
+  NS_ASSERTION(GST_IS_MOZ_GFX_MEMORY_ALLOCATOR(aMemory->allocator), "Should be a gfx image");
+
+  return ((MozGfxMemory *) aMemory)->image;
+}
+
+void
+moz_gfx_buffer_pool_reset_buffer (GstBufferPool* aPool, GstBuffer* aBuffer)
+{
+  GstMemory* mem = gst_buffer_peek_memory(aBuffer, 0);
+
+  NS_ASSERTION(GST_IS_MOZ_GFX_MEMORY_ALLOCATOR(mem->allocator), "Should be a gfx image");
+  moz_gfx_memory_reset((MozGfxMemory *) mem);
+  GST_BUFFER_POOL_CLASS(moz_gfx_buffer_pool_parent_class)->reset_buffer(aPool, aBuffer);
+}
+
+static void
+moz_gfx_buffer_pool_class_init (MozGfxBufferPoolClass * klass)
+{
+  GstBufferPoolClass *pool_class = (GstBufferPoolClass *) klass;
+  pool_class->reset_buffer = moz_gfx_buffer_pool_reset_buffer;
+}
+
+static void
+moz_gfx_buffer_pool_init (MozGfxBufferPool * pool)
+{
+}
+
+} // namespace mozilla
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerAllocator.h comm-patched/mozilla/content/media/gstreamer/GStreamerAllocator.h
--- comm-release/mozilla/content/media/gstreamer/GStreamerAllocator.h	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerAllocator.h	2014-04-27 14:07:20.234967049 +0100
@@ -0,0 +1,25 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#if !defined(GStreamerAllocator_h_)
+#define GStreamerAllocator_h_
+
+#include "GStreamerReader.h"
+
+#define GST_TYPE_MOZ_GFX_MEMORY_ALLOCATOR   (moz_gfx_memory_allocator_get_type())
+#define GST_IS_MOZ_GFX_MEMORY_ALLOCATOR(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GST_TYPE_MOZ_GFX_MEMORY_ALLOCATOR))
+#define GST_TYPE_MOZ_GFX_BUFFER_POOL   (moz_gfx_buffer_pool_get_type())
+#define GST_IS_MOZ_GFX_BUFFER_POOL(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GST_TYPE_MOZ_GFX_BUFFER_POOL))
+
+namespace mozilla {
+
+GType moz_gfx_memory_allocator_get_type();
+void moz_gfx_memory_allocator_set_reader(GstAllocator *aAllocator, GStreamerReader* aReader);
+nsRefPtr<layers::PlanarYCbCrImage> moz_gfx_memory_get_image(GstMemory *aMemory);
+
+GType moz_gfx_buffer_pool_get_type();
+
+} // namespace mozilla
+
+#endif
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerFormatHelper.cpp comm-patched/mozilla/content/media/gstreamer/GStreamerFormatHelper.cpp
--- comm-release/mozilla/content/media/gstreamer/GStreamerFormatHelper.cpp	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerFormatHelper.cpp	2014-04-27 14:07:20.235205534 +0100
@@ -294,12 +294,23 @@
 GList* GStreamerFormatHelper::GetFactories() {
   NS_ASSERTION(sLoadOK, "GStreamer library not linked");
 
-  uint32_t cookie = gst_default_registry_get_feature_list_cookie ();
+#if GST_VERSION_MAJOR >= 1
+  uint32_t cookie = gst_registry_get_feature_list_cookie(gst_registry_get());
+#else
+  uint32_t cookie = gst_default_registry_get_feature_list_cookie();
+#endif
   if (cookie != mCookie) {
     g_list_free(mFactories);
+#if GST_VERSION_MAJOR >= 1
+    mFactories =
+      gst_registry_feature_filter(gst_registry_get(),
+                                  (GstPluginFeatureFilter)FactoryFilter,
+                                  false, nullptr);
+#else
     mFactories =
       gst_default_registry_feature_filter((GstPluginFeatureFilter)FactoryFilter,
                                           false, nullptr);
+#endif
     mCookie = cookie;
   }
 
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerFunctionList.h comm-patched/mozilla/content/media/gstreamer/GStreamerFunctionList.h
--- comm-release/mozilla/content/media/gstreamer/GStreamerFunctionList.h	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerFunctionList.h	2014-04-27 14:07:20.235581816 +0100
@@ -9,7 +9,6 @@
  * List of symbol names we need to dlsym from the gstreamer library.
  */
 GST_FUNC(LIBGSTAPP, gst_app_sink_get_type)
-GST_FUNC(LIBGSTAPP, gst_app_sink_pull_buffer)
 GST_FUNC(LIBGSTAPP, gst_app_sink_set_callbacks)
 GST_FUNC(LIBGSTAPP, gst_app_src_end_of_stream)
 GST_FUNC(LIBGSTAPP, gst_app_src_get_size)
@@ -22,10 +21,8 @@
 GST_FUNC(LIBGSTREAMER, gst_bin_get_by_name)
 GST_FUNC(LIBGSTREAMER, gst_bin_get_type)
 GST_FUNC(LIBGSTREAMER, gst_bin_iterate_recurse)
-GST_FUNC(LIBGSTREAMER, gst_buffer_copy_metadata)
 GST_FUNC(LIBGSTREAMER, gst_buffer_get_type)
 GST_FUNC(LIBGSTREAMER, gst_buffer_new)
-GST_FUNC(LIBGSTREAMER, gst_buffer_new_and_alloc)
 GST_FUNC(LIBGSTREAMER, gst_bus_set_sync_handler)
 GST_FUNC(LIBGSTREAMER, gst_bus_timed_pop_filtered)
 GST_FUNC(LIBGSTREAMER, gst_caps_append)
@@ -37,47 +34,37 @@
 GST_FUNC(LIBGSTREAMER, gst_caps_new_empty)
 GST_FUNC(LIBGSTREAMER, gst_caps_new_full)
 GST_FUNC(LIBGSTREAMER, gst_caps_new_simple)
-GST_FUNC(LIBGSTREAMER, gst_caps_unref)
-GST_FUNC(LIBGSTREAMER, gst_element_factory_get_klass)
+GST_FUNC(LIBGSTREAMER, gst_caps_set_simple)
 GST_FUNC(LIBGSTREAMER, gst_element_factory_get_static_pad_templates)
 GST_FUNC(LIBGSTREAMER, gst_element_factory_get_type)
 GST_FUNC(LIBGSTREAMER, gst_element_factory_make)
 GST_FUNC(LIBGSTREAMER, gst_element_get_factory)
-GST_FUNC(LIBGSTREAMER, gst_element_get_pad)
+GST_FUNC(LIBGSTREAMER, gst_element_get_static_pad)
 GST_FUNC(LIBGSTREAMER, gst_element_get_type)
 GST_FUNC(LIBGSTREAMER, gst_element_query_convert)
 GST_FUNC(LIBGSTREAMER, gst_element_query_duration)
 GST_FUNC(LIBGSTREAMER, gst_element_seek_simple)
 GST_FUNC(LIBGSTREAMER, gst_element_set_state)
-GST_FUNC(LIBGSTREAMER, gst_event_parse_new_segment)
 GST_FUNC(LIBGSTREAMER, gst_flow_get_name)
 GST_FUNC(LIBGSTREAMER, gst_init)
 GST_FUNC(LIBGSTREAMER, gst_init_check)
 GST_FUNC(LIBGSTREAMER, gst_iterator_next)
 GST_FUNC(LIBGSTREAMER, gst_message_parse_error)
 GST_FUNC(LIBGSTREAMER, gst_message_type_get_name)
-GST_FUNC(LIBGSTREAMER, gst_mini_object_get_type)
-GST_FUNC(LIBGSTREAMER, gst_mini_object_new)
 GST_FUNC(LIBGSTREAMER, gst_mini_object_ref)
 GST_FUNC(LIBGSTREAMER, gst_mini_object_unref)
 GST_FUNC(LIBGSTREAMER, gst_object_get_name)
 GST_FUNC(LIBGSTREAMER, gst_object_get_parent)
 GST_FUNC(LIBGSTREAMER, gst_object_unref)
-GST_FUNC(LIBGSTREAMER, gst_pad_add_event_probe)
-GST_FUNC(LIBGSTREAMER, gst_pad_alloc_buffer)
 GST_FUNC(LIBGSTREAMER, gst_pad_get_element_private)
-GST_FUNC(LIBGSTREAMER, gst_pad_get_negotiated_caps)
-GST_FUNC(LIBGSTREAMER, gst_pad_set_bufferalloc_function)
 GST_FUNC(LIBGSTREAMER, gst_pad_set_element_private)
 GST_FUNC(LIBGSTREAMER, gst_parse_bin_from_description)
 GST_FUNC(LIBGSTREAMER, gst_pipeline_get_bus)
 GST_FUNC(LIBGSTREAMER, gst_pipeline_get_type)
 GST_FUNC(LIBGSTREAMER, gst_plugin_feature_get_rank)
 GST_FUNC(LIBGSTREAMER, gst_registry_feature_filter)
-GST_FUNC(LIBGSTREAMER, gst_registry_get_default)
 GST_FUNC(LIBGSTREAMER, gst_registry_get_feature_list_cookie)
 GST_FUNC(LIBGSTREAMER, gst_segment_init)
-GST_FUNC(LIBGSTREAMER, gst_segment_set_newsegment)
 GST_FUNC(LIBGSTREAMER, gst_segment_to_stream_time)
 GST_FUNC(LIBGSTREAMER, gst_static_caps_get)
 GST_FUNC(LIBGSTREAMER, gst_structure_copy)
@@ -86,11 +73,82 @@
 GST_FUNC(LIBGSTREAMER, gst_structure_get_value)
 GST_FUNC(LIBGSTREAMER, gst_structure_new)
 GST_FUNC(LIBGSTREAMER, gst_util_uint64_scale)
+
+#if GST_VERSION_MAJOR == 0
+GST_FUNC(LIBGSTAPP, gst_app_sink_pull_buffer)
+GST_FUNC(LIBGSTREAMER, gst_buffer_copy_metadata)
+GST_FUNC(LIBGSTREAMER, gst_buffer_new_and_alloc)
+GST_FUNC(LIBGSTREAMER, gst_caps_unref)
+GST_FUNC(LIBGSTREAMER, gst_element_factory_get_klass)
+GST_FUNC(LIBGSTREAMER, gst_element_get_pad)
+GST_FUNC(LIBGSTREAMER, gst_event_parse_new_segment)
+GST_FUNC(LIBGSTREAMER, gst_mini_object_get_type)
+GST_FUNC(LIBGSTREAMER, gst_mini_object_new)
+GST_FUNC(LIBGSTREAMER, gst_pad_add_event_probe)
+GST_FUNC(LIBGSTREAMER, gst_pad_alloc_buffer)
+GST_FUNC(LIBGSTREAMER, gst_pad_get_negotiated_caps)
+GST_FUNC(LIBGSTREAMER, gst_pad_set_bufferalloc_function)
+GST_FUNC(LIBGSTREAMER, gst_registry_get_default)
+GST_FUNC(LIBGSTREAMER, gst_segment_set_newsegment)
 GST_FUNC(LIBGSTVIDEO, gst_video_format_get_component_height)
 GST_FUNC(LIBGSTVIDEO, gst_video_format_get_component_offset)
 GST_FUNC(LIBGSTVIDEO, gst_video_format_get_component_width)
+GST_FUNC(LIBGSTVIDEO, gst_video_format_get_pixel_stride)
 GST_FUNC(LIBGSTVIDEO, gst_video_format_get_row_stride)
 GST_FUNC(LIBGSTVIDEO, gst_video_format_parse_caps)
+#else
+
+GST_FUNC(LIBGSTAPP, gst_app_sink_pull_sample)
+GST_FUNC(LIBGSTREAMER, _gst_caps_any)
+GST_FUNC(LIBGSTREAMER, gst_allocator_get_type)
+GST_FUNC(LIBGSTREAMER, gst_buffer_copy_into)
+GST_FUNC(LIBGSTREAMER, gst_buffer_extract)
+GST_FUNC(LIBGSTREAMER, gst_buffer_get_meta)
+GST_FUNC(LIBGSTREAMER, gst_buffer_get_size)
+GST_FUNC(LIBGSTREAMER, gst_buffer_map)
+GST_FUNC(LIBGSTREAMER, gst_buffer_new_allocate)
+GST_FUNC(LIBGSTREAMER, gst_buffer_n_memory)
+GST_FUNC(LIBGSTREAMER, gst_buffer_peek_memory)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_acquire_buffer)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_config_set_allocator)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_config_set_params)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_get_config)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_get_type)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_is_active)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_set_active)
+GST_FUNC(LIBGSTREAMER, gst_buffer_pool_set_config)
+GST_FUNC(LIBGSTREAMER, gst_buffer_set_size)
+GST_FUNC(LIBGSTREAMER, gst_buffer_unmap)
+GST_FUNC(LIBGSTREAMER, gst_element_factory_get_metadata)
+GST_FUNC(LIBGSTREAMER, gst_event_parse_segment)
+GST_FUNC(LIBGSTREAMER, gst_memory_init)
+GST_FUNC(LIBGSTREAMER, gst_memory_map)
+GST_FUNC(LIBGSTREAMER, gst_memory_unmap)
+GST_FUNC(LIBGSTREAMER, gst_object_get_type)
+GST_FUNC(LIBGSTREAMER, gst_pad_add_probe)
+GST_FUNC(LIBGSTREAMER, gst_pad_get_current_caps)
+GST_FUNC(LIBGSTREAMER, gst_pad_probe_info_get_query)
+GST_FUNC(LIBGSTREAMER, gst_query_add_allocation_meta)
+GST_FUNC(LIBGSTREAMER, gst_query_add_allocation_param)
+GST_FUNC(LIBGSTREAMER, gst_query_add_allocation_pool)
+GST_FUNC(LIBGSTREAMER, gst_query_parse_allocation)
+GST_FUNC(LIBGSTREAMER, gst_registry_get)
+GST_FUNC(LIBGSTREAMER, gst_sample_get_buffer)
+GST_FUNC(LIBGSTREAMER, gst_segment_copy_into)
+GST_FUNC(LIBGSTREAMER, gst_structure_free)
+GST_FUNC(LIBGSTVIDEO, gst_buffer_pool_config_get_video_alignment)
+GST_FUNC(LIBGSTVIDEO, gst_buffer_pool_has_option)
+GST_FUNC(LIBGSTVIDEO, gst_video_buffer_pool_get_type)
+GST_FUNC(LIBGSTVIDEO, gst_video_frame_map)
+GST_FUNC(LIBGSTVIDEO, gst_video_frame_unmap)
+GST_FUNC(LIBGSTVIDEO, gst_video_info_align)
+GST_FUNC(LIBGSTVIDEO, gst_video_info_from_caps)
+GST_FUNC(LIBGSTVIDEO, gst_video_info_init)
+GST_FUNC(LIBGSTVIDEO, gst_video_meta_api_get_type)
+GST_FUNC(LIBGSTVIDEO, gst_video_meta_map)
+GST_FUNC(LIBGSTVIDEO, gst_video_meta_unmap)
+
+#endif
 
 /*
  * Functions that have been defined in the header file. We replace them so that
@@ -100,6 +158,11 @@
 REPLACE_FUNC(gst_buffer_ref);
 REPLACE_FUNC(gst_buffer_unref);
 REPLACE_FUNC(gst_message_unref);
+
+#if GST_VERSION_MAJOR == 1
+REPLACE_FUNC(gst_caps_unref);
+REPLACE_FUNC(gst_sample_unref);
+#endif
 #endif
 
 #endif // !defined(__APPLE__)
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerLoader.cpp comm-patched/mozilla/content/media/gstreamer/GStreamerLoader.cpp
--- comm-release/mozilla/content/media/gstreamer/GStreamerLoader.cpp	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerLoader.cpp	2014-04-27 14:07:20.235881183 +0100
@@ -6,13 +6,21 @@
 #include <dlfcn.h>
 #include <stdio.h>
 
-#include "GStreamerLoader.h"
+#include "nsDebug.h"
 #include "mozilla/NullPtr.h"
 
+#include "GStreamerLoader.h"
+
 #define LIBGSTREAMER 0
 #define LIBGSTAPP 1
 #define LIBGSTVIDEO 2
 
+#ifdef __OpenBSD__
+#define LIB_GST_SUFFIX ".so"
+#else
+#define LIB_GST_SUFFIX ".so.0"
+#endif
+
 namespace mozilla {
 
 /*
@@ -32,6 +40,11 @@
 GstBuffer * gst_buffer_ref_impl(GstBuffer *buf);
 void gst_buffer_unref_impl(GstBuffer *buf);
 void gst_message_unref_impl(GstMessage *msg);
+void gst_caps_unref_impl(GstCaps *caps);
+
+#if GST_VERSION_MAJOR == 1
+void gst_sample_unref_impl(GstSample *sample);
+#endif
 
 bool
 load_gstreamer()
@@ -58,32 +71,25 @@
   if (major == GST_VERSION_MAJOR && minor == GST_VERSION_MINOR) {
     gstreamerLib = RTLD_DEFAULT;
   } else {
-#ifdef __OpenBSD__
-    gstreamerLib = dlopen("libgstreamer-0.10.so", RTLD_NOW | RTLD_LOCAL);
-#else
-    gstreamerLib = dlopen("libgstreamer-0.10.so.0", RTLD_NOW | RTLD_LOCAL);
-#endif
+    gstreamerLib = dlopen("libgstreamer-" GST_API_VERSION LIB_GST_SUFFIX, RTLD_NOW | RTLD_LOCAL);
   }
 
-  void *handles[] = {
+  void *handles[3] = {
     gstreamerLib,
-#ifdef __OpenBSD__
-    dlopen("libgstapp-0.10.so", RTLD_NOW | RTLD_LOCAL),
-    dlopen("libgstvideo-0.10.so", RTLD_NOW | RTLD_LOCAL)
-#else
-    dlopen("libgstapp-0.10.so.0", RTLD_NOW | RTLD_LOCAL),
-    dlopen("libgstvideo-0.10.so.0", RTLD_NOW | RTLD_LOCAL)
-#endif
+    dlopen("libgstapp-" GST_API_VERSION LIB_GST_SUFFIX, RTLD_NOW | RTLD_LOCAL),
+    dlopen("libgstvideo-" GST_API_VERSION LIB_GST_SUFFIX, RTLD_NOW | RTLD_LOCAL)
   };
 
   for (size_t i = 0; i < sizeof(handles) / sizeof(handles[0]); i++) {
     if (!handles[i]) {
+      NS_WARNING("Couldn't link gstreamer libraries");
       goto fail;
     }
   }
 
 #define GST_FUNC(lib, symbol) \
   if (!(symbol = (typeof(symbol))dlsym(handles[lib], #symbol))) { \
+    NS_WARNING("Couldn't link symbol " #symbol); \
     goto fail; \
   }
 #define REPLACE_FUNC(symbol) symbol = symbol##_impl;
@@ -123,4 +129,18 @@
   gst_mini_object_unref(GST_MINI_OBJECT_CAST(msg));
 }
 
+#if GST_VERSION_MAJOR == 1
+void
+gst_sample_unref_impl(GstSample *sample)
+{
+  gst_mini_object_unref(GST_MINI_OBJECT_CAST(sample));
+}
+#endif
+
+void
+gst_caps_unref_impl(GstCaps *caps)
+{
+  gst_mini_object_unref(GST_MINI_OBJECT_CAST(caps));
+}
+
 }
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerLoader.h comm-patched/mozilla/content/media/gstreamer/GStreamerLoader.h
--- comm-release/mozilla/content/media/gstreamer/GStreamerLoader.h	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerLoader.h	2014-04-27 14:07:20.236111028 +0100
@@ -22,6 +22,11 @@
 #include <gst/video/video.h>
 #pragma GCC diagnostic pop
 
+#if GST_VERSION_MAJOR == 1
+#include <gst/video/gstvideometa.h>
+#include <gst/video/gstvideopool.h>
+#endif
+
 namespace mozilla {
 
 /*
@@ -42,4 +47,7 @@
 
 }
 
+#undef GST_CAPS_ANY
+#define GST_CAPS_ANY (*_gst_caps_any)
+
 #endif // GStreamerLoader_h_
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerReader-0.10.cpp comm-patched/mozilla/content/media/gstreamer/GStreamerReader-0.10.cpp
--- comm-release/mozilla/content/media/gstreamer/GStreamerReader-0.10.cpp	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerReader-0.10.cpp	2014-04-27 14:07:20.236413170 +0100
@@ -0,0 +1,203 @@
+#include "nsError.h"
+#include "MediaDecoderStateMachine.h"
+#include "AbstractMediaDecoder.h"
+#include "MediaResource.h"
+#include "GStreamerReader.h"
+#include "GStreamerMozVideoBuffer.h"
+#include "GStreamerFormatHelper.h"
+#include "VideoUtils.h"
+#include "mozilla/dom/TimeRanges.h"
+#include "mozilla/Preferences.h"
+
+using namespace mozilla;
+using mozilla::layers::PlanarYCbCrImage;
+using mozilla::layers::ImageContainer;
+
+GstFlowReturn GStreamerReader::AllocateVideoBufferCb(GstPad* aPad,
+                                                     guint64 aOffset,
+                                                     guint aSize,
+                                                     GstCaps* aCaps,
+                                                     GstBuffer** aBuf)
+{
+  GStreamerReader* reader = reinterpret_cast<GStreamerReader*>(gst_pad_get_element_private(aPad));
+  return reader->AllocateVideoBuffer(aPad, aOffset, aSize, aCaps, aBuf);
+}
+
+GstFlowReturn GStreamerReader::AllocateVideoBuffer(GstPad* aPad,
+                                                   guint64 aOffset,
+                                                   guint aSize,
+                                                   GstCaps* aCaps,
+                                                   GstBuffer** aBuf)
+{
+  nsRefPtr<PlanarYCbCrImage> image;
+  return AllocateVideoBufferFull(aPad, aOffset, aSize, aCaps, aBuf, image);
+}
+
+GstFlowReturn GStreamerReader::AllocateVideoBufferFull(GstPad* aPad,
+                                                       guint64 aOffset,
+                                                       guint aSize,
+                                                       GstCaps* aCaps,
+                                                       GstBuffer** aBuf,
+                                                       nsRefPtr<PlanarYCbCrImage>& aImage)
+{
+  /* allocate an image using the container */
+  ImageContainer* container = mDecoder->GetImageContainer();
+  if (!container) {
+    // We don't have an ImageContainer. We probably belong to an <audio>
+    // element.
+    return GST_FLOW_NOT_SUPPORTED;
+  }
+  ImageFormat format = PLANAR_YCBCR;
+  PlanarYCbCrImage* img = reinterpret_cast<PlanarYCbCrImage*>(container->CreateImage(&format, 1).get());
+  nsRefPtr<PlanarYCbCrImage> image = dont_AddRef(img);
+
+  /* prepare a GstBuffer pointing to the underlying PlanarYCbCrImage buffer */
+  GstBuffer* buf = GST_BUFFER(gst_moz_video_buffer_new());
+  GST_BUFFER_SIZE(buf) = aSize;
+  /* allocate the actual YUV buffer */
+  GST_BUFFER_DATA(buf) = image->AllocateAndGetNewBuffer(aSize);
+
+  aImage = image;
+
+  /* create a GstMozVideoBufferData to hold the image */
+  GstMozVideoBufferData* bufferdata = new GstMozVideoBufferData(image);
+
+  /* Attach bufferdata to our GstMozVideoBuffer, it will take care to free it */
+  gst_moz_video_buffer_set_data(GST_MOZ_VIDEO_BUFFER(buf), bufferdata);
+
+  *aBuf = buf;
+  return GST_FLOW_OK;
+}
+
+gboolean GStreamerReader::EventProbe(GstPad* aPad, GstEvent* aEvent)
+{
+  GstElement* parent = GST_ELEMENT(gst_pad_get_parent(aPad));
+  switch(GST_EVENT_TYPE(aEvent)) {
+    case GST_EVENT_NEWSEGMENT:
+    {
+      gboolean update;
+      gdouble rate;
+      GstFormat format;
+      gint64 start, stop, position;
+      GstSegment* segment;
+
+      /* Store the segments so we can convert timestamps to stream time, which
+       * is what the upper layers sync on.
+       */
+      ReentrantMonitorAutoEnter mon(mGstThreadsMonitor);
+      gst_event_parse_new_segment(aEvent, &update, &rate, &format,
+          &start, &stop, &position);
+      if (parent == GST_ELEMENT(mVideoAppSink))
+        segment = &mVideoSegment;
+      else
+        segment = &mAudioSegment;
+      gst_segment_set_newsegment(segment, update, rate, format,
+          start, stop, position);
+      break;
+    }
+    case GST_EVENT_FLUSH_STOP:
+      /* Reset on seeks */
+      ResetDecode();
+      break;
+    default:
+      break;
+  }
+  gst_object_unref(parent);
+
+  return TRUE;
+}
+
+gboolean GStreamerReader::EventProbeCb(GstPad* aPad,
+                                         GstEvent* aEvent,
+                                         gpointer aUserData)
+{
+  GStreamerReader* reader = reinterpret_cast<GStreamerReader*>(aUserData);
+  return reader->EventProbe(aPad, aEvent);
+}
+
+nsRefPtr<PlanarYCbCrImage> GStreamerReader::GetImageFromBuffer(GstBuffer* aBuffer)
+{
+  if (!GST_IS_MOZ_VIDEO_BUFFER (aBuffer))
+    return nullptr;
+
+  nsRefPtr<PlanarYCbCrImage> image;
+  GstMozVideoBufferData* bufferdata = reinterpret_cast<GstMozVideoBufferData*>(gst_moz_video_buffer_get_data(GST_MOZ_VIDEO_BUFFER(aBuffer)));
+  image = bufferdata->mImage;
+
+  PlanarYCbCrImage::Data data;
+  data.mPicX = data.mPicY = 0;
+  data.mPicSize = nsIntSize(mPicture.width, mPicture.height);
+  data.mStereoMode = STEREO_MODE_MONO;
+
+  data.mYChannel = GST_BUFFER_DATA(aBuffer);
+  data.mYStride = gst_video_format_get_row_stride(mFormat, 0, mPicture.width);
+  data.mYSize = nsIntSize(data.mYStride,
+      gst_video_format_get_component_height(mFormat, 0, mPicture.height));
+  data.mYSkip = 0;
+  data.mCbCrStride = gst_video_format_get_row_stride(mFormat, 1, mPicture.width);
+  data.mCbCrSize = nsIntSize(data.mCbCrStride,
+      gst_video_format_get_component_height(mFormat, 1, mPicture.height));
+  data.mCbChannel = data.mYChannel + gst_video_format_get_component_offset(mFormat, 1,
+      mPicture.width, mPicture.height);
+  data.mCrChannel = data.mYChannel + gst_video_format_get_component_offset(mFormat, 2,
+      mPicture.width, mPicture.height);
+  data.mCbSkip = 0;
+  data.mCrSkip = 0;
+
+  image->SetDataNoCopy(data);
+
+  return image;
+}
+
+void GStreamerReader::CopyIntoImageBuffer(GstBuffer* aBuffer,
+                                          GstBuffer** aOutBuffer,
+                                          nsRefPtr<PlanarYCbCrImage> &aImage)
+{
+  AllocateVideoBufferFull(nullptr, GST_BUFFER_OFFSET(aBuffer),
+      GST_BUFFER_SIZE(aBuffer), nullptr, aOutBuffer, aImage);
+
+  gst_buffer_copy_metadata(*aOutBuffer, aBuffer, (GstBufferCopyFlags)GST_BUFFER_COPY_ALL);
+  memcpy(GST_BUFFER_DATA(*aOutBuffer), GST_BUFFER_DATA(aBuffer), GST_BUFFER_SIZE(*aOutBuffer));
+
+  aImage = GetImageFromBuffer(*aOutBuffer);
+}
+
+GstCaps* GStreamerReader::BuildAudioSinkCaps()
+{
+  GstCaps* caps;
+#ifdef IS_LITTLE_ENDIAN
+  int endianness = 1234;
+#else
+  int endianness = 4321;
+#endif
+  gint width;
+#ifdef MOZ_SAMPLE_TYPE_FLOAT32
+  caps = gst_caps_from_string("audio/x-raw-float, channels={1,2}");
+  width = 32;
+#else /* !MOZ_SAMPLE_TYPE_FLOAT32 */
+  caps = gst_caps_from_string("audio/x-raw-int, channels={1,2}");
+  width = 16;
+#endif
+  gst_caps_set_simple(caps,
+      "width", G_TYPE_INT, width,
+      "endianness", G_TYPE_INT, endianness,
+      NULL);
+
+  return caps;
+}
+
+void GStreamerReader::InstallPadCallbacks()
+{
+  GstPad* sinkpad = gst_element_get_static_pad(GST_ELEMENT(mVideoAppSink), "sink");
+  gst_pad_add_event_probe(sinkpad,
+                          G_CALLBACK(&GStreamerReader::EventProbeCb), this);
+
+  gst_pad_set_bufferalloc_function(sinkpad, GStreamerReader::AllocateVideoBufferCb);
+  gst_pad_set_element_private(sinkpad, this);
+  gst_object_unref(sinkpad);
+
+  sinkpad = gst_element_get_static_pad(GST_ELEMENT(mAudioAppSink), "sink");
+  gst_pad_add_event_probe(sinkpad,
+                          G_CALLBACK(&GStreamerReader::EventProbeCb), this);
+  gst_object_unref(sinkpad);
+}
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerReader.cpp comm-patched/mozilla/content/media/gstreamer/GStreamerReader.cpp
--- comm-release/mozilla/content/media/gstreamer/GStreamerReader.cpp	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerReader.cpp	2014-04-27 14:07:20.237576717 +0100
@@ -10,8 +10,10 @@
 #include "AbstractMediaDecoder.h"
 #include "MediaResource.h"
 #include "GStreamerReader.h"
+#if GST_VERSION_MAJOR >= 1
+#include "GStreamerAllocator.h"
+#endif
 #include "GStreamerFormatHelper.h"
-#include "GStreamerMozVideoBuffer.h"
 #include "VideoUtils.h"
 #include "mozilla/dom/TimeRanges.h"
 #include "mozilla/Preferences.h"
@@ -33,14 +35,16 @@
 #define LOG(type, msg, ...)
 #endif
 
-extern bool
-IsYV12Format(const VideoData::YCbCrBuffer::Plane& aYPlane,
-             const VideoData::YCbCrBuffer::Plane& aCbPlane,
-             const VideoData::YCbCrBuffer::Plane& aCrPlane);
-
+#if DEBUG
 static const unsigned int MAX_CHANNELS = 4;
-// Let the demuxer work in pull mode for short files
-static const int SHORT_FILE_SIZE = 1024 * 1024;
+#endif
+// Let the demuxer work in pull mode for short files. This used to be a micro
+// optimization to have more accurate durations for ogg files in mochitests.
+// Since as of today we aren't using gstreamer to demux ogg, and having demuxers
+// work in pull mode over http makes them slower (since they really assume
+// near-zero latency in pull mode) set the constant to 0 for now, which
+// effectively disables it.
+static const int SHORT_FILE_SIZE = 0;
 // The default resource->Read() size when working in push mode
 static const int DEFAULT_SOURCE_READ_SIZE = 50 * 1024;
 
@@ -62,6 +66,10 @@
   : MediaDecoderReader(aDecoder),
   mMP3FrameParser(aDecoder->GetResource()->GetLength()),
   mUseParserDuration(false),
+#if GST_VERSION_MAJOR >= 1
+  mAllocator(nullptr),
+  mBufferPool(nullptr),
+#endif
   mPlayBin(nullptr),
   mBus(nullptr),
   mSource(nullptr),
@@ -74,6 +82,9 @@
   mAudioSinkBufferCount(0),
   mGstThreadsMonitor("media.gst.threads"),
   mReachedEos(false),
+#if GST_VERSION_MAJOR >= 1
+  mConfigureAlignment(true),
+#endif
   fpsNum(0),
   fpsDen(0)
 {
@@ -85,8 +96,12 @@
 
   mSinkCallbacks.eos = GStreamerReader::EosCb;
   mSinkCallbacks.new_preroll = GStreamerReader::NewPrerollCb;
+#if GST_VERSION_MAJOR >= 1
+  mSinkCallbacks.new_sample = GStreamerReader::NewBufferCb;
+#else
   mSinkCallbacks.new_buffer = GStreamerReader::NewBufferCb;
   mSinkCallbacks.new_buffer_list = nullptr;
+#endif
 
   gst_segment_init(&mVideoSegment, GST_FORMAT_UNDEFINED);
   gst_segment_init(&mAudioSegment, GST_FORMAT_UNDEFINED);
@@ -110,65 +125,59 @@
     mAudioAppSink = nullptr;
     gst_object_unref(mBus);
     mBus = nullptr;
+#if GST_VERSION_MAJOR >= 1
+    g_object_unref(mAllocator);
+    g_object_unref(mBufferPool);
+#endif
   }
 }
 
 nsresult GStreamerReader::Init(MediaDecoderReader* aCloneDonor)
 {
-  GError* error = nullptr;
-  if (!gst_init_check(0, 0, &error)) {
-    LOG(PR_LOG_ERROR, "gst initialization failed: %s", error->message);
-    g_error_free(error);
-    return NS_ERROR_FAILURE;
-  }
+  GStreamerFormatHelper::Instance();
+
+#if GST_VERSION_MAJOR >= 1
+  mAllocator = static_cast<GstAllocator*>(g_object_new(GST_TYPE_MOZ_GFX_MEMORY_ALLOCATOR, nullptr));
+  moz_gfx_memory_allocator_set_reader(mAllocator, this);
+
+  mBufferPool = static_cast<GstBufferPool*>(g_object_new(GST_TYPE_MOZ_GFX_BUFFER_POOL, nullptr));
+#endif
 
+#if GST_VERSION_MAJOR >= 1
+  mPlayBin = gst_element_factory_make("playbin", nullptr);
+#else
   mPlayBin = gst_element_factory_make("playbin2", nullptr);
+#endif
   if (!mPlayBin) {
-    LOG(PR_LOG_ERROR, "couldn't create playbin2");
+    LOG(PR_LOG_ERROR, "couldn't create playbin");
     return NS_ERROR_FAILURE;
   }
   g_object_set(mPlayBin, "buffer-size", 0, nullptr);
   mBus = gst_pipeline_get_bus(GST_PIPELINE(mPlayBin));
 
   mVideoSink = gst_parse_bin_from_description("capsfilter name=filter ! "
-      "appsink name=videosink sync=true max-buffers=1 "
+      "appsink name=videosink sync=false max-buffers=1 "
+#if GST_VERSION_MAJOR >= 1
+      "caps=video/x-raw,format=I420"
+#else
       "caps=video/x-raw-yuv,format=(fourcc)I420"
+#endif
       , TRUE, nullptr);
   mVideoAppSink = GST_APP_SINK(gst_bin_get_by_name(GST_BIN(mVideoSink),
         "videosink"));
-  gst_app_sink_set_callbacks(mVideoAppSink, &mSinkCallbacks,
-      (gpointer) this, nullptr);
-  GstPad* sinkpad = gst_element_get_pad(GST_ELEMENT(mVideoAppSink), "sink");
-  gst_pad_add_event_probe(sinkpad,
-      G_CALLBACK(&GStreamerReader::EventProbeCb), this);
-  gst_object_unref(sinkpad);
-  gst_pad_set_bufferalloc_function(sinkpad, GStreamerReader::AllocateVideoBufferCb);
-  gst_pad_set_element_private(sinkpad, this);
-
   mAudioSink = gst_parse_bin_from_description("capsfilter name=filter ! "
-#ifdef MOZ_SAMPLE_TYPE_FLOAT32
-        "appsink name=audiosink max-buffers=2 sync=false caps=audio/x-raw-float,"
-#ifdef IS_LITTLE_ENDIAN
-        "channels={1,2},width=32,endianness=1234", TRUE, nullptr);
-#else
-        "channels={1,2},width=32,endianness=4321", TRUE, nullptr);
-#endif
-#else
-        "appsink name=audiosink max-buffers=2 sync=false caps=audio/x-raw-int,"
-#ifdef IS_LITTLE_ENDIAN
-        "channels={1,2},width=16,endianness=1234", TRUE, nullptr);
-#else
-        "channels={1,2},width=16,endianness=4321", TRUE, nullptr);
-#endif
-#endif
+        "appsink name=audiosink sync=false max-buffers=1", TRUE, nullptr);
   mAudioAppSink = GST_APP_SINK(gst_bin_get_by_name(GST_BIN(mAudioSink),
                                                    "audiosink"));
+  GstCaps* caps = BuildAudioSinkCaps();
+  g_object_set(mAudioAppSink, "caps", caps, nullptr);
+  gst_caps_unref(caps);
+
+  gst_app_sink_set_callbacks(mVideoAppSink, &mSinkCallbacks,
+      (gpointer) this, nullptr);
   gst_app_sink_set_callbacks(mAudioAppSink, &mSinkCallbacks,
                              (gpointer) this, nullptr);
-  sinkpad = gst_element_get_pad(GST_ELEMENT(mAudioAppSink), "sink");
-  gst_pad_add_event_probe(sinkpad,
-                          G_CALLBACK(&GStreamerReader::EventProbeCb), this);
-  gst_object_unref(sinkpad);
+  InstallPadCallbacks();
 
   g_object_set(mPlayBin, "uri", "appsrc://",
                "video-sink", mVideoSink,
@@ -331,7 +340,7 @@
       /* Little trick: set the target caps to "skip" so that playbin2 fails to
        * find a decoder for the stream we want to skip.
        */
-      GstCaps* filterCaps = gst_caps_new_simple ("skip", nullptr);
+      GstCaps* filterCaps = gst_caps_new_simple ("skip", nullptr, nullptr);
       g_object_set(filter, "caps", filterCaps, nullptr);
       gst_caps_unref(filterCaps);
       gst_object_unref(filter);
@@ -358,6 +367,7 @@
       gst_message_unref(message);
       ret = NS_ERROR_FAILURE;
     } else {
+      LOG(PR_LOG_DEBUG, "read metadata pipeline prerolled");
       gst_message_unref(message);
       ret = NS_OK;
       break;
@@ -371,23 +381,8 @@
     /* we couldn't get this to play */
     return ret;
 
-  /* FIXME: workaround for a bug in matroskademux. This seek makes matroskademux
-   * parse the index */
-  if (gst_element_seek_simple(mPlayBin, GST_FORMAT_TIME,
-        GST_SEEK_FLAG_FLUSH, 0)) {
-    /* after a seek we need to wait again for ASYNC_DONE */
-    message = gst_bus_timed_pop_filtered(mBus, GST_CLOCK_TIME_NONE,
-       (GstMessageType)(GST_MESSAGE_ASYNC_DONE | GST_MESSAGE_ERROR));
-    if (GST_MESSAGE_TYPE(message) == GST_MESSAGE_ERROR) {
-      gst_element_set_state(mPlayBin, GST_STATE_NULL);
-      gst_message_unref(message);
-      return NS_ERROR_FAILURE;
-    }
-  }
-
   /* report the duration */
   gint64 duration;
-  GstFormat format = GST_FORMAT_TIME;
 
   if (isMP3 && mMP3FrameParser.IsMP3()) {
     // The MP3FrameParser has reported a duration; use that over the gstreamer
@@ -396,17 +391,25 @@
     mUseParserDuration = true;
     mLastParserDuration = mMP3FrameParser.GetDuration();
     mDecoder->SetMediaDuration(mLastParserDuration);
-
-  } else if (gst_element_query_duration(GST_ELEMENT(mPlayBin),
-      &format, &duration) && format == GST_FORMAT_TIME) {
-    // Otherwise use the gstreamer duration.
-    ReentrantMonitorAutoEnter mon(mDecoder->GetReentrantMonitor());
-    LOG(PR_LOG_DEBUG, "returning duration %" GST_TIME_FORMAT, GST_TIME_ARGS(duration));
-    duration = GST_TIME_AS_USECONDS (duration);
-    mDecoder->SetMediaDuration(duration);
-
   } else {
-    mDecoder->SetMediaSeekable(false);
+    LOG(PR_LOG_DEBUG, "querying duration");
+    // Otherwise use the gstreamer duration.
+#if GST_VERSION_MAJOR >= 1
+    if (gst_element_query_duration(GST_ELEMENT(mPlayBin),
+          GST_FORMAT_TIME, &duration)) {
+#else
+    GstFormat format = GST_FORMAT_TIME;
+    if (gst_element_query_duration(GST_ELEMENT(mPlayBin),
+      &format, &duration) && format == GST_FORMAT_TIME) {
+#endif
+      ReentrantMonitorAutoEnter mon(mDecoder->GetReentrantMonitor());
+      LOG(PR_LOG_DEBUG, "have duration %" GST_TIME_FORMAT,
+            GST_TIME_ARGS (duration));
+      duration = GST_TIME_AS_USECONDS (duration);
+      mDecoder->SetMediaDuration(duration);
+    } else {
+      mDecoder->SetMediaSeekable(false);
+    }
   }
 
   int n_video = 0, n_audio = 0;
@@ -419,7 +422,11 @@
   *aTags = nullptr;
 
   // Watch the pipeline for fatal errors
+#if GST_VERSION_MAJOR >= 1
+  gst_bus_set_sync_handler(mBus, GStreamerReader::ErrorCb, this, nullptr);
+#else
   gst_bus_set_sync_handler(mBus, GStreamerReader::ErrorCb, this);
+#endif
 
   /* set the pipeline to PLAYING so that it starts decoding and queueing data in
    * the appsinks */
@@ -433,19 +440,35 @@
   bool done = false;
   bool unsupported = false;
 
-  GstIterator *it = gst_bin_iterate_recurse(GST_BIN(mPlayBin));
+  GstIterator* it = gst_bin_iterate_recurse(GST_BIN(mPlayBin));
   while (!done) {
+    GstIteratorResult res;
     GstElement* element;
-    GstIteratorResult res = gst_iterator_next(it, (void **)&element);
+
+#if GST_VERSION_MAJOR >= 1
+    GValue value = {0,};
+    res = gst_iterator_next(it, &value);
+#else
+    res = gst_iterator_next(it, (void **) &element);
+#endif
     switch(res) {
       case GST_ITERATOR_OK:
       {
+#if GST_VERSION_MAJOR >= 1
+        element = GST_ELEMENT (g_value_get_object (&value));
+#endif
         GstElementFactory* factory = gst_element_get_factory(element);
         if (factory) {
           const char* klass = gst_element_factory_get_klass(factory);
-          GstPad* pad = gst_element_get_pad(element, "sink");
+          GstPad* pad = gst_element_get_static_pad(element, "sink");
           if (pad) {
-            GstCaps* caps = gst_pad_get_negotiated_caps(pad);
+            GstCaps* caps;
+
+#if GST_VERSION_MAJOR >= 1
+            caps = gst_pad_get_current_caps(pad);
+#else
+            caps = gst_pad_get_negotiated_caps(pad);
+#endif
 
             if (caps) {
               /* check for demuxers but ignore elements like id3demux */
@@ -460,7 +483,11 @@
           }
         }
 
+#if GST_VERSION_MAJOR >= 1
+        g_value_unset (&value);
+#else
         gst_object_unref(element);
+#endif
         done = unsupported;
         break;
       }
@@ -484,6 +511,8 @@
 {
   nsresult res = NS_OK;
 
+  LOG(PR_LOG_DEBUG, "reset decode");
+
   if (NS_FAILED(MediaDecoderReader::ResetDecode())) {
     res = NS_ERROR_FAILURE;
   }
@@ -494,6 +523,11 @@
   mVideoSinkBufferCount = 0;
   mAudioSinkBufferCount = 0;
   mReachedEos = false;
+#if GST_VERSION_MAJOR >= 1
+  mConfigureAlignment = true;
+#endif
+
+  LOG(PR_LOG_DEBUG, "reset decode done");
 
   return res;
 }
@@ -517,11 +551,11 @@
         /* We have nothing decoded so it makes no sense to return to the state machine
          * as it will call us back immediately, we'll return again and so on, wasting
          * CPU cycles for no job done. So, block here until there is either video or
-         * audio data available 
+         * audio data available
         */
         mon.Wait();
         if (!mAudioSinkBufferCount) {
-          /* There is still no audio data available, so either there is video data or 
+          /* There is still no audio data available, so either there is video data or
            * something else has happened (Eos, etc...). Return to the state machine
            * to process it.
            */
@@ -533,24 +567,43 @@
       }
     }
 
+#if GST_VERSION_MAJOR >= 1
+    GstSample *sample = gst_app_sink_pull_sample(mAudioAppSink);
+    buffer = gst_buffer_ref(gst_sample_get_buffer(sample));
+    gst_sample_unref(sample);
+#else
     buffer = gst_app_sink_pull_buffer(mAudioAppSink);
+#endif
+
     mAudioSinkBufferCount--;
   }
 
   int64_t timestamp = GST_BUFFER_TIMESTAMP(buffer);
   timestamp = gst_segment_to_stream_time(&mAudioSegment,
       GST_FORMAT_TIME, timestamp);
+  
   timestamp = GST_TIME_AS_USECONDS(timestamp);
   int64_t duration = 0;
   if (GST_CLOCK_TIME_IS_VALID(GST_BUFFER_DURATION(buffer)))
     duration = GST_TIME_AS_USECONDS(GST_BUFFER_DURATION(buffer));
 
   int64_t offset = GST_BUFFER_OFFSET(buffer);
+#if GST_VERSION_MAJOR >= 1
+  GstMapInfo info;
+  gst_buffer_map(buffer, &info, GST_MAP_READ);
+  unsigned int size = info.size;
+#else
   unsigned int size = GST_BUFFER_SIZE(buffer);
+#endif
   int32_t frames = (size / sizeof(AudioDataValue)) / mInfo.mAudio.mChannels;
   ssize_t outSize = static_cast<size_t>(size / sizeof(AudioDataValue));
   nsAutoArrayPtr<AudioDataValue> data(new AudioDataValue[outSize]);
+#if GST_VERSION_MAJOR >= 1
+  memcpy(data, info.data, info.size);
+  gst_buffer_unmap(buffer, &info);
+#else
   memcpy(data, GST_BUFFER_DATA(buffer), GST_BUFFER_SIZE(buffer));
+#endif
   AudioData* audio = new AudioData(offset, timestamp, duration,
       frames, data.forget(), mInfo.mAudio.mChannels);
 
@@ -561,7 +614,7 @@
 }
 
 bool GStreamerReader::DecodeVideoFrame(bool &aKeyFrameSkip,
-                                         int64_t aTimeThreshold)
+                                       int64_t aTimeThreshold)
 {
   NS_ASSERTION(mDecoder->OnDecodeThread(), "Should be on decode thread.");
 
@@ -580,11 +633,11 @@
         /* We have nothing decoded so it makes no sense to return to the state machine
          * as it will call us back immediately, we'll return again and so on, wasting
          * CPU cycles for no job done. So, block here until there is either video or
-         * audio data available 
+         * audio data available
         */
         mon.Wait();
         if (!mVideoSinkBufferCount) {
-          /* There is still no video data available, so either there is audio data or 
+          /* There is still no video data available, so either there is audio data or
            * something else has happened (Eos, etc...). Return to the state machine
            * to process it
            */
@@ -598,11 +651,17 @@
 
     mDecoder->NotifyDecodedFrames(0, 1);
 
+#if GST_VERSION_MAJOR >= 1
+    GstSample *sample = gst_app_sink_pull_sample(mVideoAppSink);
+    buffer = gst_buffer_ref(gst_sample_get_buffer(sample));
+    gst_sample_unref(sample);
+#else
     buffer = gst_app_sink_pull_buffer(mVideoAppSink);
+#endif
     mVideoSinkBufferCount--;
   }
 
-  bool isKeyframe = !GST_BUFFER_FLAG_IS_SET(buffer, GST_BUFFER_FLAG_DISCONT);
+  bool isKeyframe = !GST_BUFFER_FLAG_IS_SET(buffer, GST_BUFFER_FLAG_DELTA_UNIT);
   if ((aKeyFrameSkip && !isKeyframe)) {
     gst_buffer_unref(buffer);
     return true;
@@ -618,73 +677,55 @@
                "frame has invalid timestamp");
 
   timestamp = GST_TIME_AS_USECONDS(timestamp);
+  int64_t duration;
+  if (GST_CLOCK_TIME_IS_VALID(GST_BUFFER_DURATION(buffer)))
+    duration = GST_TIME_AS_USECONDS(GST_BUFFER_DURATION(buffer));
+  else if (fpsNum && fpsDen)
+    /* add 1-frame duration */
+    duration = gst_util_uint64_scale(GST_USECOND, fpsDen, fpsNum);
+
   if (timestamp < aTimeThreshold) {
     LOG(PR_LOG_DEBUG, "skipping frame %" GST_TIME_FORMAT
-                      " threshold %" GST_TIME_FORMAT,
-                      GST_TIME_ARGS(timestamp), GST_TIME_ARGS(aTimeThreshold));
+                       " threshold %" GST_TIME_FORMAT,
+                       GST_TIME_ARGS(timestamp * 1000),
+                       GST_TIME_ARGS(aTimeThreshold * 1000));
     gst_buffer_unref(buffer);
     return true;
   }
-
   if (!buffer)
     /* no more frames */
     return false;
 
-  int64_t duration = 0;
-  if (GST_CLOCK_TIME_IS_VALID(GST_BUFFER_DURATION(buffer)))
-    duration = GST_TIME_AS_USECONDS(GST_BUFFER_DURATION(buffer));
-  else if (fpsNum && fpsDen)
-    /* 1-frame duration */
-    duration = gst_util_uint64_scale(GST_USECOND, fpsNum, fpsDen);
-
-  nsRefPtr<PlanarYCbCrImage> image;
-  GstMozVideoBufferData* bufferdata = reinterpret_cast<GstMozVideoBufferData*>
-      GST_IS_MOZ_VIDEO_BUFFER(buffer)?gst_moz_video_buffer_get_data(GST_MOZ_VIDEO_BUFFER(buffer)):nullptr;
-
-  if(bufferdata)
-    image = bufferdata->mImage;
+#if GST_VERSION_MAJOR >= 1
+  if (mConfigureAlignment && buffer->pool) {
+    GstStructure *config = gst_buffer_pool_get_config(buffer->pool);
+    GstVideoAlignment align;
+    if (gst_buffer_pool_config_get_video_alignment(config, &align))
+      gst_video_info_align(&mVideoInfo, &align);
+    gst_structure_free(config);
+    mConfigureAlignment = false;
+  }
+#endif
 
+  nsRefPtr<PlanarYCbCrImage> image = GetImageFromBuffer(buffer);
   if (!image) {
     /* Ugh, upstream is not calling gst_pad_alloc_buffer(). Fallback to
      * allocating a PlanarYCbCrImage backed GstBuffer here and memcpy.
      */
     GstBuffer* tmp = nullptr;
-    AllocateVideoBufferFull(nullptr, GST_BUFFER_OFFSET(buffer),
-        GST_BUFFER_SIZE(buffer), nullptr, &tmp, image);
-
-    /* copy */
-    gst_buffer_copy_metadata(tmp, buffer, (GstBufferCopyFlags)GST_BUFFER_COPY_ALL);
-    memcpy(GST_BUFFER_DATA(tmp), GST_BUFFER_DATA(buffer),
-        GST_BUFFER_SIZE(tmp));
+    CopyIntoImageBuffer(buffer, &tmp, image);
     gst_buffer_unref(buffer);
     buffer = tmp;
   }
 
-  guint8* data = GST_BUFFER_DATA(buffer);
-
-  int width = mPicture.width;
-  int height = mPicture.height;
-  GstVideoFormat format = mFormat;
-
-  VideoData::YCbCrBuffer b;
-  for(int i = 0; i < 3; i++) {
-    b.mPlanes[i].mData = data + gst_video_format_get_component_offset(format, i,
-        width, height);
-    b.mPlanes[i].mStride = gst_video_format_get_row_stride(format, i, width);
-    b.mPlanes[i].mHeight = gst_video_format_get_component_height(format,
-        i, height);
-    b.mPlanes[i].mWidth = gst_video_format_get_component_width(format,
-        i, width);
-    b.mPlanes[i].mOffset = 0;
-    b.mPlanes[i].mSkip = 0;
-  }
-
-  isKeyframe = !GST_BUFFER_FLAG_IS_SET(buffer, GST_BUFFER_FLAG_DELTA_UNIT);
   int64_t offset = mDecoder->GetResource()->Tell(); // Estimate location in media.
-  VideoData* video = VideoData::Create(mInfo.mVideo, image, offset,
-                                       timestamp, duration, b,
-                                       isKeyframe, -1, mPicture);
+  VideoData* video = VideoData::CreateFromImage(mInfo.mVideo,
+                                                mDecoder->GetImageContainer(),
+                                                offset, timestamp, duration,
+                                                static_cast<Image*>(image.get()),
+                                                isKeyframe, -1, mPicture);
   mVideoQueue.Push(video);
+
   gst_buffer_unref(buffer);
 
   return true;
@@ -707,6 +748,10 @@
     return NS_ERROR_FAILURE;
   }
   LOG(PR_LOG_DEBUG, "seek succeeded");
+  GstMessage* message = gst_bus_timed_pop_filtered(mBus, GST_CLOCK_TIME_NONE,
+               (GstMessageType)(GST_MESSAGE_ASYNC_DONE | GST_MESSAGE_ERROR));
+  gst_message_unref(message);
+  LOG(PR_LOG_DEBUG, "seek completed");
 
   return DecodeToTarget(aTarget);
 }
@@ -718,7 +763,9 @@
     return NS_OK;
   }
 
+#if GST_VERSION_MAJOR == 0
   GstFormat format = GST_FORMAT_TIME;
+#endif
   MediaResource* resource = mDecoder->GetResource();
   nsTArray<MediaByteRange> ranges;
   resource->GetCachedRanges(ranges);
@@ -740,12 +787,21 @@
     int64_t endOffset = ranges[index].mEnd;
     gint64 startTime, endTime;
 
+#if GST_VERSION_MAJOR >= 1
+    if (!gst_element_query_convert(GST_ELEMENT(mPlayBin), GST_FORMAT_BYTES,
+      startOffset, GST_FORMAT_TIME, &startTime))
+      continue;
+    if (!gst_element_query_convert(GST_ELEMENT(mPlayBin), GST_FORMAT_BYTES,
+      endOffset, GST_FORMAT_TIME, &endTime))
+      continue;
+#else
     if (!gst_element_query_convert(GST_ELEMENT(mPlayBin), GST_FORMAT_BYTES,
       startOffset, &format, &startTime) || format != GST_FORMAT_TIME)
       continue;
     if (!gst_element_query_convert(GST_ELEMENT(mPlayBin), GST_FORMAT_BYTES,
       endOffset, &format, &endTime) || format != GST_FORMAT_TIME)
       continue;
+#endif
 
     double start = (double) GST_TIME_AS_USECONDS (startTime) / GST_MSECOND;
     double end = (double) GST_TIME_AS_USECONDS (endTime) / GST_MSECOND;
@@ -766,7 +822,13 @@
   nsresult rv = NS_OK;
 
   GstBuffer* buffer = gst_buffer_new_and_alloc(aLength);
+#if GST_VERSION_MAJOR >= 1
+  GstMapInfo info;
+  gst_buffer_map(buffer, &info, GST_MAP_WRITE);
+  guint8 *data = info.data;
+#else
   guint8* data = GST_BUFFER_DATA(buffer);
+#endif
   uint32_t size = 0, bytesRead = 0;
   while(bytesRead < aLength) {
     rv = resource->Read(reinterpret_cast<char*>(data + bytesRead),
@@ -780,7 +842,12 @@
   int64_t offset2 = resource->Tell();
   unused << offset2;
 
+#if GST_VERSION_MAJOR >= 1
+  gst_buffer_unmap(buffer, &info);
+  gst_buffer_set_size(buffer, bytesRead);
+#else
   GST_BUFFER_SIZE(buffer) = bytesRead;
+#endif
 
   GstFlowReturn ret = gst_app_src_push_buffer(mSource, gst_buffer_ref(buffer));
   if (ret != GST_FLOW_OK) {
@@ -813,8 +880,13 @@
   gint64 duration = 0;
   GstFormat format = GST_FORMAT_TIME;
 
+#if GST_VERSION_MAJOR >= 1
+  if (gst_element_query_duration(GST_ELEMENT(mPlayBin),
+      format, &duration)) {
+#else
   if (gst_element_query_duration(GST_ELEMENT(mPlayBin),
       &format, &duration)) {
+#endif
     if (format == GST_FORMAT_TIME) {
       LOG(PR_LOG_DEBUG, "pipeline duration %" GST_TIME_FORMAT,
             GST_TIME_ARGS (duration));
@@ -893,108 +965,6 @@
   return NS_SUCCEEDED(rv);
 }
 
-gboolean GStreamerReader::EventProbeCb(GstPad* aPad,
-                                         GstEvent* aEvent,
-                                         gpointer aUserData)
-{
-  GStreamerReader* reader = reinterpret_cast<GStreamerReader*>(aUserData);
-  return reader->EventProbe(aPad, aEvent);
-}
-
-gboolean GStreamerReader::EventProbe(GstPad* aPad, GstEvent* aEvent)
-{
-  GstElement* parent = GST_ELEMENT(gst_pad_get_parent(aPad));
-  switch(GST_EVENT_TYPE(aEvent)) {
-    case GST_EVENT_NEWSEGMENT:
-    {
-      gboolean update;
-      gdouble rate;
-      GstFormat format;
-      gint64 start, stop, position;
-      GstSegment* segment;
-
-      /* Store the segments so we can convert timestamps to stream time, which
-       * is what the upper layers sync on.
-       */
-      ReentrantMonitorAutoEnter mon(mGstThreadsMonitor);
-      gst_event_parse_new_segment(aEvent, &update, &rate, &format,
-          &start, &stop, &position);
-      if (parent == GST_ELEMENT(mVideoAppSink))
-        segment = &mVideoSegment;
-      else
-        segment = &mAudioSegment;
-      gst_segment_set_newsegment(segment, update, rate, format,
-          start, stop, position);
-      break;
-    }
-    case GST_EVENT_FLUSH_STOP:
-      /* Reset on seeks */
-      ResetDecode();
-      break;
-    default:
-      break;
-  }
-  gst_object_unref(parent);
-
-  return TRUE;
-}
-
-GstFlowReturn GStreamerReader::AllocateVideoBufferFull(GstPad* aPad,
-                                                       guint64 aOffset,
-                                                       guint aSize,
-                                                       GstCaps* aCaps,
-                                                       GstBuffer** aBuf,
-                                                       nsRefPtr<PlanarYCbCrImage>& aImage)
-{
-  /* allocate an image using the container */
-  ImageContainer* container = mDecoder->GetImageContainer();
-  if (!container) {
-    // We don't have an ImageContainer. We probably belong to an <audio>
-    // element.
-    return GST_FLOW_NOT_SUPPORTED;
-  }
-  ImageFormat format = PLANAR_YCBCR;
-  PlanarYCbCrImage* img = reinterpret_cast<PlanarYCbCrImage*>(container->CreateImage(&format, 1).get());
-  nsRefPtr<PlanarYCbCrImage> image = dont_AddRef(img);
-
-  /* prepare a GstBuffer pointing to the underlying PlanarYCbCrImage buffer */
-  GstBuffer* buf = GST_BUFFER(gst_moz_video_buffer_new());
-  GST_BUFFER_SIZE(buf) = aSize;
-  /* allocate the actual YUV buffer */
-  GST_BUFFER_DATA(buf) = image->AllocateAndGetNewBuffer(aSize);
-
-  aImage = image;
-
-  /* create a GstMozVideoBufferData to hold the image */
-  GstMozVideoBufferData* bufferdata = new GstMozVideoBufferData(image);
-
-  /* Attach bufferdata to our GstMozVideoBuffer, it will take care to free it */
-  gst_moz_video_buffer_set_data(GST_MOZ_VIDEO_BUFFER(buf), bufferdata);
-
-  *aBuf = buf;
-  return GST_FLOW_OK;
-}
-
-GstFlowReturn GStreamerReader::AllocateVideoBufferCb(GstPad* aPad,
-                                                     guint64 aOffset,
-                                                     guint aSize,
-                                                     GstCaps* aCaps,
-                                                     GstBuffer** aBuf)
-{
-  GStreamerReader* reader = reinterpret_cast<GStreamerReader*>(gst_pad_get_element_private(aPad));
-  return reader->AllocateVideoBuffer(aPad, aOffset, aSize, aCaps, aBuf);
-}
-
-GstFlowReturn GStreamerReader::AllocateVideoBuffer(GstPad* aPad,
-                                                   guint64 aOffset,
-                                                   guint aSize,
-                                                   GstCaps* aCaps,
-                                                   GstBuffer** aBuf)
-{
-  nsRefPtr<PlanarYCbCrImage> image;
-  return AllocateVideoBufferFull(aPad, aOffset, aSize, aCaps, aBuf, image);
-}
-
 GstFlowReturn GStreamerReader::NewPrerollCb(GstAppSink* aSink,
                                               gpointer aUserData)
 {
@@ -1011,8 +981,12 @@
 {
   /* The first audio buffer has reached the audio sink. Get rate and channels */
   LOG(PR_LOG_DEBUG, "Audio preroll");
-  GstPad* sinkpad = gst_element_get_pad(GST_ELEMENT(mAudioAppSink), "sink");
+  GstPad* sinkpad = gst_element_get_static_pad(GST_ELEMENT(mAudioAppSink), "sink");
+#if GST_VERSION_MAJOR >= 1
+  GstCaps *caps = gst_pad_get_current_caps(sinkpad);
+#else
   GstCaps* caps = gst_pad_get_negotiated_caps(sinkpad);
+#endif
   GstStructure* s = gst_caps_get_structure(caps, 0);
   mInfo.mAudio.mRate = mInfo.mAudio.mChannels = 0;
   gst_structure_get_int(s, "rate", (gint*) &mInfo.mAudio.mRate);
@@ -1030,9 +1004,18 @@
 {
   /* The first video buffer has reached the video sink. Get width and height */
   LOG(PR_LOG_DEBUG, "Video preroll");
-  GstPad* sinkpad = gst_element_get_pad(GST_ELEMENT(mVideoAppSink), "sink");
+  GstPad* sinkpad = gst_element_get_static_pad(GST_ELEMENT(mVideoAppSink), "sink");
+#if GST_VERSION_MAJOR >= 1
+  GstCaps* caps = gst_pad_get_current_caps(sinkpad);
+  memset (&mVideoInfo, 0, sizeof (mVideoInfo));
+  gst_video_info_from_caps(&mVideoInfo, caps);
+  mFormat = mVideoInfo.finfo->format;
+  mPicture.width = mVideoInfo.width;
+  mPicture.height = mVideoInfo.height;
+#else
   GstCaps* caps = gst_pad_get_negotiated_caps(sinkpad);
   gst_video_format_parse_caps(caps, &mFormat, &mPicture.width, &mPicture.height);
+#endif
   GstStructure* structure = gst_caps_get_structure(caps, 0);
   gst_structure_get_fraction(structure, "framerate", &fpsNum, &fpsDen);
   NS_ASSERTION(mPicture.width && mPicture.height, "invalid video resolution");
@@ -1061,6 +1044,7 @@
   /* We have a new video buffer queued in the video sink. Increment the counter
    * and notify the decode thread potentially blocked in DecodeVideoFrame
    */
+
   mDecoder->NotifyDecodedFrames(1, 0);
   mVideoSinkBufferCount++;
   mon.NotifyAll();
@@ -1197,5 +1181,199 @@
   }
 }
 
+#if GST_VERSION_MAJOR >= 1
+GstCaps* GStreamerReader::BuildAudioSinkCaps()
+{
+  GstCaps* caps = gst_caps_from_string("audio/x-raw, channels={1,2}");
+  const char* format;
+#ifdef MOZ_SAMPLE_TYPE_FLOAT32
+#ifdef IS_LITTLE_ENDIAN
+  format = "F32LE";
+#else
+  format = "F32BE";
+#endif
+#else /* !MOZ_SAMPLE_TYPE_FLOAT32 */
+#ifdef IS_LITTLE_ENDIAN
+  format = "S16LE";
+#else
+  format = "S16BE";
+#endif
+#endif
+  gst_caps_set_simple(caps, "format", G_TYPE_STRING, format, nullptr);
+
+  return caps;
+}
+
+void GStreamerReader::InstallPadCallbacks()
+{
+  GstPad* sinkpad = gst_element_get_static_pad(GST_ELEMENT(mVideoAppSink), "sink");
+
+  gst_pad_add_probe(sinkpad,
+      (GstPadProbeType) (GST_PAD_PROBE_TYPE_SCHEDULING |
+        GST_PAD_PROBE_TYPE_EVENT_DOWNSTREAM |
+        GST_PAD_PROBE_TYPE_EVENT_UPSTREAM |
+        GST_PAD_PROBE_TYPE_EVENT_FLUSH),
+      &GStreamerReader::EventProbeCb, this, nullptr);
+  gst_pad_add_probe(sinkpad, GST_PAD_PROBE_TYPE_QUERY_DOWNSTREAM,
+      GStreamerReader::QueryProbeCb, nullptr, nullptr);
+
+  gst_pad_set_element_private(sinkpad, this);
+  gst_object_unref(sinkpad);
+
+  sinkpad = gst_element_get_static_pad(GST_ELEMENT(mAudioAppSink), "sink");
+  gst_pad_add_probe(sinkpad,
+      (GstPadProbeType) (GST_PAD_PROBE_TYPE_SCHEDULING |
+        GST_PAD_PROBE_TYPE_EVENT_DOWNSTREAM |
+        GST_PAD_PROBE_TYPE_EVENT_UPSTREAM |
+        GST_PAD_PROBE_TYPE_EVENT_FLUSH),
+      &GStreamerReader::EventProbeCb, this, nullptr);
+  gst_object_unref(sinkpad);
+}
+
+GstPadProbeReturn GStreamerReader::EventProbeCb(GstPad *aPad,
+                                                GstPadProbeInfo *aInfo,
+                                                gpointer aUserData)
+{
+  GStreamerReader *reader = (GStreamerReader *) aUserData;
+  GstEvent *aEvent = (GstEvent *)aInfo->data;
+  return reader->EventProbe(aPad, aEvent);
+}
+
+GstPadProbeReturn GStreamerReader::EventProbe(GstPad *aPad, GstEvent *aEvent)
+{
+  GstElement* parent = GST_ELEMENT(gst_pad_get_parent(aPad));
+
+  LOG(PR_LOG_DEBUG, "event probe %s", GST_EVENT_TYPE_NAME (aEvent));
+
+  switch(GST_EVENT_TYPE(aEvent)) {
+    case GST_EVENT_SEGMENT:
+    {
+      const GstSegment *newSegment;
+      GstSegment* segment;
+
+      /* Store the segments so we can convert timestamps to stream time, which
+       * is what the upper layers sync on.
+       */
+      ReentrantMonitorAutoEnter mon(mGstThreadsMonitor);
+#if GST_VERSION_MINOR <= 1 && GST_VERSION_MICRO < 1
+      ResetDecode();
+#endif
+      gst_event_parse_segment(aEvent, &newSegment);
+      if (parent == GST_ELEMENT(mVideoAppSink))
+        segment = &mVideoSegment;
+      else
+        segment = &mAudioSegment;
+      gst_segment_copy_into (newSegment, segment);
+      break;
+    }
+    case GST_EVENT_FLUSH_STOP:
+      /* Reset on seeks */
+      ResetDecode();
+      break;
+    default:
+      break;
+  }
+  gst_object_unref(parent);
+
+  return GST_PAD_PROBE_OK;
+}
+
+GstPadProbeReturn GStreamerReader::QueryProbeCb(GstPad* aPad, GstPadProbeInfo* aInfo, gpointer aUserData)
+{
+  GStreamerReader* reader = reinterpret_cast<GStreamerReader*>(gst_pad_get_element_private(aPad));
+  return reader->QueryProbe(aPad, aInfo, aUserData);
+}
+
+GstPadProbeReturn GStreamerReader::QueryProbe(GstPad* aPad, GstPadProbeInfo* aInfo, gpointer aUserData)
+{
+  GstQuery *query = gst_pad_probe_info_get_query(aInfo);
+  GstPadProbeReturn ret = GST_PAD_PROBE_OK;
+
+  switch (GST_QUERY_TYPE (query)) {
+    case GST_QUERY_ALLOCATION:
+      GstCaps *caps;
+      GstVideoInfo info;
+      gboolean need_pool;
+
+      gst_query_parse_allocation(query, &caps, &need_pool);
+      gst_video_info_init(&info);
+      gst_video_info_from_caps(&info, caps);
+      gst_query_add_allocation_param(query, mAllocator, nullptr);
+      gst_query_add_allocation_pool(query, mBufferPool, info.size, 0, 0);
+      gst_query_add_allocation_meta(query, GST_VIDEO_META_API_TYPE, nullptr);
+      break;
+    default:
+      break;
+  }
+
+  return ret;
+}
+
+void GStreamerReader::ImageDataFromVideoFrame(GstVideoFrame *aFrame,
+                                              PlanarYCbCrImage::Data *aData)
+{
+  NS_ASSERTION(GST_VIDEO_INFO_IS_YUV(&mVideoInfo),
+               "Non-YUV video frame formats not supported");
+  NS_ASSERTION(GST_VIDEO_FRAME_N_COMPONENTS(aFrame) == 3,
+               "Unsupported number of components in video frame");
+
+  aData->mPicX = aData->mPicY = 0;
+  aData->mPicSize = nsIntSize(mPicture.width, mPicture.height);
+  aData->mStereoMode = STEREO_MODE_MONO;
+
+  aData->mYChannel = GST_VIDEO_FRAME_COMP_DATA(aFrame, 0);
+  aData->mYStride = GST_VIDEO_FRAME_COMP_STRIDE(aFrame, 0);
+  aData->mYSize = nsIntSize(GST_VIDEO_FRAME_COMP_WIDTH(aFrame, 0),
+                          GST_VIDEO_FRAME_COMP_HEIGHT(aFrame, 0));
+  aData->mYSkip = GST_VIDEO_FRAME_COMP_PSTRIDE(aFrame, 0) - 1;
+  aData->mCbCrStride = GST_VIDEO_FRAME_COMP_STRIDE(aFrame, 1);
+  aData->mCbCrSize = nsIntSize(GST_VIDEO_FRAME_COMP_WIDTH(aFrame, 1),
+                             GST_VIDEO_FRAME_COMP_HEIGHT(aFrame, 1));
+  aData->mCbChannel = GST_VIDEO_FRAME_COMP_DATA(aFrame, 1);
+  aData->mCrChannel = GST_VIDEO_FRAME_COMP_DATA(aFrame, 2);
+  aData->mCbSkip = GST_VIDEO_FRAME_COMP_PSTRIDE(aFrame, 1) - 1;
+  aData->mCrSkip = GST_VIDEO_FRAME_COMP_PSTRIDE(aFrame, 2) - 1;
+}
+
+nsRefPtr<PlanarYCbCrImage> GStreamerReader::GetImageFromBuffer(GstBuffer* aBuffer)
+{
+  nsRefPtr<PlanarYCbCrImage> image = nullptr;
+
+  if (gst_buffer_n_memory(aBuffer) == 1) {
+    GstMemory* mem = gst_buffer_peek_memory(aBuffer, 0);
+    if (GST_IS_MOZ_GFX_MEMORY_ALLOCATOR(mem->allocator)) {
+      image = moz_gfx_memory_get_image(mem);
+
+      GstVideoFrame frame;
+      gst_video_frame_map(&frame, &mVideoInfo, aBuffer, GST_MAP_READ);
+      PlanarYCbCrImage::Data data;
+      ImageDataFromVideoFrame(&frame, &data);
+      image->SetDataNoCopy(data);
+      gst_video_frame_unmap(&frame);
+    }
+  }
+
+  return image;
+}
+
+void GStreamerReader::CopyIntoImageBuffer(GstBuffer* aBuffer,
+                                          GstBuffer** aOutBuffer,
+                                          nsRefPtr<PlanarYCbCrImage> &image)
+{
+  *aOutBuffer = gst_buffer_new_allocate(mAllocator, gst_buffer_get_size(aBuffer), nullptr);
+  GstMemory *mem = gst_buffer_peek_memory(*aOutBuffer, 0);
+  GstMapInfo map_info;
+  gst_memory_map(mem, &map_info, GST_MAP_WRITE);
+  gst_buffer_extract(aBuffer, 0, map_info.data, gst_buffer_get_size(aBuffer));
+  gst_memory_unmap(mem, &map_info);
+
+  /* create a new gst buffer with the newly created memory and copy the
+   * metadata over from the incoming buffer */
+  gst_buffer_copy_into(*aOutBuffer, aBuffer,
+      (GstBufferCopyFlags)(GST_BUFFER_COPY_METADATA), 0, -1);
+  image = GetImageFromBuffer(*aOutBuffer);
+}
+#endif
+
 } // namespace mozilla
 
diff -ruN comm-release/mozilla/content/media/gstreamer/GStreamerReader.h comm-patched/mozilla/content/media/gstreamer/GStreamerReader.h
--- comm-release/mozilla/content/media/gstreamer/GStreamerReader.h	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/GStreamerReader.h	2014-04-27 14:07:20.237961782 +0100
@@ -22,6 +22,7 @@
 
 #include "MediaDecoderReader.h"
 #include "MP3FrameParser.h"
+#include "ImageContainer.h"
 #include "nsRect.h"
 
 namespace mozilla {
@@ -30,10 +31,6 @@
 class TimeRanges;
 }
 
-namespace layers {
-class PlanarYCbCrImage;
-}
-
 class AbstractMediaDecoder;
 
 class GStreamerReader : public MediaDecoderReader
@@ -67,10 +64,20 @@
     return mInfo.HasVideo();
   }
 
+  layers::ImageContainer* GetImageContainer() { return mDecoder->GetImageContainer(); }
+
 private:
 
   void ReadAndPushData(guint aLength);
   int64_t QueryDuration();
+  nsRefPtr<layers::PlanarYCbCrImage> GetImageFromBuffer(GstBuffer* aBuffer);
+  void CopyIntoImageBuffer(GstBuffer *aBuffer, GstBuffer** aOutBuffer, nsRefPtr<layers::PlanarYCbCrImage> &image);
+  GstCaps* BuildAudioSinkCaps();
+  void InstallPadCallbacks();
+
+#if GST_VERSION_MAJOR >= 1
+  void ImageDataFromVideoFrame(GstVideoFrame *aFrame, layers::PlanarYCbCrImage::Data *aData);
+#endif
 
   /* Called once the pipeline is setup to check that the stream only contains
    * supported formats
@@ -105,20 +112,31 @@
   gboolean SeekData(GstAppSrc* aSrc, guint64 aOffset);
 
   /* Called when events reach the sinks. See inline comments */
+#if GST_VERSION_MAJOR == 1
+  static GstPadProbeReturn EventProbeCb(GstPad *aPad, GstPadProbeInfo *aInfo, gpointer aUserData);
+  GstPadProbeReturn EventProbe(GstPad *aPad, GstEvent *aEvent);
+#else
   static gboolean EventProbeCb(GstPad* aPad, GstEvent* aEvent, gpointer aUserData);
   gboolean EventProbe(GstPad* aPad, GstEvent* aEvent);
+#endif
 
-  /* Called when elements in the video branch of the pipeline call
-   * gst_pad_alloc_buffer(). Used to provide PlanarYCbCrImage backed GstBuffers
-   * to the pipeline so that a memory copy can be avoided when handling YUV
-   * buffers from the pipeline to the gfx side.
-   */
+  /* Called when the video part of the pipeline allocates buffers. Used to
+   * provide PlanarYCbCrImage backed GstBuffers to the pipeline so that a memory
+   * copy can be avoided when handling YUV buffers from the pipeline to the gfx
+   * side.
+   */
+#if GST_VERSION_MAJOR == 1
+  static GstPadProbeReturn QueryProbeCb(GstPad *aPad, GstPadProbeInfo *aInfo, gpointer aUserData);
+  GstPadProbeReturn QueryProbe(GstPad *aPad, GstPadProbeInfo *aInfo, gpointer aUserData);
+#else
   static GstFlowReturn AllocateVideoBufferCb(GstPad* aPad, guint64 aOffset, guint aSize,
                                              GstCaps* aCaps, GstBuffer** aBuf);
   GstFlowReturn AllocateVideoBufferFull(GstPad* aPad, guint64 aOffset, guint aSize,
                                      GstCaps* aCaps, GstBuffer** aBuf, nsRefPtr<layers::PlanarYCbCrImage>& aImage);
   GstFlowReturn AllocateVideoBuffer(GstPad* aPad, guint64 aOffset, guint aSize,
                                      GstCaps* aCaps, GstBuffer** aBuf);
+#endif
+
 
   /* Called when the pipeline is prerolled, that is when at start or after a
    * seek, the first audio and video buffers are queued in the sinks.
@@ -167,6 +185,11 @@
   bool mUseParserDuration;
   int64_t mLastParserDuration;
 
+#if GST_VERSION_MAJOR >= 1
+  GstAllocator *mAllocator;
+  GstBufferPool *mBufferPool;
+  GstVideoInfo mVideoInfo;
+#endif
   GstElement* mPlayBin;
   GstBus* mBus;
   GstAppSrc* mSource;
@@ -197,6 +220,9 @@
    * DecodeAudioData and DecodeVideoFrame should not expect any more data
    */
   bool mReachedEos;
+#if GST_VERSION_MAJOR >= 1
+  bool mConfigureAlignment;
+#endif
   int fpsNum;
   int fpsDen;
 };
diff -ruN comm-release/mozilla/content/media/gstreamer/moz.build comm-patched/mozilla/content/media/gstreamer/moz.build
--- comm-release/mozilla/content/media/gstreamer/moz.build	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/gstreamer/moz.build	2014-04-27 14:07:20.238186497 +0100
@@ -15,10 +15,19 @@
     'GStreamerDecoder.cpp',
     'GStreamerFormatHelper.cpp',
     'GStreamerLoader.cpp',
-    'GStreamerMozVideoBuffer.cpp',
     'GStreamerReader.cpp',
 ]
 
+if CONFIG['GST_API_VERSION'] == '1.0':
+    SOURCES += [
+        'GStreamerAllocator.cpp',
+    ]
+else:
+    SOURCES += [
+        'GStreamerMozVideoBuffer.cpp',
+        'GStreamerReader-0.10.cpp',
+    ]
+
 FAIL_ON_WARNINGS = True
 
 FINAL_LIBRARY = 'gklayout'
diff -ruN comm-release/mozilla/content/media/test/manifest.js comm-patched/mozilla/content/media/test/manifest.js
--- comm-release/mozilla/content/media/test/manifest.js	2014-03-19 01:41:47.000000000 +0000
+++ comm-patched/mozilla/content/media/test/manifest.js	2014-04-27 14:07:20.238822611 +0100
@@ -357,9 +357,9 @@
   { name:"bogus.duh", type:"bogus/duh"}
 ];
 // Unfortunately big-buck-bunny-unseekable.mp4 is doesn't play on Windows 7, so
-// only include it in the unseekable tests if we're on later versions of Windows.
-if (navigator.userAgent.indexOf("Windows") == -1 ||
-    IsWindows8OrLater()) {
+// only include it in the unseekable tests if we're on later versions of Windows. 
+// This test actually only passes on win8 at the moment.
+if (navigator.userAgent.indexOf("Windows") != -1 && IsWindows8OrLater()) {
   gUnseekableTests = gUnseekableTests.concat([
     { name:"big-buck-bunny-unseekable.mp4", type:"video/mp4" }
   ]);
diff -ruN comm-release/mozilla/dom/plugins/ipc/PluginModuleChild.cpp comm-patched/mozilla/dom/plugins/ipc/PluginModuleChild.cpp
--- comm-release/mozilla/dom/plugins/ipc/PluginModuleChild.cpp	2014-03-19 01:41:50.000000000 +0000
+++ comm-patched/mozilla/dom/plugins/ipc/PluginModuleChild.cpp	2014-04-27 14:07:20.239580420 +0100
@@ -197,7 +197,7 @@
 
     // TODO: use PluginPRLibrary here
 
-#if defined(OS_LINUX) || defined(OS_BSD)
+#if defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
     mShutdownFunc =
         (NP_PLUGINSHUTDOWN) PR_FindFunctionSymbol(mLibrary, "NP_Shutdown");
 
@@ -1825,7 +1825,7 @@
     PLUGIN_LOG_DEBUG_METHOD;
     AssertPluginThread();
 
-#if defined(OS_LINUX) || defined(OS_BSD)
+#if defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
     return true;
 #elif defined(OS_WIN) || defined(OS_MACOSX)
     *_retval = mGetEntryPointsFunc(&mFunctions);
@@ -1854,7 +1854,7 @@
     SendBackUpXResources(FileDescriptor(xSocketFd));
 #endif
 
-#if defined(OS_LINUX) || defined(OS_BSD)
+#if defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
     *_retval = mInitializeFunc(&sBrowserFuncs, &mFunctions);
     return true;
 #elif defined(OS_WIN) || defined(OS_MACOSX)
diff -ruN comm-release/mozilla/dom/plugins/ipc/PluginModuleChild.h comm-patched/mozilla/dom/plugins/ipc/PluginModuleChild.h
--- comm-release/mozilla/dom/plugins/ipc/PluginModuleChild.h	2014-03-19 01:41:50.000000000 +0000
+++ comm-patched/mozilla/dom/plugins/ipc/PluginModuleChild.h	2014-04-27 14:07:20.240019455 +0100
@@ -329,7 +329,7 @@
 
     // we get this from the plugin
     NP_PLUGINSHUTDOWN mShutdownFunc;
-#if defined(OS_LINUX) || defined(OS_BSD)
+#if defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
     NP_PLUGINUNIXINIT mInitializeFunc;
 #elif defined(OS_WIN) || defined(OS_MACOSX)
     NP_PLUGININIT mInitializeFunc;
diff -ruN comm-release/mozilla/dom/system/OSFileConstants.cpp comm-patched/mozilla/dom/system/OSFileConstants.cpp
--- comm-release/mozilla/dom/system/OSFileConstants.cpp	2014-03-19 01:41:50.000000000 +0000
+++ comm-patched/mozilla/dom/system/OSFileConstants.cpp	2014-04-27 14:07:20.240499318 +0100
@@ -9,11 +9,15 @@
 
 #include "prsystem.h"
 
+#if defined(__NetBSD__)
+#include <sys/param.h>
+#endif
+
 #if defined(XP_UNIX)
 #include "unistd.h"
 #include "dirent.h"
 #include "sys/stat.h"
-#if !defined(ANDROID)
+#if !defined(ANDROID) && (defined(__NetBSD_) && (__NetBSD_Version__ < 600000000))
 #include <spawn.h>
 #endif // !defined(ANDROID)
 #endif // defined(XP_UNIX)
@@ -508,7 +512,7 @@
   // The size of |time_t|.
   { "OSFILE_SIZEOF_TIME_T", INT_TO_JSVAL(sizeof (time_t)) },
 
-#if !defined(ANDROID)
+#if !defined(ANDROID) && (defined(__NetBSD_) && (__NetBSD_Version__ < 600000000))
   // The size of |posix_spawn_file_actions_t|.
   { "OSFILE_SIZEOF_POSIX_SPAWN_FILE_ACTIONS_T", INT_TO_JSVAL(sizeof (posix_spawn_file_actions_t)) },
 #endif // !defined(ANDROID)
diff -ruN comm-release/mozilla/extensions/spellcheck/hunspell/src/mozHunspell.cpp comm-patched/mozilla/extensions/spellcheck/hunspell/src/mozHunspell.cpp
--- comm-release/mozilla/extensions/spellcheck/hunspell/src/mozHunspell.cpp	2014-03-19 01:41:52.000000000 +0000
+++ comm-patched/mozilla/extensions/spellcheck/hunspell/src/mozHunspell.cpp	2014-04-27 14:07:20.240927175 +0100
@@ -413,6 +413,12 @@
     }
   }
 
+  // load system hunspell dictionaries
+  nsIFile* hunDir;
+  NS_NewNativeLocalFile(NS_LITERAL_CSTRING("@PREFIX@/share/hunspell"),
+			true, &hunDir);
+  LoadDictionariesFromDir(hunDir);
+
   // find dictionaries from extensions requiring restart
   nsCOMPtr<nsISimpleEnumerator> dictDirs;
   rv = dirSvc->Get(DICTIONARY_SEARCH_DIRECTORY_LIST,
diff -ruN comm-release/mozilla/gfx/angle/src/compiler/osinclude.h comm-patched/mozilla/gfx/angle/src/compiler/osinclude.h
--- comm-release/mozilla/gfx/angle/src/compiler/osinclude.h	2014-03-19 01:41:53.000000000 +0000
+++ comm-patched/mozilla/gfx/angle/src/compiler/osinclude.h	2014-04-27 14:07:20.220869700 +0100
@@ -16,6 +16,7 @@
 #define ANGLE_OS_WIN
 #elif defined(__APPLE__) || defined(__linux__) || \
       defined(__FreeBSD__) || defined(__OpenBSD__) || \
+      defined(__NetBSD__) || defined(__DragonFly__) || \
       defined(__sun) || defined(ANDROID) || \
       defined(__GLIBC__) || defined(__GNU__) || \
       defined(__QNX__)
diff -ruN comm-release/mozilla/gfx/graphite2/src/Bidi.cpp comm-patched/mozilla/gfx/graphite2/src/Bidi.cpp
--- comm-release/mozilla/gfx/graphite2/src/Bidi.cpp	2014-03-19 01:41:53.000000000 +0000
+++ comm-patched/mozilla/gfx/graphite2/src/Bidi.cpp	2014-04-27 14:07:20.241359243 +0100
@@ -30,6 +30,11 @@
 
 using namespace graphite2;
 
+#ifdef __sun
+#undef CS
+#undef ES
+#endif
+
 enum DirCode {  // Hungarian: dirc
         Unk        = -1,
         N          =  0,   // other neutrals (default) - ON
diff -ruN comm-release/mozilla/gfx/moz.build comm-patched/mozilla/gfx/moz.build
--- comm-release/mozilla/gfx/moz.build	2014-03-19 01:41:53.000000000 +0000
+++ comm-patched/mozilla/gfx/moz.build	2014-04-27 14:07:20.241612468 +0100
@@ -7,6 +7,12 @@
 if CONFIG['MOZ_TREE_CAIRO']:
     DIRS += ['cairo']
 
+if not CONFIG['MOZ_NATIVE_GRAPHITE2']:
+    DIRS += ['graphite2/src' ]
+
+if not CONFIG['MOZ_NATIVE_HARFBUZZ']:
+    DIRS += ['harfbuzz/src']
+
 DIRS += [
     '2d',
     'ycbcr',
@@ -15,8 +21,6 @@
     'qcms',
     'gl',
     'layers',
-    'graphite2/src',
-    'harfbuzz/src',
     'ots/src',
     'thebes',
     'ipc',
diff -ruN comm-release/mozilla/gfx/skia/Makefile.in comm-patched/mozilla/gfx/skia/Makefile.in
--- comm-release/mozilla/gfx/skia/Makefile.in	2014-03-19 01:41:53.000000000 +0000
+++ comm-patched/mozilla/gfx/skia/Makefile.in	2014-04-27 14:07:20.242221517 +0100
@@ -34,6 +34,10 @@
 OS_CXXFLAGS += $(MOZ_CAIRO_CFLAGS) $(MOZ_PANGO_CFLAGS) $(CAIRO_FT_CFLAGS)
 endif
 
+ifdef MOZ_NATIVE_HARFBUZZ
+OS_CXXFLAGS += $(MOZ_HARFBUZZ_CFLAGS)
+endif
+
 include $(topsrcdir)/config/rules.mk
 
 ifneq (,$(INTEL_ARCHITECTURE))
diff -ruN comm-release/mozilla/gfx/skia/include/core/SkPreConfig.h comm-patched/mozilla/gfx/skia/include/core/SkPreConfig.h
--- comm-release/mozilla/gfx/skia/include/core/SkPreConfig.h	2014-03-19 01:41:53.000000000 +0000
+++ comm-patched/mozilla/gfx/skia/include/core/SkPreConfig.h	2014-04-27 14:07:20.241979253 +0100
@@ -100,7 +100,7 @@
 
 #if !defined(SK_CPU_BENDIAN) && !defined(SK_CPU_LENDIAN)
     #if defined (__ppc__) || defined(__PPC__) || defined(__ppc64__) \
-        || defined(__PPC64__)
+        || defined(__PPC64__) || defined(__sparc) || defined(__sparc__)
         #define SK_CPU_BENDIAN
     #else
         #define SK_CPU_LENDIAN
diff -ruN comm-release/mozilla/gfx/skia/moz.build comm-patched/mozilla/gfx/skia/moz.build
--- comm-release/mozilla/gfx/skia/moz.build	2014-03-19 01:41:53.000000000 +0000
+++ comm-patched/mozilla/gfx/skia/moz.build	2014-04-27 14:07:20.242575294 +0100
@@ -209,7 +209,7 @@
         'src/ports/SkFontHost_cairo.cpp',
         'src/ports/SkFontHost_FreeType_common.cpp',
     ]
-    if CONFIG['OS_TARGET'] == 'Linux':
+    if CONFIG['MOZ_X11'] == 1 or CONFIG['OS_TARGET'] == 'Linux':
         EXPORTS.skia += [
             'include/ports/SkTypeface_cairo.h',
         ]
diff -ruN comm-release/mozilla/gfx/skia/src/utils/SkThreadUtils_pthread_linux.cpp comm-patched/mozilla/gfx/skia/src/utils/SkThreadUtils_pthread_linux.cpp
--- comm-release/mozilla/gfx/skia/src/utils/SkThreadUtils_pthread_linux.cpp	2014-03-19 01:41:54.000000000 +0000
+++ comm-patched/mozilla/gfx/skia/src/utils/SkThreadUtils_pthread_linux.cpp	2014-04-27 14:07:20.242875234 +0100
@@ -12,26 +12,47 @@
 #include "SkThreadUtils.h"
 #include "SkThreadUtils_pthread.h"
 
+#include <unistd.h>
 #include <pthread.h>
 #ifdef __FreeBSD__
 #include <pthread_np.h>
 #endif
+#ifdef __NetBSD__
+#include <sched.h>
+#endif
 
 #if defined(__FreeBSD__) || defined(__NetBSD__)
 #define cpu_set_t cpuset_t
 #endif
 
-#ifndef CPU_COUNT
+#if !defined(CPU_COUNT) && !defined(__NetBSD__)
 static int CPU_COUNT(cpu_set_t *set) {
     int count = 0;
     for (int i = 0; i < CPU_SETSIZE; i++) {
         if (CPU_ISSET(i, set)) {
             count++;
-	}
+        }
+    }
+    return count;
+}
+#endif
+
+#if defined(__NetBSD__)
+
+#define CPU_ISSET(c, s) cpuset_isset(c, s)
+
+static int CPU_COUNT(cpuset_t *set) {
+    static const int ncpu = sysconf(_SC_NPROCESSORS_CONF);
+    int count = 0;
+
+    for (int i = 0; i < ncpu; i++) {
+        if (cpuset_isset(i, set)) {
+            count++;
+        }
     }
     return count;
 }
-#endif /* !CPU_COUNT */
+#endif
 
 static int nth_set_cpu(unsigned int n, cpu_set_t* cpuSet) {
     n %= CPU_COUNT(cpuSet);
@@ -51,6 +72,7 @@
         return false;
     }
 
+#if !defined(__NetBSD__)
     cpu_set_t parentCpuset;
     if (0 != pthread_getaffinity_np(pthread_self(), sizeof(cpu_set_t), &parentCpuset)) {
         return false;
@@ -62,4 +84,23 @@
     return 0 == pthread_setaffinity_np(pthreadData->fPThread,
                                        sizeof(cpu_set_t),
                                        &cpuset);
+#else
+    cpuset_t *cpuset = cpuset_create();
+    if (!cpuset) {
+        return false;
+    }
+    size_t csize = cpuset_size(cpuset);
+    if (0 != pthread_getaffinity_np(pthread_self(), csize, cpuset)) {
+        cpuset_destroy(cpuset);
+        return false;
+    }
+
+    int nthcpu = nth_set_cpu(processor, cpuset);
+    cpuset_zero(cpuset);
+    cpuset_set(nthcpu, cpuset);
+
+    bool ok = 0 == pthread_setaffinity_np(pthreadData->fPThread, csize, cpuset);
+    cpuset_destroy(cpuset);
+    return ok;
+#endif
 }
diff -ruN comm-release/mozilla/gfx/thebes/Makefile.in comm-patched/mozilla/gfx/thebes/Makefile.in
--- comm-release/mozilla/gfx/thebes/Makefile.in	2014-03-19 01:41:54.000000000 +0000
+++ comm-patched/mozilla/gfx/thebes/Makefile.in	2014-04-27 14:07:20.243131074 +0100
@@ -13,6 +13,14 @@
 CXXFLAGS += $(MOZ_CAIRO_CFLAGS) $(MOZ_PIXMAN_CFLAGS) $(TK_CFLAGS)
 CFLAGS += $(MOZ_CAIRO_CFLAGS) $(MOZ_PIXMAN_CFLAGS) $(TK_CFLAGS)
 
+ifdef MOZ_NATIVE_GRAPHITE2
+CXXFLAGS += $(MOZ_GRAPHITE2_CFLAGS)
+endif
+
+ifdef MOZ_NATIVE_HARFBUZZ
+CXXFLAGS += $(MOZ_HARFBUZZ_CFLAGS)
+endif
+
 ifeq ($(MOZ_WIDGET_TOOLKIT),android)
 CXXFLAGS += $(CAIRO_FT_CFLAGS)
 endif
diff -ruN comm-release/mozilla/image/decoders/nsJPEGDecoder.cpp comm-patched/mozilla/image/decoders/nsJPEGDecoder.cpp
--- comm-release/mozilla/image/decoders/nsJPEGDecoder.cpp	2014-03-19 01:41:54.000000000 +0000
+++ comm-patched/mozilla/image/decoders/nsJPEGDecoder.cpp	2014-04-27 14:07:20.243908716 +0100
@@ -21,13 +21,28 @@
 
 extern "C" {
 #include "iccjpeg.h"
-}
 
+#ifdef JCS_EXTENSIONS
 #if defined(IS_BIG_ENDIAN)
 #define MOZ_JCS_EXT_NATIVE_ENDIAN_XRGB JCS_EXT_XRGB
 #else
 #define MOZ_JCS_EXT_NATIVE_ENDIAN_XRGB JCS_EXT_BGRX
 #endif
+#else
+/* Colorspace conversion (copied from jpegint.h) */
+struct jpeg_color_deconverter {
+  JMETHOD(void, start_pass, (j_decompress_ptr cinfo));
+  JMETHOD(void, color_convert, (j_decompress_ptr cinfo,
+				JSAMPIMAGE input_buf, JDIMENSION input_row,
+				JSAMPARRAY output_buf, int num_rows));
+};
+
+METHODDEF(void)
+ycc_rgb_convert_argb (j_decompress_ptr cinfo,
+                 JSAMPIMAGE input_buf, JDIMENSION input_row,
+                 JSAMPARRAY output_buf, int num_rows);
+#endif
+}
 
 static void cmyk_convert_rgb(JSAMPROW row, JDIMENSION width);
 
@@ -345,6 +360,7 @@
       case JCS_GRAYSCALE:
       case JCS_RGB:
       case JCS_YCbCr:
+#ifdef JCS_EXTENSIONS
         // if we're not color managing we can decode directly to
         // MOZ_JCS_EXT_NATIVE_ENDIAN_XRGB
         if (mCMSMode != eCMSMode_All) {
@@ -353,6 +369,9 @@
         } else {
             mInfo.out_color_space = JCS_RGB;
         }
+#else
+        mInfo.out_color_space = JCS_RGB;
+#endif
         break;
       case JCS_CMYK:
       case JCS_YCCK:
@@ -414,6 +433,15 @@
       return; /* I/O suspension */
     }
 
+#ifndef JCS_EXTENSIONS
+    /* Force to use our YCbCr to Packed RGB converter when possible */
+    if (!mTransform && (mCMSMode != eCMSMode_All) &&
+        mInfo.jpeg_color_space == JCS_YCbCr && mInfo.out_color_space == JCS_RGB) {
+      /* Special case for the most common case: transform from YCbCr direct into packed ARGB */
+      mInfo.out_color_components = 4; /* Packed ARGB pixels are always 4 bytes...*/
+      mInfo.cconvert->color_convert = ycc_rgb_convert_argb;
+    }
+#endif
 
     /* If this is a progressive JPEG ... */
     mState = mInfo.buffered_image ? JPEG_DECOMPRESS_PROGRESSIVE : JPEG_DECOMPRESS_SEQUENTIAL;
@@ -580,7 +608,11 @@
       uint32_t *imageRow = ((uint32_t*)mImageData) +
                            (mInfo.output_scanline * mInfo.output_width);
 
+#ifdef JCS_EXTENSIONS
       if (mInfo.out_color_space == MOZ_JCS_EXT_NATIVE_ENDIAN_XRGB) {
+#else
+      if (mInfo.cconvert->color_convert == ycc_rgb_convert_argb) {
+#endif
         /* Special case: scanline will be directly converted into packed ARGB */
         if (jpeg_read_scanlines(&mInfo, (JSAMPARRAY)&imageRow, 1) != 1) {
           *suspend = true; /* suspend */
@@ -890,6 +922,282 @@
 } // namespace mozilla
 
 
+#ifndef JCS_EXTENSIONS
+/**************** YCbCr -> Cairo's RGB24/ARGB32 conversion: most common case **************/
+
+/*
+ * YCbCr is defined per CCIR 601-1, except that Cb and Cr are
+ * normalized to the range 0..MAXJSAMPLE rather than -0.5 .. 0.5.
+ * The conversion equations to be implemented are therefore
+ *      R = Y                + 1.40200 * Cr
+ *      G = Y - 0.34414 * Cb - 0.71414 * Cr
+ *      B = Y + 1.77200 * Cb
+ * where Cb and Cr represent the incoming values less CENTERJSAMPLE.
+ * (These numbers are derived from TIFF 6.0 section 21, dated 3-June-92.)
+ *
+ * To avoid floating-point arithmetic, we represent the fractional constants
+ * as integers scaled up by 2^16 (about 4 digits precision); we have to divide
+ * the products by 2^16, with appropriate rounding, to get the correct answer.
+ * Notice that Y, being an integral input, does not contribute any fraction
+ * so it need not participate in the rounding.
+ *
+ * For even more speed, we avoid doing any multiplications in the inner loop
+ * by precalculating the constants times Cb and Cr for all possible values.
+ * For 8-bit JSAMPLEs this is very reasonable (only 256 entries per table);
+ * for 12-bit samples it is still acceptable.  It's not very reasonable for
+ * 16-bit samples, but if you want lossless storage you shouldn't be changing
+ * colorspace anyway.
+ * The Cr=>R and Cb=>B values can be rounded to integers in advance; the
+ * values for the G calculation are left scaled up, since we must add them
+ * together before rounding.
+ */
+
+#define SCALEBITS       16      /* speediest right-shift on some machines */
+
+/* Use static tables for color processing. */
+/* Four tables, each 256 entries of 4 bytes totals 4K which is not bad... */
+
+const int Cr_r_tab[(MAXJSAMPLE+1) * sizeof(int)] ={
+       -0xb3,       -0xb2,       -0xb1,       -0xaf,       -0xae,       -0xac,
+       -0xab,       -0xaa,       -0xa8,       -0xa7,       -0xa5,       -0xa4,
+       -0xa3,       -0xa1,       -0xa0,       -0x9e,       -0x9d,       -0x9c,
+       -0x9a,       -0x99,       -0x97,       -0x96,       -0x95,       -0x93,
+       -0x92,       -0x90,       -0x8f,       -0x8e,       -0x8c,       -0x8b,
+       -0x89,       -0x88,       -0x87,       -0x85,       -0x84,       -0x82,
+       -0x81,       -0x80,       -0x7e,       -0x7d,       -0x7b,       -0x7a,
+       -0x79,       -0x77,       -0x76,       -0x74,       -0x73,       -0x72,
+       -0x70,       -0x6f,       -0x6d,       -0x6c,       -0x6b,       -0x69,
+       -0x68,       -0x66,       -0x65,       -0x64,       -0x62,       -0x61,
+       -0x5f,       -0x5e,       -0x5d,       -0x5b,       -0x5a,       -0x58,
+       -0x57,       -0x56,       -0x54,       -0x53,       -0x51,       -0x50,
+       -0x4f,       -0x4d,       -0x4c,       -0x4a,       -0x49,       -0x48,
+       -0x46,       -0x45,       -0x43,       -0x42,       -0x40,       -0x3f,
+       -0x3e,       -0x3c,       -0x3b,       -0x39,       -0x38,       -0x37,
+       -0x35,       -0x34,       -0x32,       -0x31,       -0x30,       -0x2e,
+       -0x2d,       -0x2b,       -0x2a,       -0x29,       -0x27,       -0x26,
+       -0x24,       -0x23,       -0x22,       -0x20,       -0x1f,       -0x1d,
+       -0x1c,       -0x1b,       -0x19,       -0x18,       -0x16,       -0x15,
+       -0x14,       -0x12,       -0x11,       -0x0f,       -0x0e,       -0x0d,
+       -0x0b,       -0x0a,       -0x08,       -0x07,       -0x06,       -0x04,
+       -0x03,       -0x01,        0x00,        0x01,        0x03,        0x04,
+        0x06,        0x07,        0x08,        0x0a,        0x0b,        0x0d,
+        0x0e,        0x0f,        0x11,        0x12,        0x14,        0x15,
+        0x16,        0x18,        0x19,        0x1b,        0x1c,        0x1d,
+        0x1f,        0x20,        0x22,        0x23,        0x24,        0x26,
+        0x27,        0x29,        0x2a,        0x2b,        0x2d,        0x2e,
+        0x30,        0x31,        0x32,        0x34,        0x35,        0x37,
+        0x38,        0x39,        0x3b,        0x3c,        0x3e,        0x3f,
+        0x40,        0x42,        0x43,        0x45,        0x46,        0x48,
+        0x49,        0x4a,        0x4c,        0x4d,        0x4f,        0x50,
+        0x51,        0x53,        0x54,        0x56,        0x57,        0x58,
+        0x5a,        0x5b,        0x5d,        0x5e,        0x5f,        0x61,
+        0x62,        0x64,        0x65,        0x66,        0x68,        0x69,
+        0x6b,        0x6c,        0x6d,        0x6f,        0x70,        0x72,
+        0x73,        0x74,        0x76,        0x77,        0x79,        0x7a,
+        0x7b,        0x7d,        0x7e,        0x80,        0x81,        0x82,
+        0x84,        0x85,        0x87,        0x88,        0x89,        0x8b,
+        0x8c,        0x8e,        0x8f,        0x90,        0x92,        0x93,
+        0x95,        0x96,        0x97,        0x99,        0x9a,        0x9c,
+        0x9d,        0x9e,        0xa0,        0xa1,        0xa3,        0xa4,
+        0xa5,        0xa7,        0xa8,        0xaa,        0xab,        0xac,
+        0xae,        0xaf,        0xb1,        0xb2,
+  };
+
+const int Cb_b_tab[(MAXJSAMPLE+1) * sizeof(int)] ={
+       -0xe3,       -0xe1,       -0xdf,       -0xde,       -0xdc,       -0xda,
+       -0xd8,       -0xd6,       -0xd5,       -0xd3,       -0xd1,       -0xcf,
+       -0xce,       -0xcc,       -0xca,       -0xc8,       -0xc6,       -0xc5,
+       -0xc3,       -0xc1,       -0xbf,       -0xbe,       -0xbc,       -0xba,
+       -0xb8,       -0xb7,       -0xb5,       -0xb3,       -0xb1,       -0xaf,
+       -0xae,       -0xac,       -0xaa,       -0xa8,       -0xa7,       -0xa5,
+       -0xa3,       -0xa1,       -0x9f,       -0x9e,       -0x9c,       -0x9a,
+       -0x98,       -0x97,       -0x95,       -0x93,       -0x91,       -0x90,
+       -0x8e,       -0x8c,       -0x8a,       -0x88,       -0x87,       -0x85,
+       -0x83,       -0x81,       -0x80,       -0x7e,       -0x7c,       -0x7a,
+       -0x78,       -0x77,       -0x75,       -0x73,       -0x71,       -0x70,
+       -0x6e,       -0x6c,       -0x6a,       -0x69,       -0x67,       -0x65,
+       -0x63,       -0x61,       -0x60,       -0x5e,       -0x5c,       -0x5a,
+       -0x59,       -0x57,       -0x55,       -0x53,       -0x52,       -0x50,
+       -0x4e,       -0x4c,       -0x4a,       -0x49,       -0x47,       -0x45,
+       -0x43,       -0x42,       -0x40,       -0x3e,       -0x3c,       -0x3a,
+       -0x39,       -0x37,       -0x35,       -0x33,       -0x32,       -0x30,
+       -0x2e,       -0x2c,       -0x2b,       -0x29,       -0x27,       -0x25,
+       -0x23,       -0x22,       -0x20,       -0x1e,       -0x1c,       -0x1b,
+       -0x19,       -0x17,       -0x15,       -0x13,       -0x12,       -0x10,
+       -0x0e,       -0x0c,       -0x0b,       -0x09,       -0x07,       -0x05,
+       -0x04,       -0x02,        0x00,        0x02,        0x04,        0x05,
+        0x07,        0x09,        0x0b,        0x0c,        0x0e,        0x10,
+        0x12,        0x13,        0x15,        0x17,        0x19,        0x1b,
+        0x1c,        0x1e,        0x20,        0x22,        0x23,        0x25,
+        0x27,        0x29,        0x2b,        0x2c,        0x2e,        0x30,
+        0x32,        0x33,        0x35,        0x37,        0x39,        0x3a,
+        0x3c,        0x3e,        0x40,        0x42,        0x43,        0x45,
+        0x47,        0x49,        0x4a,        0x4c,        0x4e,        0x50,
+        0x52,        0x53,        0x55,        0x57,        0x59,        0x5a,
+        0x5c,        0x5e,        0x60,        0x61,        0x63,        0x65,
+        0x67,        0x69,        0x6a,        0x6c,        0x6e,        0x70,
+        0x71,        0x73,        0x75,        0x77,        0x78,        0x7a,
+        0x7c,        0x7e,        0x80,        0x81,        0x83,        0x85,
+        0x87,        0x88,        0x8a,        0x8c,        0x8e,        0x90,
+        0x91,        0x93,        0x95,        0x97,        0x98,        0x9a,
+        0x9c,        0x9e,        0x9f,        0xa1,        0xa3,        0xa5,
+        0xa7,        0xa8,        0xaa,        0xac,        0xae,        0xaf,
+        0xb1,        0xb3,        0xb5,        0xb7,        0xb8,        0xba,
+        0xbc,        0xbe,        0xbf,        0xc1,        0xc3,        0xc5,
+        0xc6,        0xc8,        0xca,        0xcc,        0xce,        0xcf,
+        0xd1,        0xd3,        0xd5,        0xd6,        0xd8,        0xda,
+        0xdc,        0xde,        0xdf,        0xe1,
+  };
+
+const int Cr_g_tab[(MAXJSAMPLE+1) * sizeof(int)] ={
+    0x5b6900,    0x5ab22e,    0x59fb5c,    0x59448a,    0x588db8,    0x57d6e6,
+    0x572014,    0x566942,    0x55b270,    0x54fb9e,    0x5444cc,    0x538dfa,
+    0x52d728,    0x522056,    0x516984,    0x50b2b2,    0x4ffbe0,    0x4f450e,
+    0x4e8e3c,    0x4dd76a,    0x4d2098,    0x4c69c6,    0x4bb2f4,    0x4afc22,
+    0x4a4550,    0x498e7e,    0x48d7ac,    0x4820da,    0x476a08,    0x46b336,
+    0x45fc64,    0x454592,    0x448ec0,    0x43d7ee,    0x43211c,    0x426a4a,
+    0x41b378,    0x40fca6,    0x4045d4,    0x3f8f02,    0x3ed830,    0x3e215e,
+    0x3d6a8c,    0x3cb3ba,    0x3bfce8,    0x3b4616,    0x3a8f44,    0x39d872,
+    0x3921a0,    0x386ace,    0x37b3fc,    0x36fd2a,    0x364658,    0x358f86,
+    0x34d8b4,    0x3421e2,    0x336b10,    0x32b43e,    0x31fd6c,    0x31469a,
+    0x308fc8,    0x2fd8f6,    0x2f2224,    0x2e6b52,    0x2db480,    0x2cfdae,
+    0x2c46dc,    0x2b900a,    0x2ad938,    0x2a2266,    0x296b94,    0x28b4c2,
+    0x27fdf0,    0x27471e,    0x26904c,    0x25d97a,    0x2522a8,    0x246bd6,
+    0x23b504,    0x22fe32,    0x224760,    0x21908e,    0x20d9bc,    0x2022ea,
+    0x1f6c18,    0x1eb546,    0x1dfe74,    0x1d47a2,    0x1c90d0,    0x1bd9fe,
+    0x1b232c,    0x1a6c5a,    0x19b588,    0x18feb6,    0x1847e4,    0x179112,
+    0x16da40,    0x16236e,    0x156c9c,    0x14b5ca,    0x13fef8,    0x134826,
+    0x129154,    0x11da82,    0x1123b0,    0x106cde,    0x0fb60c,    0x0eff3a,
+    0x0e4868,    0x0d9196,    0x0cdac4,    0x0c23f2,    0x0b6d20,    0x0ab64e,
+    0x09ff7c,    0x0948aa,    0x0891d8,    0x07db06,    0x072434,    0x066d62,
+    0x05b690,    0x04ffbe,    0x0448ec,    0x03921a,    0x02db48,    0x022476,
+    0x016da4,    0x00b6d2,    0x000000,   -0x00b6d2,   -0x016da4,   -0x022476,
+   -0x02db48,   -0x03921a,   -0x0448ec,   -0x04ffbe,   -0x05b690,   -0x066d62,
+   -0x072434,   -0x07db06,   -0x0891d8,   -0x0948aa,   -0x09ff7c,   -0x0ab64e,
+   -0x0b6d20,   -0x0c23f2,   -0x0cdac4,   -0x0d9196,   -0x0e4868,   -0x0eff3a,
+   -0x0fb60c,   -0x106cde,   -0x1123b0,   -0x11da82,   -0x129154,   -0x134826,
+   -0x13fef8,   -0x14b5ca,   -0x156c9c,   -0x16236e,   -0x16da40,   -0x179112,
+   -0x1847e4,   -0x18feb6,   -0x19b588,   -0x1a6c5a,   -0x1b232c,   -0x1bd9fe,
+   -0x1c90d0,   -0x1d47a2,   -0x1dfe74,   -0x1eb546,   -0x1f6c18,   -0x2022ea,
+   -0x20d9bc,   -0x21908e,   -0x224760,   -0x22fe32,   -0x23b504,   -0x246bd6,
+   -0x2522a8,   -0x25d97a,   -0x26904c,   -0x27471e,   -0x27fdf0,   -0x28b4c2,
+   -0x296b94,   -0x2a2266,   -0x2ad938,   -0x2b900a,   -0x2c46dc,   -0x2cfdae,
+   -0x2db480,   -0x2e6b52,   -0x2f2224,   -0x2fd8f6,   -0x308fc8,   -0x31469a,
+   -0x31fd6c,   -0x32b43e,   -0x336b10,   -0x3421e2,   -0x34d8b4,   -0x358f86,
+   -0x364658,   -0x36fd2a,   -0x37b3fc,   -0x386ace,   -0x3921a0,   -0x39d872,
+   -0x3a8f44,   -0x3b4616,   -0x3bfce8,   -0x3cb3ba,   -0x3d6a8c,   -0x3e215e,
+   -0x3ed830,   -0x3f8f02,   -0x4045d4,   -0x40fca6,   -0x41b378,   -0x426a4a,
+   -0x43211c,   -0x43d7ee,   -0x448ec0,   -0x454592,   -0x45fc64,   -0x46b336,
+   -0x476a08,   -0x4820da,   -0x48d7ac,   -0x498e7e,   -0x4a4550,   -0x4afc22,
+   -0x4bb2f4,   -0x4c69c6,   -0x4d2098,   -0x4dd76a,   -0x4e8e3c,   -0x4f450e,
+   -0x4ffbe0,   -0x50b2b2,   -0x516984,   -0x522056,   -0x52d728,   -0x538dfa,
+   -0x5444cc,   -0x54fb9e,   -0x55b270,   -0x566942,   -0x572014,   -0x57d6e6,
+   -0x588db8,   -0x59448a,   -0x59fb5c,   -0x5ab22e,
+ };
+
+const int Cb_g_tab[(MAXJSAMPLE+1) * sizeof(int)] ={
+    0x2c8d00,    0x2c34e6,    0x2bdccc,    0x2b84b2,    0x2b2c98,    0x2ad47e,
+    0x2a7c64,    0x2a244a,    0x29cc30,    0x297416,    0x291bfc,    0x28c3e2,
+    0x286bc8,    0x2813ae,    0x27bb94,    0x27637a,    0x270b60,    0x26b346,
+    0x265b2c,    0x260312,    0x25aaf8,    0x2552de,    0x24fac4,    0x24a2aa,
+    0x244a90,    0x23f276,    0x239a5c,    0x234242,    0x22ea28,    0x22920e,
+    0x2239f4,    0x21e1da,    0x2189c0,    0x2131a6,    0x20d98c,    0x208172,
+    0x202958,    0x1fd13e,    0x1f7924,    0x1f210a,    0x1ec8f0,    0x1e70d6,
+    0x1e18bc,    0x1dc0a2,    0x1d6888,    0x1d106e,    0x1cb854,    0x1c603a,
+    0x1c0820,    0x1bb006,    0x1b57ec,    0x1affd2,    0x1aa7b8,    0x1a4f9e,
+    0x19f784,    0x199f6a,    0x194750,    0x18ef36,    0x18971c,    0x183f02,
+    0x17e6e8,    0x178ece,    0x1736b4,    0x16de9a,    0x168680,    0x162e66,
+    0x15d64c,    0x157e32,    0x152618,    0x14cdfe,    0x1475e4,    0x141dca,
+    0x13c5b0,    0x136d96,    0x13157c,    0x12bd62,    0x126548,    0x120d2e,
+    0x11b514,    0x115cfa,    0x1104e0,    0x10acc6,    0x1054ac,    0x0ffc92,
+    0x0fa478,    0x0f4c5e,    0x0ef444,    0x0e9c2a,    0x0e4410,    0x0debf6,
+    0x0d93dc,    0x0d3bc2,    0x0ce3a8,    0x0c8b8e,    0x0c3374,    0x0bdb5a,
+    0x0b8340,    0x0b2b26,    0x0ad30c,    0x0a7af2,    0x0a22d8,    0x09cabe,
+    0x0972a4,    0x091a8a,    0x08c270,    0x086a56,    0x08123c,    0x07ba22,
+    0x076208,    0x0709ee,    0x06b1d4,    0x0659ba,    0x0601a0,    0x05a986,
+    0x05516c,    0x04f952,    0x04a138,    0x04491e,    0x03f104,    0x0398ea,
+    0x0340d0,    0x02e8b6,    0x02909c,    0x023882,    0x01e068,    0x01884e,
+    0x013034,    0x00d81a,    0x008000,    0x0027e6,   -0x003034,   -0x00884e,
+   -0x00e068,   -0x013882,   -0x01909c,   -0x01e8b6,   -0x0240d0,   -0x0298ea,
+   -0x02f104,   -0x03491e,   -0x03a138,   -0x03f952,   -0x04516c,   -0x04a986,
+   -0x0501a0,   -0x0559ba,   -0x05b1d4,   -0x0609ee,   -0x066208,   -0x06ba22,
+   -0x07123c,   -0x076a56,   -0x07c270,   -0x081a8a,   -0x0872a4,   -0x08cabe,
+   -0x0922d8,   -0x097af2,   -0x09d30c,   -0x0a2b26,   -0x0a8340,   -0x0adb5a,
+   -0x0b3374,   -0x0b8b8e,   -0x0be3a8,   -0x0c3bc2,   -0x0c93dc,   -0x0cebf6,
+   -0x0d4410,   -0x0d9c2a,   -0x0df444,   -0x0e4c5e,   -0x0ea478,   -0x0efc92,
+   -0x0f54ac,   -0x0facc6,   -0x1004e0,   -0x105cfa,   -0x10b514,   -0x110d2e,
+   -0x116548,   -0x11bd62,   -0x12157c,   -0x126d96,   -0x12c5b0,   -0x131dca,
+   -0x1375e4,   -0x13cdfe,   -0x142618,   -0x147e32,   -0x14d64c,   -0x152e66,
+   -0x158680,   -0x15de9a,   -0x1636b4,   -0x168ece,   -0x16e6e8,   -0x173f02,
+   -0x17971c,   -0x17ef36,   -0x184750,   -0x189f6a,   -0x18f784,   -0x194f9e,
+   -0x19a7b8,   -0x19ffd2,   -0x1a57ec,   -0x1ab006,   -0x1b0820,   -0x1b603a,
+   -0x1bb854,   -0x1c106e,   -0x1c6888,   -0x1cc0a2,   -0x1d18bc,   -0x1d70d6,
+   -0x1dc8f0,   -0x1e210a,   -0x1e7924,   -0x1ed13e,   -0x1f2958,   -0x1f8172,
+   -0x1fd98c,   -0x2031a6,   -0x2089c0,   -0x20e1da,   -0x2139f4,   -0x21920e,
+   -0x21ea28,   -0x224242,   -0x229a5c,   -0x22f276,   -0x234a90,   -0x23a2aa,
+   -0x23fac4,   -0x2452de,   -0x24aaf8,   -0x250312,   -0x255b2c,   -0x25b346,
+   -0x260b60,   -0x26637a,   -0x26bb94,   -0x2713ae,   -0x276bc8,   -0x27c3e2,
+   -0x281bfc,   -0x287416,   -0x28cc30,   -0x29244a,   -0x297c64,   -0x29d47e,
+   -0x2a2c98,   -0x2a84b2,   -0x2adccc,   -0x2b34e6,
+ };
+
+
+/* We assume that right shift corresponds to signed division by 2 with
+ * rounding towards minus infinity.  This is correct for typical "arithmetic
+ * shift" instructions that shift in copies of the sign bit.  But some
+ * C compilers implement >> with an unsigned shift.  For these machines you
+ * must define RIGHT_SHIFT_IS_UNSIGNED.
+ * RIGHT_SHIFT provides a proper signed right shift of an INT32 quantity.
+ * It is only applied with constant shift counts.  SHIFT_TEMPS must be
+ * included in the variables of any routine using RIGHT_SHIFT.
+ */
+
+#ifdef RIGHT_SHIFT_IS_UNSIGNED
+#define SHIFT_TEMPS	INT32 shift_temp;
+#define RIGHT_SHIFT(x,shft)  \
+	((shift_temp = (x)) < 0 ? \
+	 (shift_temp >> (shft)) | ((~((INT32) 0)) << (32-(shft))) : \
+	 (shift_temp >> (shft)))
+#else
+#define SHIFT_TEMPS
+#define RIGHT_SHIFT(x,shft)	((x) >> (shft))
+#endif
+
+
+METHODDEF(void)
+ycc_rgb_convert_argb (j_decompress_ptr cinfo,
+                 JSAMPIMAGE input_buf, JDIMENSION input_row,
+                 JSAMPARRAY output_buf, int num_rows)
+{
+  JDIMENSION num_cols = cinfo->output_width;
+  JSAMPLE * range_limit = cinfo->sample_range_limit;
+
+  SHIFT_TEMPS
+
+  /* This is used if we don't have SSE2 */
+
+  while (--num_rows >= 0) {
+    JSAMPROW inptr0 = input_buf[0][input_row];
+    JSAMPROW inptr1 = input_buf[1][input_row];
+    JSAMPROW inptr2 = input_buf[2][input_row];
+    input_row++;
+    uint32_t *outptr = (uint32_t *) *output_buf++;
+    for (JDIMENSION col = 0; col < num_cols; col++) {
+      int y  = GETJSAMPLE(inptr0[col]);
+      int cb = GETJSAMPLE(inptr1[col]);
+      int cr = GETJSAMPLE(inptr2[col]);
+      JSAMPLE * range_limit_y = range_limit + y;
+      /* Range-limiting is essential due to noise introduced by DCT losses. */
+      outptr[col] = 0xFF000000 |
+                    ( range_limit_y[Cr_r_tab[cr]] << 16 ) |
+                    ( range_limit_y[((int) RIGHT_SHIFT(Cb_g_tab[cb] + Cr_g_tab[cr], SCALEBITS))] << 8 ) |
+                    ( range_limit_y[Cb_b_tab[cb]] );
+    }
+  }
+}
+#endif
+
+
 /**************** Inverted CMYK -> RGB conversion **************/
 /*
  * Input is (Inverted) CMYK stored as 4 bytes per pixel.
diff -ruN comm-release/mozilla/intl/hyphenation/src/hnjalloc.h comm-patched/mozilla/intl/hyphenation/src/hnjalloc.h
--- comm-release/mozilla/intl/hyphenation/src/hnjalloc.h	2014-03-19 01:41:55.000000000 +0000
+++ comm-patched/mozilla/intl/hyphenation/src/hnjalloc.h	2014-04-27 14:07:20.244233314 +0100
@@ -24,6 +24,9 @@
  */
 
 #include <stdio.h> /* ensure stdio.h is loaded before our macros */
+#ifdef __sun
+#include <wchar.h>
+#endif
 
 #undef FILE
 #define FILE hnjFile
diff -ruN comm-release/mozilla/intl/unicharutil/util/Makefile.in comm-patched/mozilla/intl/unicharutil/util/Makefile.in
--- comm-release/mozilla/intl/unicharutil/util/Makefile.in	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/intl/unicharutil/util/Makefile.in	2014-04-27 14:07:20.244471013 +0100
@@ -19,3 +19,7 @@
 OS_COMPILE_CXXFLAGS += -Zl
 OS_COMPILE_CFLAGS += -Zl
 endif
+
+ifdef MOZ_NATIVE_HARFBUZZ
+nsUnicodePropertyData.$(OBJ_SUFFIX): CXXFLAGS+=$(MOZ_HARFBUZZ_CFLAGS)
+endif
diff -ruN comm-release/mozilla/ipc/chromium/Makefile.in comm-patched/mozilla/ipc/chromium/Makefile.in
--- comm-release/mozilla/ipc/chromium/Makefile.in	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/Makefile.in	2014-04-27 14:07:20.244727231 +0100
@@ -11,9 +11,7 @@
   $(srcdir)/src/third_party/libevent \
   $(NULL)
 else # } else {
-# message_pump_libevent.cc includes third_party/libevent/event.h,
-# which we put in $(DIST), see export rule below
-LOCAL_INCLUDES += -I$(DIST)
+LOCAL_INCLUDES += $(filter %/compat, $(MOZ_LIBEVENT_CFLAGS))
 endif # }
 
 vpath %.cc \
diff -ruN comm-release/mozilla/ipc/chromium/chromium-config.mozbuild comm-patched/mozilla/ipc/chromium/chromium-config.mozbuild
--- comm-release/mozilla/ipc/chromium/chromium-config.mozbuild	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/chromium-config.mozbuild	2014-04-27 14:51:37.908063981 +0100
@@ -72,4 +72,5 @@
         })
 
     else:
+        DEFINES['OS_SOLARIS'] = 1
         DEFINES['OS_LINUX'] = 1
diff -ruN comm-release/mozilla/ipc/chromium/src/base/base_paths.h comm-patched/mozilla/ipc/chromium/src/base/base_paths.h
--- comm-release/mozilla/ipc/chromium/src/base/base_paths.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/base_paths.h	2014-04-27 14:07:20.244956145 +0100
@@ -13,7 +13,7 @@
 #include "base/base_paths_win.h"
 #elif defined(OS_MACOSX)
 #include "base/base_paths_mac.h"
-#elif defined(OS_LINUX) || defined(OS_BSD)
+#elif defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
 #include "base/base_paths_linux.h"
 #endif
 #include "base/path_service.h"
diff -ruN comm-release/mozilla/ipc/chromium/src/base/debug_util_posix.cc comm-patched/mozilla/ipc/chromium/src/base/debug_util_posix.cc
--- comm-release/mozilla/ipc/chromium/src/base/debug_util_posix.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/debug_util_posix.cc	2014-04-27 14:07:20.245224020 +0100
@@ -110,7 +110,7 @@
   return being_debugged;
 }
 
-#elif defined(OS_LINUX)
+#elif defined(OS_LINUX) || defined(OS_SOLARIS)
 
 // We can look in /proc/self/status for TracerPid.  We are likely used in crash
 // handling, so we are careful not to use the heap or have side effects.
diff -ruN comm-release/mozilla/ipc/chromium/src/base/dir_reader_linux.h comm-patched/mozilla/ipc/chromium/src/base/dir_reader_linux.h
--- comm-release/mozilla/ipc/chromium/src/base/dir_reader_linux.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/dir_reader_linux.h	2014-04-27 14:43:24.953395533 +0100
@@ -30,7 +30,7 @@
 class DirReaderLinux {
  public:
   explicit DirReaderLinux(const char* directory_path)
-      : fd_(open(directory_path, O_RDONLY | O_DIRECTORY)),
+      : fd_(open(directory_path, O_RDONLY)),
         offset_(0),
         size_(0) {
     memset(buf_, 0, sizeof(buf_));
@@ -57,7 +57,7 @@
     if (offset_ != size_)
       return true;
 
-    const int r = syscall(__NR_getdents64, fd_, buf_, sizeof(buf_));
+    const int r = syscall(SYS_getdents64, fd_, buf_, sizeof(buf_));
     if (r == 0)
       return false;
     if (r == -1) {
diff -ruN comm-release/mozilla/ipc/chromium/src/base/file_util.h comm-patched/mozilla/ipc/chromium/src/base/file_util.h
--- comm-release/mozilla/ipc/chromium/src/base/file_util.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/file_util.h	2014-04-27 14:07:20.246015373 +0100
@@ -16,7 +16,9 @@
 #include <sys/stat.h>
 #elif defined(OS_POSIX) 
 #include <sys/types.h>
+#if !defined(OS_SOLARIS)
 #include <fts.h>
+#endif
 #include <sys/stat.h>
 #endif
 
diff -ruN comm-release/mozilla/ipc/chromium/src/base/file_util_posix.cc comm-patched/mozilla/ipc/chromium/src/base/file_util_posix.cc
--- comm-release/mozilla/ipc/chromium/src/base/file_util_posix.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/file_util_posix.cc	2014-04-27 14:07:20.245736131 +0100
@@ -8,7 +8,7 @@
 #include <errno.h>
 #include <fcntl.h>
 #include <fnmatch.h>
-#ifndef ANDROID
+#if !defined(ANDROID) && !defined(OS_SOLARIS)
 #include <fts.h>
 #endif
 #include <libgen.h>
@@ -67,7 +67,7 @@
   if (!recursive)
     return (rmdir(path_str) == 0);
 
-#ifdef ANDROID
+#if defined(ANDROID) || defined(OS_SOLARIS)
   // XXX Need ftsless impl for bionic
   return false;
 #else
@@ -140,7 +140,7 @@
     return false;
   }
 
-#ifdef ANDROID
+#if defined(ANDROID) || defined(OS_SOLARIS)
   // XXX Need ftsless impl for bionic
   return false;
 #else
diff -ruN comm-release/mozilla/ipc/chromium/src/base/file_version_info.h comm-patched/mozilla/ipc/chromium/src/base/file_version_info.h
--- comm-release/mozilla/ipc/chromium/src/base/file_version_info.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/file_version_info.h	2014-04-27 14:07:20.246247498 +0100
@@ -86,7 +86,7 @@
   explicit FileVersionInfo(NSBundle *bundle);
 
   NSBundle *bundle_;
-#elif defined(OS_LINUX)
+#elif defined(OS_LINUX) || defined(OS_SOLARIS)
   FileVersionInfo();
 #endif
 
diff -ruN comm-release/mozilla/ipc/chromium/src/base/message_pump_libevent.cc comm-patched/mozilla/ipc/chromium/src/base/message_pump_libevent.cc
--- comm-release/mozilla/ipc/chromium/src/base/message_pump_libevent.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/message_pump_libevent.cc	2014-04-27 14:07:20.246539990 +0100
@@ -16,7 +16,7 @@
 #include "base/scoped_ptr.h"
 #include "base/time.h"
 #include "nsDependentSubstring.h"
-#include "third_party/libevent/event.h"
+#include "event.h"
 
 // Lifecycle of struct event
 // Libevent uses two main data structures:
diff -ruN comm-release/mozilla/ipc/chromium/src/base/platform_thread.h comm-patched/mozilla/ipc/chromium/src/base/platform_thread.h
--- comm-release/mozilla/ipc/chromium/src/base/platform_thread.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/platform_thread.h	2014-04-27 14:07:20.247181070 +0100
@@ -25,6 +25,9 @@
 #if defined(OS_LINUX) || defined(OS_OPENBSD) || defined(__GLIBC__)
 #include <unistd.h>
 typedef pid_t PlatformThreadId;
+#elif defined(OS_SOLARIS)
+#include <sys/lwp.h>
+typedef lwpid_t PlatformThreadId;
 #elif defined(OS_BSD)
 #include <sys/types.h>
 typedef lwpid_t PlatformThreadId;
diff -ruN comm-release/mozilla/ipc/chromium/src/base/platform_thread_posix.cc comm-patched/mozilla/ipc/chromium/src/base/platform_thread_posix.cc
--- comm-release/mozilla/ipc/chromium/src/base/platform_thread_posix.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/platform_thread_posix.cc	2014-04-27 15:02:15.186447723 +0100
@@ -10,15 +10,24 @@
 #if defined(OS_MACOSX)
 #include <mach/mach.h>
 #elif defined(OS_NETBSD)
+_Pragma("GCC visibility push(default)")
 #include <lwp.h>
+_Pragma("GCC visibility pop")
 #elif defined(OS_LINUX)
 #include <sys/syscall.h>
-#include <sys/prctl.h>
+//#include <sys/prctl.h>
+#include <unistd.h>
+#include <thread.h>
 #elif defined(OS_FREEBSD) && !defined(__GLIBC__)
 #include <sys/param.h>
 #include <sys/thr.h>
 #endif
 
+#include <sys/syscall.h>
+#include <unistd.h>
+#include <thread.h>
+
+
 #if !defined(OS_MACOSX)
 #include <unistd.h>
 #endif
@@ -49,11 +58,7 @@
   mach_port_deallocate(mach_task_self(), port);
   return port;
 #elif defined(OS_LINUX)
-#ifdef MOZ_WIDGET_GONK
-  return (intptr_t) (pthread_self());
-#else
-  return syscall(__NR_gettid);
-#endif
+return thr_self(); 
 #elif defined(OS_OPENBSD) || defined(__GLIBC__)
   return (intptr_t) (pthread_self());
 #elif defined(OS_NETBSD)
@@ -108,13 +113,14 @@
   // Note that glibc also has a 'pthread_setname_np' api, but it may not be
   // available everywhere and it's only benefit over using prctl directly is
   // that it can set the name of threads other than the current thread.
-#if defined(OS_LINUX)
-  prctl(PR_SET_NAME, reinterpret_cast<uintptr_t>(name), 0, 0, 0); 
+#if defined(OS_SOLARIS)
+//  prctl(PR_SET_NAME, reinterpret_cast<uintptr_t>(name), 0, 0, 0); 
 #elif defined(OS_NETBSD)
   pthread_setname_np(pthread_self(), "%s", (void *)name);
 #elif defined(OS_BSD) && !defined(__GLIBC__)
   pthread_set_name_np(pthread_self(), name);
-#else
+#elif !defined(OS_SOLARIS)
+  //prctl(PR_SET_NAME, reinterpret_cast<uintptr_t>(name), 0, 0, 0);
 #endif
 }
 #endif // !OS_MACOSX
diff -ruN comm-release/mozilla/ipc/chromium/src/base/process_util.h comm-patched/mozilla/ipc/chromium/src/base/process_util.h
--- comm-release/mozilla/ipc/chromium/src/base/process_util.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/process_util.h	2014-04-27 14:07:20.247790030 +0100
@@ -13,7 +13,7 @@
 #if defined(OS_WIN)
 #include <windows.h>
 #include <tlhelp32.h>
-#elif defined(OS_LINUX) || defined(__GLIBC__)
+#elif defined(OS_LINUX) || defined(__GLIBC__) || defined(OS_SOLARIS)
 #include <dirent.h>
 #include <limits.h>
 #include <sys/types.h>
@@ -32,6 +32,9 @@
 typedef PROCESSENTRY32 ProcessEntry;
 typedef IO_COUNTERS IoCounters;
 #elif defined(OS_POSIX)
+#ifndef NAME_MAX
+#define NAME_MAX _POSIX_NAME_MAX
+#endif
 // TODO(port): we should not rely on a Win32 structure.
 struct ProcessEntry {
   int pid;
@@ -250,7 +253,7 @@
 #if defined(OS_WIN)
   HANDLE snapshot_;
   bool started_iteration_;
-#elif defined(OS_LINUX) || defined(__GLIBC__)
+#elif defined(OS_LINUX) || defined(__GLIBC__) || defined(OS_SOLARIS)
   DIR *procfs_dir_;
 #elif defined(OS_BSD)
   std::vector<ProcessEntry> content;
diff -ruN comm-release/mozilla/ipc/chromium/src/base/process_util_posix.cc comm-patched/mozilla/ipc/chromium/src/base/process_util_posix.cc
--- comm-release/mozilla/ipc/chromium/src/base/process_util_posix.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/process_util_posix.cc	2014-04-27 14:07:20.247469240 +0100
@@ -110,7 +110,7 @@
 #if defined(ANDROID)
   static const rlim_t kSystemDefaultMaxFds = 1024;
   static const char kFDDir[] = "/proc/self/fd";
-#elif defined(OS_LINUX)
+#elif defined(OS_LINUX) || defined(OS_SOLARIS)
   static const rlim_t kSystemDefaultMaxFds = 8192;
   static const char kFDDir[] = "/proc/self/fd";
 #elif defined(OS_MACOSX)
@@ -202,7 +202,7 @@
 // TODO(agl): Remove this function. It's fundamentally broken for multithreaded
 // apps.
 void SetAllFDsToCloseOnExec() {
-#if defined(OS_LINUX)
+#if defined(OS_LINUX) || defined(OS_SOLARIS)
   const char fd_dir[] = "/proc/self/fd";
 #elif defined(OS_MACOSX) || defined(OS_BSD)
   const char fd_dir[] = "/dev/fd";
diff -ruN comm-release/mozilla/ipc/chromium/src/base/sys_info_posix.cc comm-patched/mozilla/ipc/chromium/src/base/sys_info_posix.cc
--- comm-release/mozilla/ipc/chromium/src/base/sys_info_posix.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/sys_info_posix.cc	2014-04-27 14:07:20.248168876 +0100
@@ -119,7 +119,11 @@
 
 // static
 std::string SysInfo::OperatingSystemName() {
+#ifdef OS_SOLARIS
+  struct utsname info;
+#else
   utsname info;
+#endif
   if (uname(&info) < 0) {
     NOTREACHED();
     return "";
@@ -129,7 +133,11 @@
 
 // static
 std::string SysInfo::OperatingSystemVersion() {
+#ifdef OS_SOLARIS
+  struct utsname info;
+#else
   utsname info;
+#endif
   if (uname(&info) < 0) {
     NOTREACHED();
     return "";
@@ -139,7 +147,11 @@
 
 // static
 std::string SysInfo::CPUArchitecture() {
+#ifdef OS_SOLARIS
+  struct utsname info;
+#else
   utsname info;
+#endif
   if (uname(&info) < 0) {
     NOTREACHED();
     return "";
diff -ruN comm-release/mozilla/ipc/chromium/src/base/time_posix.cc comm-patched/mozilla/ipc/chromium/src/base/time_posix.cc
--- comm-release/mozilla/ipc/chromium/src/base/time_posix.cc	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/base/time_posix.cc	2014-04-27 14:07:20.248429232 +0100
@@ -65,8 +65,10 @@
   timestruct.tm_wday   = exploded.day_of_week;  // mktime/timegm ignore this
   timestruct.tm_yday   = 0;     // mktime/timegm ignore this
   timestruct.tm_isdst  = -1;    // attempt to figure it out
+#ifndef OS_SOLARIS
   timestruct.tm_gmtoff = 0;     // not a POSIX field, so mktime/timegm ignore
   timestruct.tm_zone   = NULL;  // not a POSIX field, so mktime/timegm ignore
+#endif
 
   time_t seconds;
 #ifdef ANDROID
diff -ruN comm-release/mozilla/ipc/chromium/src/build/build_config.h comm-patched/mozilla/ipc/chromium/src/build/build_config.h
--- comm-release/mozilla/ipc/chromium/src/build/build_config.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/build/build_config.h	2014-04-27 14:07:20.248678719 +0100
@@ -27,6 +27,8 @@
 #define OS_NETBSD 1
 #elif defined(__OpenBSD__)
 #define OS_OPENBSD 1
+#elif defined(__sun)
+#define OS_SOLARIS 1
 #elif defined(_WIN32)
 #define OS_WIN 1
 #else
@@ -42,7 +44,7 @@
 
 // For access to standard POSIX features, use OS_POSIX instead of a more
 // specific macro.
-#if defined(OS_MACOSX) || defined(OS_LINUX) || defined(OS_BSD)
+#if defined(OS_MACOSX) || defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
 #define OS_POSIX 1
 #endif
 
diff -ruN comm-release/mozilla/ipc/chromium/src/chrome/common/transport_dib.h comm-patched/mozilla/ipc/chromium/src/chrome/common/transport_dib.h
--- comm-release/mozilla/ipc/chromium/src/chrome/common/transport_dib.h	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/chromium/src/chrome/common/transport_dib.h	2014-04-27 14:07:20.248949807 +0100
@@ -70,7 +70,7 @@
   typedef base::SharedMemoryHandle Handle;
   // On Mac, the inode number of the backing file is used as an id.
   typedef base::SharedMemoryId Id;
-#elif defined(OS_LINUX)
+#elif defined(OS_LINUX) || defined(OS_SOLARIS)
   typedef int Handle;  // These two ints are SysV IPC shared memory keys
   typedef int Id;
 #endif
diff -ruN comm-release/mozilla/ipc/glue/GeckoChildProcessHost.cpp comm-patched/mozilla/ipc/glue/GeckoChildProcessHost.cpp
--- comm-release/mozilla/ipc/glue/GeckoChildProcessHost.cpp	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/glue/GeckoChildProcessHost.cpp	2014-04-27 14:07:20.249402319 +0100
@@ -4,7 +4,13 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
+#if defined(__NetBSD__)
+_Pragma("GCC visibility push(default)")
+#endif
 #include "GeckoChildProcessHost.h"
+#if defined(__NetBSD__)
+_Pragma("GCC visibility pop")
+#endif
 
 #if defined(XP_WIN) && defined(MOZ_CONTENT_SANDBOX)
 #include "sandboxBroker.h"
@@ -499,7 +505,7 @@
   // and passing wstrings from one config to the other is unsafe.  So
   // we split the logic here.
 
-#if defined(OS_LINUX) || defined(OS_MACOSX) || defined(OS_BSD)
+#if defined(OS_LINUX) || defined(OS_MACOSX) || defined(OS_BSD) || defined(OS_SOLARIS)
   base::environment_map newEnvVars;
   ChildPrivileges privs = mPrivileges;
   if (privs == base::PRIVILEGES_DEFAULT) {
@@ -518,7 +524,7 @@
       if (NS_SUCCEEDED(rv)) {
         nsCString path;
         greDir->GetNativePath(path);
-# if defined(OS_LINUX) || defined(OS_BSD)
+# if defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
 #  if defined(MOZ_WIDGET_ANDROID)
         path += "/lib";
 #  endif  // MOZ_WIDGET_ANDROID
@@ -627,7 +633,7 @@
   childArgv.push_back(pidstring);
 
 #if defined(MOZ_CRASHREPORTER)
-#  if defined(OS_LINUX) || defined(OS_BSD)
+#  if defined(OS_LINUX) || defined(OS_BSD) || defined(OS_SOLARIS)
   int childCrashFd, childCrashRemapFd;
   if (!CrashReporter::CreateNotificationPipeForChild(
         &childCrashFd, &childCrashRemapFd))
@@ -660,7 +666,7 @@
   childArgv.push_back(childProcessType);
 
   base::LaunchApp(childArgv, mFileMap,
-#if defined(OS_LINUX) || defined(OS_MACOSX) || defined(OS_BSD)
+#if defined(OS_LINUX) || defined(OS_MACOSX) || defined(OS_BSD) || defined(OS_SOLARIS)
                   newEnvVars, privs,
 #endif
                   false, &process, arch);
Binary files comm-release/mozilla/ipc/ipdl/ipdl/__init__.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/__init__.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/ast.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/ast.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/builtin.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/builtin.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/cgen.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/cgen.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/cxx/__init__.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/cxx/__init__.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/cxx/ast.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/cxx/ast.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/cxx/cgen.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/cxx/cgen.pyc differ
diff -ruN comm-release/mozilla/ipc/ipdl/ipdl/lower.py comm-patched/mozilla/ipc/ipdl/ipdl/lower.py
--- comm-release/mozilla/ipc/ipdl/ipdl/lower.py	2014-03-19 01:41:56.000000000 +0000
+++ comm-patched/mozilla/ipc/ipdl/ipdl/lower.py	2014-04-27 14:07:20.250798419 +0100
@@ -1843,7 +1843,7 @@
         StmtExpr(ExprCall(
             ExprVar('StringAppendF'),
             args=[ ExprAddrOf(msgvar),
-                   ExprLiteral.String('[time:%" PRId64 "][%d]'),
+                   ExprLiteral.String('[time:%\\" PRId64 \\"][%d]'),
                    ExprCall(ExprVar('PR_Now')),
                    ExprCall(ExprVar('base::GetCurrentProcId')) ])),
         appendToMsg(pfxvar),
Binary files comm-release/mozilla/ipc/ipdl/ipdl/lower.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/lower.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/parser.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/parser.pyc differ
Binary files comm-release/mozilla/ipc/ipdl/ipdl/type.pyc and comm-patched/mozilla/ipc/ipdl/ipdl/type.pyc differ
diff -ruN comm-release/mozilla/js/src/Makefile.in comm-patched/mozilla/js/src/Makefile.in
--- comm-release/mozilla/js/src/Makefile.in	2014-03-19 01:41:57.000000000 +0000
+++ comm-patched/mozilla/js/src/Makefile.in	2014-04-27 14:07:20.252732009 +0100
@@ -379,7 +379,7 @@
 ifdef MOZ_SHARED_ICU
 EXTRA_DSO_LDOPTS += $(MOZ_ICU_LIBS)
 else
-SHARED_LIBRARY_LIBS += $(MOZ_ICU_LIBS)
+SHARED_LIBRARY_LIBS += $(filter-out -L% -l% -Wl%,$(MOZ_ICU_LIBS))
 endif
 
 # Prevent floating point errors caused by VC++ optimizations
Binary files comm-release/mozilla/js/src/config/expandlibs.pyc and comm-patched/mozilla/js/src/config/expandlibs.pyc differ
Binary files comm-release/mozilla/js/src/config/expandlibs_config.pyc and comm-patched/mozilla/js/src/config/expandlibs_config.pyc differ
diff -ruN comm-release/mozilla/js/src/config/system-headers comm-patched/mozilla/js/src/config/system-headers
--- comm-release/mozilla/js/src/config/system-headers	2014-03-19 01:41:57.000000000 +0000
+++ comm-patched/mozilla/js/src/config/system-headers	2014-04-27 14:07:20.251248064 +0100
@@ -1145,3 +1145,5 @@
 unicode/utypes.h
 #endif
 libutil.h
+unwind.h
+cairo-qt.h
diff -ruN comm-release/mozilla/js/src/configure.in comm-patched/mozilla/js/src/configure.in
--- comm-release/mozilla/js/src/configure.in	2014-03-19 01:41:57.000000000 +0000
+++ comm-patched/mozilla/js/src/configure.in	2014-04-27 14:07:20.218658713 +0100
@@ -2148,116 +2148,13 @@
 
 MOZ_CXX11
 
-dnl Check for .hidden assembler directive and visibility attribute.
-dnl Borrowed from glibc configure.in
+dnl Setup default hidden visibility and wrapped system headers.
 dnl ===============================================================
 if test "$GNU_CC"; then
-  AC_CACHE_CHECK(for visibility(hidden) attribute,
-                 ac_cv_visibility_hidden,
-                 [cat > conftest.c <<EOF
-                  int foo __attribute__ ((visibility ("hidden"))) = 1;
-EOF
-                  ac_cv_visibility_hidden=no
-                  if ${CC-cc} -Werror -S conftest.c -o conftest.s >/dev/null 2>&1; then
-                    if egrep '\.(hidden|private_extern).*foo' conftest.s >/dev/null; then
-                      ac_cv_visibility_hidden=yes
-                    fi
-                  fi
-                  rm -f conftest.[cs]
-                 ])
-  if test "$ac_cv_visibility_hidden" = "yes"; then
-    AC_DEFINE(HAVE_VISIBILITY_HIDDEN_ATTRIBUTE)
-
-    AC_CACHE_CHECK(for visibility(default) attribute,
-                   ac_cv_visibility_default,
-                   [cat > conftest.c <<EOF
-                    int foo __attribute__ ((visibility ("default"))) = 1;
-EOF
-                    ac_cv_visibility_default=no
-                    if ${CC-cc} -fvisibility=hidden -Werror -S conftest.c -o conftest.s >/dev/null 2>&1; then
-                      if ! egrep '\.(hidden|private_extern).*foo' conftest.s >/dev/null; then
-                        ac_cv_visibility_default=yes
-                      fi
-                    fi
-                    rm -f conftest.[cs]
-                   ])
-    if test "$ac_cv_visibility_default" = "yes"; then
-      AC_DEFINE(HAVE_VISIBILITY_ATTRIBUTE)
-
-      AC_CACHE_CHECK(for visibility pragma support,
-                     ac_cv_visibility_pragma,
-                     [cat > conftest.c <<EOF
-#pragma GCC visibility push(hidden)
-                      int foo_hidden = 1;
-#pragma GCC visibility push(default)
-                      int foo_default = 1;
-EOF
-                      ac_cv_visibility_pragma=no
-                      if ${CC-cc} -Werror -S conftest.c -o conftest.s >/dev/null 2>&1; then
-                        if egrep '\.(hidden|private_extern).*foo_hidden' conftest.s >/dev/null; then
-                          if ! egrep '\.(hidden|private_extern).*foo_default' conftest.s > /dev/null; then
-                            ac_cv_visibility_pragma=yes
-                          fi
-                        fi
-                      fi
-                      rm -f conftest.[cs]
-                    ])
-      if test "$ac_cv_visibility_pragma" = "yes"; then
-        AC_CACHE_CHECK(For gcc visibility bug with class-level attributes (GCC bug 26905),
-                       ac_cv_have_visibility_class_bug,
-                       [cat > conftest.c <<EOF
-#pragma GCC visibility push(hidden)
-struct __attribute__ ((visibility ("default"))) TestStruct {
-  static void Init();
-};
-__attribute__ ((visibility ("default"))) void TestFunc() {
-  TestStruct::Init();
-}
-EOF
-                       ac_cv_have_visibility_class_bug=no
-                       if ! ${CXX-g++} ${CXXFLAGS} ${DSO_PIC_CFLAGS} ${DSO_LDOPTS} -S -o conftest.S conftest.c > /dev/null 2>&1 ; then
-                         ac_cv_have_visibility_class_bug=yes
-                       else
-                         if test `egrep -c '@PLT|\\$stub' conftest.S` = 0; then
-                           ac_cv_have_visibility_class_bug=yes
-                         fi
-                       fi
-                       rm -rf conftest.{c,S}
-                       ])
-
-        AC_CACHE_CHECK(For x86_64 gcc visibility bug with builtins (GCC bug 20297),
-                       ac_cv_have_visibility_builtin_bug,
-                       [cat > conftest.c <<EOF
-#pragma GCC visibility push(hidden)
-#pragma GCC visibility push(default)
-#include <string.h>
-#pragma GCC visibility pop
-
-__attribute__ ((visibility ("default"))) void Func() {
-  char c[[100]];
-  memset(c, 0, sizeof(c));
-}
-EOF
-                       ac_cv_have_visibility_builtin_bug=no
-                       if ! ${CC-cc} ${CFLAGS} ${DSO_PIC_CFLAGS} ${DSO_LDOPTS} -O2 -S -o conftest.S conftest.c > /dev/null 2>&1 ; then
-                         ac_cv_have_visibility_builtin_bug=yes
-                       else
-                         if test `grep -c "@PLT" conftest.S` = 0; then
-                           ac_cv_visibility_builtin_bug=yes
-                         fi
-                       fi
-                       rm -f conftest.{c,S}
-                       ])
-        if test "$ac_cv_have_visibility_builtin_bug" = "no" -a \
-                "$ac_cv_have_visibility_class_bug" = "no"; then
-          VISIBILITY_FLAGS='-I$(DIST)/system_wrappers_js -include $(topsrcdir)/config/gcc_hidden.h'
-          WRAP_SYSTEM_INCLUDES=1
-        else
-          VISIBILITY_FLAGS='-fvisibility=hidden'
-        fi # have visibility pragma bug
-      fi   # have visibility pragma
-    fi     # have visibility(default) attribute
-  fi       # have visibility(hidden) attribute
+  AC_DEFINE(HAVE_VISIBILITY_HIDDEN_ATTRIBUTE)
+  AC_DEFINE(HAVE_VISIBILITY_ATTRIBUTE)
+  VISIBILITY_FLAGS='-I$(DIST)/system_wrappers_js -include $(topsrcdir)/config/gcc_hidden.h'
+  WRAP_SYSTEM_INCLUDES=1
 fi         # GNU_CC
 
 # visibility hidden flag for Sun Studio on Solaris
@@ -2456,7 +2353,7 @@
     fi
 
 	case "$target" in
-	    *-*-freebsd*)
+	    *-*-freebsd*|*-dragonfly*)
 			AC_DEFINE(_REENTRANT)
 			AC_DEFINE(_THREAD_SAFE)
 			dnl -pthread links in -lpthread, so don't specify it explicitly.
@@ -3270,7 +3167,7 @@
   *-darwin*)
     AC_DEFINE(MOZ_MEMORY_DARWIN)
     ;;
-  *-*freebsd*)
+  *-*freebsd*|*-*dragonfly*)
     AC_DEFINE(MOZ_MEMORY_BSD)
     ;;
   *-android*|*-linuxandroid*)
@@ -3632,7 +3529,10 @@
 dnl = Support for gcc stack unwinding (from gcc 3.3)
 dnl ========================================================
 if test -z "$SKIP_LIBRARY_CHECKS"; then
+    AC_LANG_SAVE
+    AC_LANG_CPLUSPLUS
     MOZ_CHECK_HEADER(unwind.h, AC_CHECK_FUNCS(_Unwind_Backtrace))
+    AC_LANG_RESTORE
 fi
 
 dnl ========================================================
@@ -4086,6 +3986,20 @@
 AC_SUBST(MSMANIFEST_TOOL)
 AC_SUBST(MOZ_LINKER)
 
+AC_MSG_CHECKING([for posix_fadvise])
+AC_TRY_LINK([#define _XOPEN_SOURCE 600
+  #include <fcntl.h>],
+                 [posix_fadvise(0, 0, 0, 0);],
+                 [ac_cv___posix_fadvise=true],
+                 [ac_cv___posix_fadvise=false])
+
+if test "$ac_cv___posix_fadvise" = true ; then
+  AC_DEFINE(HAVE_POSIX_FADVISE)
+  AC_MSG_RESULT(yes)
+else
+  AC_MSG_RESULT(no)
+fi
+
 AC_MSG_CHECKING([for posix_fallocate])
 AC_TRY_LINK([#define _XOPEN_SOURCE 600
   #include <fcntl.h>],
@@ -4436,6 +4350,16 @@
 dnl ========================================================
 dnl JavaScript shell
 dnl ========================================================
+ICU_LIB_NAMES=
+MOZ_NATIVE_ICU=
+MOZ_ARG_WITH_BOOL(system-icu,
+[  --with-system-icu
+                          Use system icu (located with pkgconfig)],
+    MOZ_NATIVE_ICU=1)
+
+if test -n "$MOZ_NATIVE_ICU"; then
+    PKG_CHECK_MODULES(MOZ_ICU, icu-i18n >= 50.1)
+fi
 
 AC_HAVE_FUNCS(setlocale)
 AC_HAVE_FUNCS(localeconv)
diff -ruN comm-release/mozilla/js/src/ctypes/CTypes.h comm-patched/mozilla/js/src/ctypes/CTypes.h
--- comm-release/mozilla/js/src/ctypes/CTypes.h	2014-03-19 01:41:57.000000000 +0000
+++ comm-patched/mozilla/js/src/ctypes/CTypes.h	2014-04-27 14:07:20.251585595 +0100
@@ -14,6 +14,23 @@
 #include "js/Vector.h"
 #include "vm/String.h"
 
+#if defined(__NetBSD__)
+#include <stdint.h>
+/* XXX why do we have those funky __ #defines in stdint.h? */
+#warning this is a retarded workaround
+#define uint8_t uint8_t
+#define uint16_t uint16_t
+#define uint32_t uint32_t
+#define uint64_t uint64_t
+#define int8_t int8_t
+#define int16_t int16_t
+#define int32_t int32_t
+#define int64_t int64_t
+#define intptr_t intptr_t
+#define uintptr_t uintptr_t
+#define off_t off_t
+#endif
+
 namespace js {
 namespace ctypes {
 
diff -ruN comm-release/mozilla/js/src/ctypes/libffi/configure comm-patched/mozilla/js/src/ctypes/libffi/configure
--- comm-release/mozilla/js/src/ctypes/libffi/configure	2014-03-19 01:41:57.000000000 +0000
+++ comm-patched/mozilla/js/src/ctypes/libffi/configure	2014-04-27 14:07:20.211854469 +0100
@@ -11278,7 +11278,7 @@
   powerpc-*-aix* | rs6000-*-aix*)
 	TARGET=POWERPC_AIX; TARGETDIR=powerpc
 	;;
-  powerpc-*-freebsd* | powerpc-*-openbsd*)
+  powerpc-*-freebsd* | powerpc-*-openbsd* | powerpc-*-netbsd*)
 	TARGET=POWERPC_FREEBSD; TARGETDIR=powerpc
 	;;
   powerpc*-*-rtems*)
diff -ruN comm-release/mozilla/js/src/frontend/ParseMaps.cpp comm-patched/mozilla/js/src/frontend/ParseMaps.cpp
--- comm-release/mozilla/js/src/frontend/ParseMaps.cpp	2014-03-19 01:41:57.000000000 +0000
+++ comm-patched/mozilla/js/src/frontend/ParseMaps.cpp	2014-04-27 14:07:20.251833458 +0100
@@ -132,5 +132,5 @@
     }
 }
 
-template class js::frontend::AtomDecls<FullParseHandler>;
-template class js::frontend::AtomDecls<SyntaxParseHandler>;
+template class frontend::AtomDecls<FullParseHandler>;
+template class frontend::AtomDecls<SyntaxParseHandler>;
diff -ruN comm-release/mozilla/js/src/jsmath.cpp comm-patched/mozilla/js/src/jsmath.cpp
--- comm-release/mozilla/js/src/jsmath.cpp	2014-03-19 01:41:59.000000000 +0000
+++ comm-patched/mozilla/js/src/jsmath.cpp	2014-04-27 14:07:20.252277666 +0100
@@ -273,7 +273,7 @@
     }
 #endif
 
-#if defined(SOLARIS) && defined(__GNUC__)
+#if defined(notSOLARIS) && defined(__GNUC__)
     if (y == 0) {
         if (IsNegativeZero(x))
             return js_copysign(M_PI, y);
diff -ruN comm-release/mozilla/js/src/jsnativestack.cpp comm-patched/mozilla/js/src/jsnativestack.cpp
--- comm-release/mozilla/js/src/jsnativestack.cpp	2014-03-19 01:41:59.000000000 +0000
+++ comm-patched/mozilla/js/src/jsnativestack.cpp	2014-04-27 14:07:20.219424270 +0100
@@ -114,7 +114,7 @@
     pthread_attr_init(&sattr);
 #  if defined(__OpenBSD__)
     stack_t ss;
-#  elif defined(PTHREAD_NP_H) || defined(_PTHREAD_NP_H_) || defined(NETBSD)
+#  elif defined(PTHREAD_NP_H) || defined(_PTHREAD_NP_H_) || defined(__DragonFly__) || defined(NETBSD) || defined(__NetBSD__) /* XXX tnn not sure why NETBSD isn't defined, it looks like it should be ... */
     /* e.g. on FreeBSD 4.8 or newer, neundorf@kde.org */
     pthread_attr_get_np(thread, &sattr);
 #  else
diff -ruN comm-release/mozilla/js/src/vm/SPSProfiler.cpp comm-patched/mozilla/js/src/vm/SPSProfiler.cpp
--- comm-release/mozilla/js/src/vm/SPSProfiler.cpp	2014-03-19 01:42:01.000000000 +0000
+++ comm-patched/mozilla/js/src/vm/SPSProfiler.cpp	2014-04-27 14:07:20.253010690 +0100
@@ -4,12 +4,15 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
+#include "jscntxtinlines.h"
+
 #include "vm/SPSProfiler.h"
 
 #include "mozilla/DebugOnly.h"
 
 #include "jsnum.h"
 #include "jsscript.h"
+#include "jscntxtinlines.h"
 
 #include "jit/BaselineJIT.h"
 #include "vm/StringBuffer.h"
diff -ruN comm-release/mozilla/media/libcubeb/src/cubeb_alsa.c comm-patched/mozilla/media/libcubeb/src/cubeb_alsa.c
--- comm-release/mozilla/media/libcubeb/src/cubeb_alsa.c	2014-03-19 01:42:07.000000000 +0000
+++ comm-patched/mozilla/media/libcubeb/src/cubeb_alsa.c	2014-04-27 14:07:20.253433366 +0100
@@ -6,6 +6,9 @@
  */
 #undef NDEBUG
 #define _BSD_SOURCE
+#if defined(__NetBSD__)
+#define _NETBSD_SOURCE
+#endif
 #define _XOPEN_SOURCE 500
 #include <pthread.h>
 #include <sys/time.h>
diff -ruN comm-release/mozilla/media/libpng/pngpriv.h comm-patched/mozilla/media/libpng/pngpriv.h
--- comm-release/mozilla/media/libpng/pngpriv.h	2014-03-19 01:42:07.000000000 +0000
+++ comm-patched/mozilla/media/libpng/pngpriv.h	2014-04-27 14:07:20.254205095 +0100
@@ -38,6 +38,7 @@
  * still required (as of 2011-05-02.)
  */
 #define _POSIX_SOURCE 1 /* Just the POSIX 1003.1 and C89 APIs */
+#define _XOPEN_SOURCE 600
 
 #ifndef PNG_VERSION_INFO_ONLY
 /* Standard library headers not required by png.h: */
diff -ruN comm-release/mozilla/media/libsoundtouch/src/cpu_detect_x86.cpp comm-patched/mozilla/media/libsoundtouch/src/cpu_detect_x86.cpp
--- comm-release/mozilla/media/libsoundtouch/src/cpu_detect_x86.cpp	2014-03-19 01:42:07.000000000 +0000
+++ comm-patched/mozilla/media/libsoundtouch/src/cpu_detect_x86.cpp	2014-04-27 14:07:20.254498071 +0100
@@ -131,6 +131,9 @@
 
     return res & ~_dwDisabledISA;
 
+#elif defined(__GNUC__)
+    // No cpuid.h --> no cpuid support
+    return 0;
 #else
 
 /// One of these is true:
diff -ruN comm-release/mozilla/media/libtheora/Makefile.in comm-patched/mozilla/media/libtheora/Makefile.in
--- comm-release/mozilla/media/libtheora/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/media/libtheora/Makefile.in	2014-04-27 14:07:20.254721731 +0100
@@ -0,0 +1,9 @@
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+include $(topsrcdir)/config/rules.mk
+
+ifdef MOZ_NATIVE_OGG
+CFLAGS += $(MOZ_OGG_CFLAGS)
+endif
diff -ruN comm-release/mozilla/media/libtremor/Makefile.in comm-patched/mozilla/media/libtremor/Makefile.in
--- comm-release/mozilla/media/libtremor/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/media/libtremor/Makefile.in	2014-04-27 14:07:20.254897955 +0100
@@ -0,0 +1,9 @@
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+include $(topsrcdir)/config/rules.mk
+
+ifdef MOZ_NATIVE_OGG
+CFLAGS += $(MOZ_OGG_CFLAGS)
+endif
diff -ruN comm-release/mozilla/media/libvorbis/Makefile.in comm-patched/mozilla/media/libvorbis/Makefile.in
--- comm-release/mozilla/media/libvorbis/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/media/libvorbis/Makefile.in	2014-04-27 14:07:20.255076416 +0100
@@ -0,0 +1,9 @@
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+include $(topsrcdir)/config/rules.mk
+
+ifdef MOZ_NATIVE_OGG
+CFLAGS += $(MOZ_OGG_CFLAGS)
+endif
diff -ruN comm-release/mozilla/media/mtransport/third_party/nrappkit/src/port/generic/include/sys/queue.h comm-patched/mozilla/media/mtransport/third_party/nrappkit/src/port/generic/include/sys/queue.h
--- comm-release/mozilla/media/mtransport/third_party/nrappkit/src/port/generic/include/sys/queue.h	2014-03-19 01:42:07.000000000 +0000
+++ comm-patched/mozilla/media/mtransport/third_party/nrappkit/src/port/generic/include/sys/queue.h	2014-04-27 14:07:20.255480733 +0100
@@ -30,12 +30,15 @@
  * $FreeBSD: src/sys/sys/queue.h,v 1.58 2004/04/07 04:19:49 imp Exp $
  */
 
-#ifndef _SYS_QUEUE_H_
+#if (defined(BSD) && !defined(__OpenBSD__)) || defined(DARWIN)
+#include_next <sys/queue.h>
+#elif !defined(_SYS_QUEUE_H_)
 #define	_SYS_QUEUE_H_
 
-#if !defined(__FreeBSD__) && !defined(DARWIN)
 #include <stddef.h>
-#define __offsetof offsetof
+
+#ifndef offsetof
+#define offsetof(type, field) ((size_t)(&((type *)0)->field))
 #endif
 
 #define STAILQ_FOREACH_SAFE(var, head, field, tvar)                     \
@@ -43,8 +46,6 @@
              (var) && ((tvar) = STAILQ_NEXT((var), field), 1);           \
              (var) = (tvar))
 
-// #define __offsetof(type, field) ((size_t)(&((type *)0)->field))
-
 /*
  * This file defines four types of data structures: singly-linked lists,
  * singly-linked tail queues, lists and tail queues.
@@ -285,7 +286,7 @@
 	(STAILQ_EMPTY((head)) ?						\
 		NULL :							\
 	        ((struct type *)					\
-		((char *)((head)->stqh_last) - __offsetof(struct type, field))))
+		((char *)((head)->stqh_last) - offsetof(struct type, field))))
 
 #define	STAILQ_NEXT(elm, field)	((elm)->field.stqe_next)
 
diff -ruN comm-release/mozilla/media/webrtc/signaling/signaling.gyp comm-patched/mozilla/media/webrtc/signaling/signaling.gyp
--- comm-release/mozilla/media/webrtc/signaling/signaling.gyp	2014-03-19 01:42:07.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/signaling/signaling.gyp	2014-04-27 14:07:20.255934409 +0100
@@ -245,6 +245,19 @@
           'cflags_mozilla': [
           ],
         }],
+        ['os_bsd==1', {
+          'include_dirs': [
+          ],
+          'defines': [
+            # avoiding pointless ifdef churn
+            'SIP_OS_OSX',
+            'OSX',
+            'SECLIB_OPENSSL',
+          ],
+
+          'cflags_mozilla': [
+          ],
+        }],
         ['OS=="mac"', {
           'include_dirs': [
           ],
@@ -824,14 +837,13 @@
             ['OS=="mac"', {
               'defines' : [
                 'SIP_OS_OSX',
-                '_POSIX_SOURCE',
+                # using BSD extensions, leave _POSIX_SOURCE undefined
                 'CPR_MEMORY_LITTLE_ENDIAN',
                 'NO_SOCKET_POLLING',
                 'USE_TIMER_SELECT_BASED',
                 'FULL_BUILD',
                 'STUBBED_OUT',
                 'USE_PRINTF',
-                '_DARWIN_C_SOURCE',
                 'NO_NSPR_10_SUPPORT',
               ],
             }],
diff -ruN comm-release/mozilla/media/webrtc/signaling/test/Makefile.in comm-patched/mozilla/media/webrtc/signaling/test/Makefile.in
--- comm-release/mozilla/media/webrtc/signaling/test/Makefile.in	2014-03-19 01:42:08.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/signaling/test/Makefile.in	2014-04-27 14:07:20.256242618 +0100
@@ -8,6 +8,7 @@
   $(NSS_LIBS) \
   $(REALTIME_LIBS) \
   $(MOZ_JS_LIBS) \
+  $(MOZ_LIBV4L2_LIBS) \
   $(DEPTH)/xpcom/glue/$(LIB_PREFIX)xpcomglue_s.$(LIB_SUFFIX) \
   $(DEPTH)/media/mtransport/standalone/$(LIB_PREFIX)mtransport_s.$(LIB_SUFFIX) \
   $(DEPTH)/media/webrtc/signalingtest/signaling_ecc/$(LIB_PREFIX)ecc.$(LIB_SUFFIX) \
@@ -40,6 +41,12 @@
   $(NULL)
 endif
 
+ifdef MOZ_NATIVE_OPUS
+LIBS += \
+  $(MOZ_OPUS_LIBS) \
+  $(NULL)
+endif
+
 ifdef MOZ_NATIVE_LIBVPX
 LIBS += \
   $(MOZ_LIBVPX_LIBS) \
diff -ruN comm-release/mozilla/media/webrtc/trunk/webrtc/build/common.gypi comm-patched/mozilla/media/webrtc/trunk/webrtc/build/common.gypi
--- comm-release/mozilla/media/webrtc/trunk/webrtc/build/common.gypi	2014-03-19 01:42:08.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/trunk/webrtc/build/common.gypi	2014-04-27 14:07:20.256597083 +0100
@@ -93,9 +93,9 @@
     'enable_protobuf%': 1,
 
     # Disable these to not build components which can be externally provided.
-    'build_libjpeg%': 1,
+    'build_libjpeg%': 0,
     'build_libyuv%': 1,
-    'build_libvpx%': 1,
+    'build_libvpx%': 0,
 
     # Enable to use the Mozilla internal settings.
     'build_with_mozilla%': 0,
@@ -256,7 +256,7 @@
       }],
       ['OS=="dragonfly" or OS=="netbsd"', {
         'defines': [
-          # doesn't support pthread_condattr_setclock
+          # doesn't support pthread_condattr_setclock, NetBSD 6 supports it.
           'WEBRTC_CLOCK_TYPE_REALTIME',
         ],
       }],
diff -ruN comm-release/mozilla/media/webrtc/trunk/webrtc/modules/audio_coding/codecs/opus/opus.gypi comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/audio_coding/codecs/opus/opus.gypi
--- comm-release/mozilla/media/webrtc/trunk/webrtc/modules/audio_coding/codecs/opus/opus.gypi	2014-03-19 01:42:08.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/audio_coding/codecs/opus/opus.gypi	2014-04-27 14:07:20.256885839 +0100
@@ -14,9 +14,9 @@
       'conditions': [
         ['build_with_mozilla==1', {
           # Mozilla provides its own build of the opus library.
-          'include_dirs': [
-            '$(DIST)/include/opus',
-           ]
+          'cflags_mozilla': [
+            '$(MOZ_OPUS_CFLAGS)',
+          ],
         }, {
           'dependencies': [
             '<(DEPTH)/third_party/opus/opus.gyp:opus'
diff -ruN comm-release/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/device_info_linux.cc comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/device_info_linux.cc
--- comm-release/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/device_info_linux.cc	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/device_info_linux.cc	2014-04-27 14:07:20.257234335 +0100
@@ -18,17 +18,37 @@
 #include <sys/stat.h>
 #include <unistd.h>
 //v4l includes
-#if defined(__DragonFly__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/videoio.h>
 #elif defined(__sun)
 #include <sys/videodev2.h>
 #else
 #include <linux/videodev2.h>
 #endif
+#ifdef HAVE_LIBV4L2
+#include <libv4l2.h>
+#endif
 
 #include "webrtc/system_wrappers/interface/ref_count.h"
 #include "webrtc/system_wrappers/interface/trace.h"
 
+#ifdef HAVE_LIBV4L2
+#define open	v4l2_open
+#define close	v4l2_close
+#define dup	v4l2_dup
+#define ioctl	v4l2_ioctl
+#define mmap	v4l2_mmap
+#define munmap	v4l2_munmap
+#endif
+
+#ifdef HAVE_LIBV4L2
+#define open	v4l2_open
+#define close	v4l2_close
+#define dup	v4l2_dup
+#define ioctl	v4l2_ioctl
+#define mmap	v4l2_mmap
+#define munmap	v4l2_munmap
+#endif
 
 namespace webrtc
 {
@@ -136,6 +156,11 @@
     memset(deviceNameUTF8, 0, deviceNameLength);
     memcpy(cameraName, cap.card, sizeof(cap.card));
 
+    if (cameraName[0] == '\0')
+    {
+        sprintf(cameraName, "Camera at /dev/video%d", deviceNumber);
+    }
+
     if (deviceNameLength >= strlen(cameraName))
     {
         memcpy(deviceNameUTF8, cameraName, strlen(cameraName));
diff -ruN comm-release/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/video_capture_linux.cc comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/video_capture_linux.cc
--- comm-release/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/video_capture_linux.cc	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/linux/video_capture_linux.cc	2014-04-27 14:07:20.257584348 +0100
@@ -18,13 +18,16 @@
 #include <unistd.h>
 
 //v4l includes
-#if defined(__DragonFly__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/videoio.h>
 #elif defined(__sun)
 #include <sys/videodev2.h>
 #else
 #include <linux/videodev2.h>
 #endif
+#ifdef HAVE_LIBV4L2
+#include <libv4l2.h>
+#endif
 
 #include <new>
 
@@ -34,6 +37,24 @@
 #include "webrtc/system_wrappers/interface/thread_wrapper.h"
 #include "webrtc/system_wrappers/interface/trace.h"
 
+#ifdef HAVE_LIBV4L2
+#define open	v4l2_open
+#define close	v4l2_close
+#define dup	v4l2_dup
+#define ioctl	v4l2_ioctl
+#define mmap	v4l2_mmap
+#define munmap	v4l2_munmap
+#endif
+
+#ifdef HAVE_LIBV4L2
+#define open	v4l2_open
+#define close	v4l2_close
+#define dup	v4l2_dup
+#define ioctl	v4l2_ioctl
+#define mmap	v4l2_mmap
+#define munmap	v4l2_munmap
+#endif
+
 namespace webrtc
 {
 namespace videocapturemodule
diff -ruN comm-release/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/video_capture.gypi comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/video_capture.gypi
--- comm-release/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/video_capture.gypi	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/trunk/webrtc/modules/video_capture/video_capture.gypi	2014-04-27 14:07:20.259663796 +0100
@@ -7,6 +7,9 @@
 # be found in the AUTHORS file in the root of the source tree.
 
 {
+  'variables': {
+     'use_libv4l2%': 0,
+  },
   'targets': [
     {
       'target_name': 'video_capture_module',
@@ -47,6 +50,16 @@
         }, {  # include_internal_video_capture == 1
           'conditions': [
             ['include_v4l2_video_capture==1', {
+              'conditions': [
+                ['use_libv4l2==1', {
+                  'defines': [
+                    'HAVE_LIBV4L2',
+                  ],
+                  'libraries': [
+                    '-lv4l2',
+                  ],
+                }],
+              ],
               'include_dirs': [
                 'linux',
               ],
diff -ruN comm-release/mozilla/media/webrtc/trunk/webrtc/system_wrappers/source/spreadsortlib/spreadsort.hpp comm-patched/mozilla/media/webrtc/trunk/webrtc/system_wrappers/source/spreadsortlib/spreadsort.hpp
--- comm-release/mozilla/media/webrtc/trunk/webrtc/system_wrappers/source/spreadsortlib/spreadsort.hpp	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/media/webrtc/trunk/webrtc/system_wrappers/source/spreadsortlib/spreadsort.hpp	2014-04-27 14:07:20.260441520 +0100
@@ -21,6 +21,13 @@
 #include <vector>
 #include "webrtc/system_wrappers/source/spreadsortlib/constants.hpp"
 
+#ifdef __FreeBSD__
+# include <osreldate.h>
+# if __FreeBSD_version < 900506
+#  define getchar boost_getchar
+# endif
+#endif
+
 namespace boost {
   namespace detail {
   	//This only works on unsigned data types
diff -ruN comm-release/mozilla/memory/jemalloc/Makefile.in comm-patched/mozilla/memory/jemalloc/Makefile.in
--- comm-release/mozilla/memory/jemalloc/Makefile.in	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/memory/jemalloc/Makefile.in	2014-04-27 14:07:20.260718834 +0100
@@ -21,3 +21,7 @@
 ifdef GNU_CC
 CFLAGS += -std=gnu99
 endif
+
+# XXX startup crash workaround for gcc47 on amd64
+jemalloc.$(OBJ_SUFFIX): OS_CFLAGS := $(filter-out -O3 -Ofast,$(OS_CFLAGS))
+jemalloc.$(OBJ_SUFFIX): MOZ_OPTIMIZE_FLAGS=
diff -ruN comm-release/mozilla/memory/mozalloc/fallible.h comm-patched/mozilla/memory/mozalloc/fallible.h
--- comm-release/mozilla/memory/mozalloc/fallible.h	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/memory/mozalloc/fallible.h	2014-04-27 14:07:20.260958154 +0100
@@ -5,9 +5,22 @@
 #ifndef mozilla_fallible_h
 #define mozilla_fallible_h
 
+#if defined(MOZALLOC_EXPORT)
+/* do nothing: it's been defined to __declspec(dllexport) by
+ * mozalloc*.cpp on platforms where that's required. */
+#elif defined(XP_WIN) || (defined(XP_OS2) && defined(__declspec))
+#  define MOZALLOC_EXPORT __declspec(dllimport)
+#elif defined(HAVE_VISIBILITY_ATTRIBUTE)
+/* Make sure symbols are still exported even if we're wrapped in a
+ * |visibility push(hidden)| blanket. */
+#  define MOZALLOC_EXPORT __attribute__ ((visibility ("default")))
+#else
+#  define MOZALLOC_EXPORT
+#endif
+
 namespace mozilla {
 
-struct fallible_t { };
+struct MOZALLOC_EXPORT fallible_t { };
 
 } // namespace mozilla
 
diff -ruN comm-release/mozilla/memory/mozalloc/mozalloc.cpp comm-patched/mozilla/memory/mozalloc/mozalloc.cpp
--- comm-release/mozilla/memory/mozalloc/mozalloc.cpp	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/memory/mozalloc/mozalloc.cpp	2014-04-27 14:07:20.261440636 +0100
@@ -227,3 +227,76 @@
 const fallible_t fallible = fallible_t();
 
 } // namespace mozilla
+
+
+MOZALLOC_EXPORT
+void* operator new(size_t size) MOZALLOC_THROW_BAD_ALLOC
+{
+    return moz_xmalloc(size);
+}
+
+MOZALLOC_EXPORT
+void* operator new(size_t size, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_malloc(size);
+}
+
+MOZALLOC_EXPORT
+void* operator new[](size_t size) MOZALLOC_THROW_BAD_ALLOC
+{
+    return moz_xmalloc(size);
+}
+
+MOZALLOC_EXPORT
+void* operator new[](size_t size, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_malloc(size);
+}
+
+MOZALLOC_EXPORT
+void operator delete(void* ptr) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_free(ptr);
+}
+
+MOZALLOC_EXPORT
+void operator delete(void* ptr, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_free(ptr);
+}
+
+MOZALLOC_EXPORT
+void operator delete[](void* ptr) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_free(ptr);
+}
+
+MOZALLOC_EXPORT
+void operator delete[](void* ptr, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_free(ptr);
+}
+
+MOZALLOC_EXPORT
+void* operator new(size_t size, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_malloc(size);
+}
+
+MOZALLOC_EXPORT
+void* operator new[](size_t size, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    return moz_malloc(size);
+}
+
+MOZALLOC_EXPORT
+void operator delete(void* ptr, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    moz_free(ptr);
+}
+
+MOZALLOC_EXPORT
+void operator delete[](void* ptr, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
+{
+    moz_free(ptr);
+}
diff -ruN comm-release/mozilla/memory/mozalloc/mozalloc.h comm-patched/mozilla/memory/mozalloc/mozalloc.h
--- comm-release/mozilla/memory/mozalloc/mozalloc.h	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/memory/mozalloc/mozalloc.h	2014-04-27 14:07:20.261840484 +0100
@@ -39,15 +39,6 @@
 #  define MOZALLOC_EXPORT
 #endif
 
-
-#if defined(MOZ_ALWAYS_INLINE_EVEN_DEBUG)
-#  define MOZALLOC_INLINE MOZ_ALWAYS_INLINE_EVEN_DEBUG
-#elif defined(HAVE_FORCEINLINE)
-#  define MOZALLOC_INLINE __forceinline
-#else
-#  define MOZALLOC_INLINE inline
-#endif
-
 /* Workaround build problem with Sun Studio 12 */
 #if defined(__SUNPRO_C) || defined(__SUNPRO_CC)
 #  undef NS_WARN_UNUSED_RESULT
@@ -171,15 +162,6 @@
  * that |::operator new() throw(std::bad_alloc)| will never return NULL.
  */
 
-/* NB: This is defined just to silence vacuous warnings about symbol
- * visibility on OS X/gcc. These symbols are force-inline and not
- * exported. */
-#if defined(XP_MACOSX)
-#  define MOZALLOC_EXPORT_NEW MOZALLOC_EXPORT
-#else
-#  define MOZALLOC_EXPORT_NEW
-#endif
-
 #if defined(ANDROID) || defined(_MSC_VER)
 /*
  * Android doesn't fully support exceptions, so its <new> header
@@ -195,53 +177,29 @@
 
 #define MOZALLOC_THROW_BAD_ALLOC MOZALLOC_THROW_BAD_ALLOC_IF_HAS_EXCEPTIONS
 
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void* operator new(size_t size) MOZALLOC_THROW_BAD_ALLOC
-{
-    return moz_xmalloc(size);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void* operator new(size_t size, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_malloc(size);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void* operator new[](size_t size) MOZALLOC_THROW_BAD_ALLOC
-{
-    return moz_xmalloc(size);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void* operator new[](size_t size, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_malloc(size);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void operator delete(void* ptr) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_free(ptr);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void operator delete(void* ptr, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_free(ptr);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void operator delete[](void* ptr) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_free(ptr);
-}
-
-MOZALLOC_EXPORT_NEW MOZALLOC_INLINE
-void operator delete[](void* ptr, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_free(ptr);
-}
+MOZALLOC_EXPORT
+void* operator new(size_t size) MOZALLOC_THROW_BAD_ALLOC;
+
+MOZALLOC_EXPORT
+void* operator new(size_t size, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void* operator new[](size_t size) MOZALLOC_THROW_BAD_ALLOC;
+
+MOZALLOC_EXPORT
+void* operator new[](size_t size, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void operator delete(void* ptr) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void operator delete(void* ptr, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void operator delete[](void* ptr) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void operator delete[](void* ptr, const std::nothrow_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
 
 
 /*
@@ -263,29 +221,17 @@
  *   (4) the matching system |operator delete(void*) throw(std::bad_alloc)|
  */
 
-MOZALLOC_INLINE
-void* operator new(size_t size, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_malloc(size);
-}
-
-MOZALLOC_INLINE
-void* operator new[](size_t size, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    return moz_malloc(size);
-}
-
-MOZALLOC_INLINE
-void operator delete(void* ptr, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    moz_free(ptr);
-}
-
-MOZALLOC_INLINE
-void operator delete[](void* ptr, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS
-{
-    moz_free(ptr);
-}
+MOZALLOC_EXPORT
+void* operator new(size_t size, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void* operator new[](size_t size, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void operator delete(void* ptr, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
+
+MOZALLOC_EXPORT
+void operator delete[](void* ptr, const mozilla::fallible_t&) MOZALLOC_THROW_IF_HAS_EXCEPTIONS;
 
 #endif  /* ifdef __cplusplus */
 
diff -ruN comm-release/mozilla/memory/mozalloc/mozalloc_abort.cpp comm-patched/mozilla/memory/mozalloc/mozalloc_abort.cpp
--- comm-release/mozilla/memory/mozalloc/mozalloc_abort.cpp	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/memory/mozalloc/mozalloc_abort.cpp	2014-04-27 14:07:20.261170572 +0100
@@ -34,7 +34,11 @@
 // Define abort() here, so that it is used instead of the system abort(). This
 // lets us control the behavior when aborting, in order to get better results
 // on *NIX platforms. See mozalloc_abort for details.
+#if defined(SOLARIS)
+void std::abort(void)
+#else
 void abort(void)
+#endif
 {
     mozalloc_abort("Redirecting call to abort() to mozalloc_abort\n");
 }
diff -ruN comm-release/mozilla/mfbt/Poison.cpp comm-patched/mozilla/mfbt/Poison.cpp
--- comm-release/mozilla/mfbt/Poison.cpp	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/mfbt/Poison.cpp	2014-04-27 14:07:20.262105928 +0100
@@ -125,7 +125,11 @@
 static bool
 ProbeRegion(uintptr_t region, uintptr_t size)
 {
+#if !defined(__sun__)
   if (madvise(reinterpret_cast<void*>(region), size, MADV_NORMAL)) {
+#else
+  if (posix_madvise(reinterpret_cast<void*>(region), size, MADV_NORMAL)) {
+#endif
     return true;
   } else {
     return false;
diff -ruN comm-release/mozilla/mfbt/lz4.c comm-patched/mozilla/mfbt/lz4.c
--- comm-release/mozilla/mfbt/lz4.c	2014-03-19 01:42:09.000000000 +0000
+++ comm-patched/mozilla/mfbt/lz4.c	2014-04-27 14:37:24.113729933 +0100
@@ -545,7 +545,7 @@
                  )
 {
     // Local Variables
-    const BYTE* restrict ip = (const BYTE*) source;
+    const BYTE*  __restrict__ ip = (const BYTE*) source;
     const BYTE* ref;
     const BYTE* const iend = ip + inputSize;
 
diff -ruN comm-release/mozilla/modules/libjar/nsZipArchive.cpp comm-patched/mozilla/modules/libjar/nsZipArchive.cpp
--- comm-release/mozilla/modules/libjar/nsZipArchive.cpp	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/modules/libjar/nsZipArchive.cpp	2014-04-27 14:07:20.266157043 +0100
@@ -595,7 +595,9 @@
     // Success means optimized jar layout from bug 559961 is in effect
     uint32_t readaheadLength = xtolong(startp);
     if (readaheadLength) {
-#if defined(XP_UNIX)
+#if defined(OS_SOLARIS)
+      posix_madvise(const_cast<uint8_t*>(startp), readaheadLength, POSIX_MADV_WILLNEED);
+#elif defined(XP_UNIX)
       madvise(const_cast<uint8_t*>(startp), readaheadLength, MADV_WILLNEED);
 #elif defined(XP_WIN)
       if (aFd) {
diff -ruN comm-release/mozilla/netwerk/dns/Makefile.in comm-patched/mozilla/netwerk/dns/Makefile.in
--- comm-release/mozilla/netwerk/dns/Makefile.in	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/dns/Makefile.in	2014-04-27 14:07:20.266502274 +0100
@@ -9,3 +9,7 @@
 # for effective TLD data.
 etld_data.inc: $(srcdir)/prepare_tlds.py $(srcdir)/effective_tld_names.dat
 	$(PYTHON) $(srcdir)/prepare_tlds.py $(srcdir)/effective_tld_names.dat > etld_data.inc
+
+ifdef MOZ_NATIVE_HARFBUZZ
+nsIDNService.$(OBJ_SUFFIX): CXXFLAGS+=$(MOZ_HARFBUZZ_CFLAGS)
+endif
diff -ruN comm-release/mozilla/netwerk/sctp/src/netinet/sctp_os_userspace.h comm-patched/mozilla/netwerk/sctp/src/netinet/sctp_os_userspace.h
--- comm-release/mozilla/netwerk/sctp/src/netinet/sctp_os_userspace.h	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/sctp/src/netinet/sctp_os_userspace.h	2014-04-27 14:07:20.267012416 +0100
@@ -383,7 +383,7 @@
 #else /* !defined(Userspace_os_Windows) */
 #include <sys/cdefs.h> /* needed? added from old __FreeBSD__ */
 #include <sys/socket.h>
-#if defined(__Userspace_os_FreeBSD) || defined(__Userspace_os_OpenBSD) || defined(ANDROID)
+#if defined(__Userspace_os_FreeBSD) || defined(__Userspace_os_OpenBSD) || defined(ANDROID) || defined(__Userspace_os_NetBSD)
 #include <pthread.h>
 #endif
 typedef pthread_mutex_t userland_mutex_t;
@@ -397,7 +397,9 @@
 #define MA_OWNED 7 /* sys/mutex.h typically on FreeBSD */
 #if !defined(__Userspace_os_FreeBSD)
 struct mtx {int dummy;};
+#if !defined(__Userspace_os_NetBSD)
 struct selinfo {int dummy;};
+#endif
 struct sx {int dummy;};
 #endif
 
@@ -500,7 +502,7 @@
 #include <netinet/ip6.h>
 #include <netinet/icmp6.h>
 #endif
-#if defined(__Userspace_os_Linux) || defined(__Userspace_os_Darwin) || defined(__Userspace_os_FreeBSD) || defined(__Userspace_os_OpenBSD) ||defined(__Userspace_os_Windows)
+#if defined(__Userspace_os_Linux) || defined(__Userspace_os_Darwin) || defined(__Userspace_os_FreeBSD) || defined(__Userspace_os_OpenBSD) ||defined(__Userspace_os_Windows) || defined(__Userspace_os_NetBSD)
 #include "user_ip6_var.h"
 #else
 #include <netinet6/ip6_var.h>
@@ -1120,6 +1122,8 @@
 #if defined(__Userspace_os_FreeBSD) || defined(__Userspace_os_OpenBSD)
 /* stolen from /usr/include/sys/socket.h */
 #define CMSG_ALIGN(n)   _ALIGN(n)
+#elif defined(__Userspace_os_NetBSD)
+#define CMSG_ALIGN(n)   (((n) + __ALIGNBYTES) & ~__ALIGNBYTES)
 #elif defined(__Userspace_os_Darwin)
 #if !defined(__DARWIN_ALIGNBYTES)
 #define	__DARWIN_ALIGNBYTES	(sizeof(__darwin_size_t) - 1)
diff -ruN comm-release/mozilla/netwerk/sctp/src/netinet/sctp_usrreq.c comm-patched/mozilla/netwerk/sctp/src/netinet/sctp_usrreq.c
--- comm-release/mozilla/netwerk/sctp/src/netinet/sctp_usrreq.c	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/sctp/src/netinet/sctp_usrreq.c	2014-04-27 14:07:20.268642511 +0100
@@ -414,6 +414,8 @@
 	    (icmph->icmp_code == ICMP_UNREACH_HOST_PROHIB) ||
 #ifdef __Panda__
 	    (icmph->icmp_code == ICMP_UNREACH_ADMIN)) {
+#elif defined(__Userspace_os_NetBSD)
+	    (icmph->icmp_code == ICMP_UNREACH_ADMIN_PROHIBIT)) {
 #else
 	    (icmph->icmp_code == ICMP_UNREACH_FILTER_PROHIB)) {
 #endif
diff -ruN comm-release/mozilla/netwerk/sctp/src/netinet6/sctp6_usrreq.c comm-patched/mozilla/netwerk/sctp/src/netinet6/sctp6_usrreq.c
--- comm-release/mozilla/netwerk/sctp/src/netinet6/sctp6_usrreq.c	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/sctp/src/netinet6/sctp6_usrreq.c	2014-04-27 14:07:20.269275121 +0100
@@ -459,6 +459,8 @@
 	    (icmph->icmp6_code == ICMP_UNREACH_HOST_PROHIB) ||
 #ifdef __Panda__
             (icmph->icmp6_code == ICMP_UNREACH_ADMIN)) {
+#elif defined(__Userspace_os_NetBSD)
+            (icmph->icmp6_code == ICMP_UNREACH_ADMIN_PROHIBIT)) {
 #else
             (icmph->icmp6_code == ICMP_UNREACH_FILTER_PROHIB)) {
 #endif
diff -ruN comm-release/mozilla/netwerk/sctp/src/user_recv_thread.c comm-patched/mozilla/netwerk/sctp/src/user_recv_thread.c
--- comm-release/mozilla/netwerk/sctp/src/user_recv_thread.c	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/sctp/src/user_recv_thread.c	2014-04-27 14:07:20.269785681 +0100
@@ -35,7 +35,7 @@
 #include <netinet/in.h>
 #include <unistd.h>
 #include <pthread.h>
-#if !defined(__Userspace_os_FreeBSD)
+#if !defined(__Userspace_os_FreeBSD) && !defined(__Userspace_os_NetBSD)
 #include <sys/uio.h>
 #else
 #include <user_ip6_var.h>
diff -ruN comm-release/mozilla/netwerk/sctp/src/user_socket.c comm-patched/mozilla/netwerk/sctp/src/user_socket.c
--- comm-release/mozilla/netwerk/sctp/src/user_socket.c	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/sctp/src/user_socket.c	2014-04-27 14:07:20.270688007 +0100
@@ -1044,8 +1044,13 @@
 		    (struct sctp_sndrcvinfo *)sinfo, 1);
 
 	if (error) {
+#if defined(__Userspace_os_NetBSD)
+		if (auio.uio_resid != (int)ulen && (
+		    error == EINTR || error == EWOULDBLOCK))
+#else
 		if (auio.uio_resid != (int)ulen && (error == ERESTART ||
 		    error == EINTR || error == EWOULDBLOCK))
+#endif
 			error = 0;
 		}
 	if ((fromlenp != NULL) && (fromlen > 0) && (from != NULL)) {
@@ -1133,7 +1138,11 @@
 		    (struct sctp_sndrcvinfo *)&seinfo, 1);
 	if (errno) {
 		if (auio.uio_resid != (int)ulen &&
+#if defined(__Userspace_os_NetBSD)
+		    (errno == EINTR || errno == EWOULDBLOCK)) {
+#else
 		    (errno == ERESTART || errno == EINTR || errno == EWOULDBLOCK)) {
+#endif
 			errno = 0;
 		}
 	}
@@ -2083,7 +2092,11 @@
 		error = pthread_cond_wait(SOCK_COND(so), SOCK_MTX(so));
 #endif
 		if (error) {
+#if defined(__Userspace_os_NetBSD)
+			if (error == EINTR)
+#else
 			if (error == EINTR || error == ERESTART)
+#endif
 				interrupted = 1;
 			break;
 		}
@@ -2097,8 +2110,10 @@
 bad:
 	if (!interrupted)
 		so->so_state &= ~SS_ISCONNECTING;
+#if !defined(__Userspace_os_NetBSD)
 	if (error == ERESTART)
 		error = EINTR;
+#endif
 done1:
 	return (error);
 }
diff -ruN comm-release/mozilla/netwerk/sctp/src/user_socketvar.h comm-patched/mozilla/netwerk/sctp/src/user_socketvar.h
--- comm-release/mozilla/netwerk/sctp/src/user_socketvar.h	2014-03-19 01:42:11.000000000 +0000
+++ comm-patched/mozilla/netwerk/sctp/src/user_socketvar.h	2014-04-27 14:07:20.271170885 +0100
@@ -47,7 +47,7 @@
 /* #include <sys/_lock.h>  was 0 byte file */
 /* #include <sys/_mutex.h> was 0 byte file */
 /* #include <sys/_sx.h> */ /*__Userspace__ alternative?*/
-#if !defined(__Userspace_os_Windows) && !defined(__Userspace_os_FreeBSD)
+#if !defined(__Userspace_os_Windows) && !defined(__Userspace_os_FreeBSD) && !defined(__Userspace_os_NetBSD)
 #include <sys/uio.h>
 #endif
 #define SOCK_MAXADDRLEN 255
@@ -64,11 +64,11 @@
 #define ERESTART (-1)
 #endif
 
-#if !defined(__Userspace_os_Darwin) && !defined(__Userspace_os_OpenBSD)
+#if !defined(__Userspace_os_Darwin) && !defined(__Userspace_os_OpenBSD) && !defined(__Userspace_os_NetBSD)
 enum	uio_rw { UIO_READ, UIO_WRITE };
 #endif
 
-#if !defined(__Userspace_os_OpenBSD)
+#if !defined(__Userspace_os_OpenBSD) && !defined(__Userspace_os_NetBSD)
 /* Segment flag values. */
 enum uio_seg {
 	UIO_USERSPACE,		/* from user data space */
diff -ruN comm-release/mozilla/netwerk/wifi/moz.build comm-patched/mozilla/netwerk/wifi/moz.build
--- comm-release/mozilla/netwerk/wifi/moz.build	2014-03-19 01:42:12.000000000 +0000
+++ comm-patched/mozilla/netwerk/wifi/moz.build	2014-04-27 14:07:20.271417035 +0100
@@ -35,6 +35,10 @@
     UNIFIED_SOURCES += [
         'osx_corewlan.mm',
     ]
+elif CONFIG['OS_ARCH'] == 'FreeBSD':
+    UNIFIED_SOURCES += [
+        'nsWifiScannerFreeBSD.cpp',
+    ]
 elif CONFIG['OS_ARCH'] == 'WINNT':
     UNIFIED_SOURCES += [
         'nsWifiScannerWin.cpp',
diff -ruN comm-release/mozilla/netwerk/wifi/nsWifiScannerFreeBSD.cpp comm-patched/mozilla/netwerk/wifi/nsWifiScannerFreeBSD.cpp
--- comm-release/mozilla/netwerk/wifi/nsWifiScannerFreeBSD.cpp	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/netwerk/wifi/nsWifiScannerFreeBSD.cpp	2014-04-27 14:07:20.271686788 +0100
@@ -0,0 +1,167 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+// Developed by J.R. Oldroyd <fbsd@opal.com>, December 2012.
+
+// For FreeBSD we use the getifaddrs(3) to obtain the list of interfaces
+// and then check for those with an 802.11 media type and able to return
+// a list of stations. This is similar to ifconfig(8).
+
+#include <sys/types.h>
+#include <sys/ioctl.h>
+#include <sys/socket.h>
+#include <net/if.h>
+#include <net/if_media.h>
+#include <net80211/ieee80211_ioctl.h>
+
+#include <ifaddrs.h>
+#include <string.h>
+#include <unistd.h>
+
+#include "nsWifiAccessPoint.h"
+
+using namespace mozilla;
+
+static nsresult
+FreeBSDGetAccessPointData(nsCOMArray<nsWifiAccessPoint> &accessPoints)
+{
+  // get list of interfaces
+  struct ifaddrs *ifal;
+  if (getifaddrs(&ifal) < 0) {
+    return NS_ERROR_FAILURE;
+  }
+
+  accessPoints.Clear();
+
+  // loop through the interfaces
+  nsresult rv = NS_ERROR_FAILURE;
+  struct ifaddrs *ifa;
+  for (ifa = ifal; ifa; ifa = ifa->ifa_next) {
+    // limit to one interface per address
+    if (ifa->ifa_addr->sa_family != AF_LINK) {
+      continue;
+    }
+
+    // store interface name in socket structure
+    struct ifreq ifr;
+    memset(&ifr, 0, sizeof(ifr));
+    strncpy(ifr.ifr_name, ifa->ifa_name, sizeof(ifr.ifr_name));
+    ifr.ifr_addr.sa_family = AF_LOCAL;
+
+    // open socket to interface
+    int s = socket(ifr.ifr_addr.sa_family, SOCK_DGRAM, 0);
+    if (s < 0) {
+      continue;
+    }
+
+    // clear interface media structure
+    struct ifmediareq ifmr;
+    memset(&ifmr, 0, sizeof(ifmr));
+    strncpy(ifmr.ifm_name, ifa->ifa_name, sizeof(ifmr.ifm_name));
+
+    // get interface media information
+    if (ioctl(s, SIOCGIFMEDIA, (caddr_t)&ifmr) < 0) {
+      close(s);
+      continue;
+    }
+
+    // check interface is a WiFi interface
+    if (IFM_TYPE(ifmr.ifm_active) != IFM_IEEE80211) {
+      close(s);
+      continue;
+    }
+
+    // perform WiFi scan
+    struct ieee80211req i802r;
+    char iscanbuf[32*1024];
+    memset(&i802r, 0, sizeof(i802r));
+    strncpy(i802r.i_name, ifa->ifa_name, sizeof(i802r.i_name));
+    i802r.i_type = IEEE80211_IOC_SCAN_RESULTS;
+    i802r.i_data = iscanbuf;
+    i802r.i_len = sizeof(iscanbuf);
+    if (ioctl(s, SIOCG80211, &i802r) < 0) {
+      close(s);
+      continue;
+    }
+
+    // close socket
+    close(s);
+
+    // loop through WiFi networks and build geoloc-lookup structure
+    char *vsr = (char *) i802r.i_data;
+    unsigned len = i802r.i_len;
+    while (len >= sizeof(struct ieee80211req_scan_result)) {
+      struct ieee80211req_scan_result *isr =
+        (struct ieee80211req_scan_result *) vsr;
+
+      // determine size of this entry
+      char *id;
+      int idlen;
+      if (isr->isr_meshid_len) {
+        id = vsr + isr->isr_ie_off + isr->isr_ssid_len;
+        idlen = isr->isr_meshid_len;
+      } else {
+        id = vsr + isr->isr_ie_off;
+        idlen = isr->isr_ssid_len;
+      }
+
+      // copy network data
+      char ssid[IEEE80211_NWID_LEN+1];
+      strncpy(ssid, id, idlen);
+      ssid[idlen] = '\0';
+      nsWifiAccessPoint *ap = new nsWifiAccessPoint();
+      ap->setSSID(ssid, strlen(ssid));
+      ap->setMac(isr->isr_bssid);
+      ap->setSignal(isr->isr_rssi);
+      accessPoints.AppendObject(ap);
+      rv = NS_OK;
+
+      // log the data
+      LOG(( "FreeBSD access point: "
+            "SSID: %s, MAC: %02x-%02x-%02x-%02x-%02x-%02x, "
+            "Strength: %d, Channel: %dMHz\n",
+            ssid, isr->isr_bssid[0], isr->isr_bssid[1], isr->isr_bssid[2],
+            isr->isr_bssid[3], isr->isr_bssid[4], isr->isr_bssid[5],
+            isr->isr_rssi, isr->isr_freq));
+
+      // increment pointers
+      len -= isr->isr_len;
+      vsr += isr->isr_len;
+    }
+  }
+
+  freeifaddrs(ifal);
+
+  return rv;
+}
+
+nsresult
+nsWifiMonitor::DoScan()
+{
+  // Regularly get the access point data.
+
+  nsCOMArray<nsWifiAccessPoint> lastAccessPoints;
+  nsCOMArray<nsWifiAccessPoint> accessPoints;
+
+  do {
+    nsresult rv = FreeBSDGetAccessPointData(accessPoints);
+    if (NS_FAILED(rv))
+      return rv;
+
+    bool accessPointsChanged = !AccessPointsEqual(accessPoints, lastAccessPoints);
+    ReplaceArray(lastAccessPoints, accessPoints);
+
+    rv = CallWifiListeners(lastAccessPoints, accessPointsChanged);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    // wait for some reasonable amount of time. pref?
+    LOG(("waiting on monitor\n"));
+
+    ReentrantMonitorAutoEnter mon(mReentrantMonitor);
+    mon.Wait(PR_SecondsToInterval(60));
+  }
+  while (mKeepGoing);
+
+  return NS_OK;
+}
Binary files comm-release/mozilla/other-licenses/ply/ply/__init__.pyc and comm-patched/mozilla/other-licenses/ply/ply/__init__.pyc differ
Binary files comm-release/mozilla/other-licenses/ply/ply/lex.pyc and comm-patched/mozilla/other-licenses/ply/ply/lex.pyc differ
Binary files comm-release/mozilla/other-licenses/ply/ply/yacc.pyc and comm-patched/mozilla/other-licenses/ply/ply/yacc.pyc differ
Binary files comm-release/mozilla/python/blessings/blessings/__init__.pyc and comm-patched/mozilla/python/blessings/blessings/__init__.pyc differ
Binary files comm-release/mozilla/python/codegen/makeutils.pyc and comm-patched/mozilla/python/codegen/makeutils.pyc differ
Binary files comm-release/mozilla/python/mach/mach/__init__.pyc and comm-patched/mozilla/python/mach/mach/__init__.pyc differ
Binary files comm-release/mozilla/python/mach/mach/base.pyc and comm-patched/mozilla/python/mach/mach/base.pyc differ
Binary files comm-release/mozilla/python/mach/mach/config.pyc and comm-patched/mozilla/python/mach/mach/config.pyc differ
Binary files comm-release/mozilla/python/mach/mach/decorators.pyc and comm-patched/mozilla/python/mach/mach/decorators.pyc differ
Binary files comm-release/mozilla/python/mach/mach/logging.pyc and comm-patched/mozilla/python/mach/mach/logging.pyc differ
Binary files comm-release/mozilla/python/mach/mach/mixin/__init__.pyc and comm-patched/mozilla/python/mach/mach/mixin/__init__.pyc differ
Binary files comm-release/mozilla/python/mach/mach/mixin/logging.pyc and comm-patched/mozilla/python/mach/mach/mixin/logging.pyc differ
Binary files comm-release/mozilla/python/mach/mach/mixin/process.pyc and comm-patched/mozilla/python/mach/mach/mixin/process.pyc differ
Binary files comm-release/mozilla/python/mach/mach/registrar.pyc and comm-patched/mozilla/python/mach/mach/registrar.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/action/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/action/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/action/buildlist.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/action/buildlist.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/backend/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/backend/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/backend/base.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/backend/base.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/backend/common.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/backend/common.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/backend/configenvironment.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/backend/configenvironment.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/backend/recursivemake.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/backend/recursivemake.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/base.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/base.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/config.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/config.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/frontend/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/frontend/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/frontend/data.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/frontend/data.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/frontend/emitter.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/frontend/emitter.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/frontend/reader.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/frontend/reader.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/frontend/sandbox.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/frontend/sandbox.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/frontend/sandbox_symbols.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/frontend/sandbox_symbols.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/jar.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/jar.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/makeutil.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/makeutil.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/mozconfig.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/mozconfig.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/mozinfo.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/mozinfo.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/preprocessor.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/preprocessor.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/pythonutil.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/pythonutil.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/util.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/util.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozbuild/virtualenv.pyc and comm-patched/mozilla/python/mozbuild/mozbuild/virtualenv.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozpack/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/chrome/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozpack/chrome/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/chrome/flags.pyc and comm-patched/mozilla/python/mozbuild/mozpack/chrome/flags.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/chrome/manifest.pyc and comm-patched/mozilla/python/mozbuild/mozpack/chrome/manifest.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/copier.pyc and comm-patched/mozilla/python/mozbuild/mozpack/copier.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/errors.pyc and comm-patched/mozilla/python/mozbuild/mozpack/errors.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/executables.pyc and comm-patched/mozilla/python/mozbuild/mozpack/executables.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/files.pyc and comm-patched/mozilla/python/mozbuild/mozpack/files.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/manifests.pyc and comm-patched/mozilla/python/mozbuild/mozpack/manifests.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/mozjar.pyc and comm-patched/mozilla/python/mozbuild/mozpack/mozjar.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/packager/__init__.pyc and comm-patched/mozilla/python/mozbuild/mozpack/packager/__init__.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/packager/formats.pyc and comm-patched/mozilla/python/mozbuild/mozpack/packager/formats.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/packager/unpack.pyc and comm-patched/mozilla/python/mozbuild/mozpack/packager/unpack.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/path.pyc and comm-patched/mozilla/python/mozbuild/mozpack/path.pyc differ
Binary files comm-release/mozilla/python/mozbuild/mozpack/unify.pyc and comm-patched/mozilla/python/mozbuild/mozpack/unify.pyc differ
Binary files comm-release/mozilla/python/psutil/_psutil_posix.so and comm-patched/mozilla/python/psutil/_psutil_posix.so differ
Binary files comm-release/mozilla/python/psutil/_psutil_sunos.so and comm-patched/mozilla/python/psutil/_psutil_sunos.so differ
Binary files comm-release/mozilla/python/psutil/build/lib.solaris-2.11-i86pc.32bit-2.7/_psutil_posix.so and comm-patched/mozilla/python/psutil/build/lib.solaris-2.11-i86pc.32bit-2.7/_psutil_posix.so differ
Binary files comm-release/mozilla/python/psutil/build/lib.solaris-2.11-i86pc.32bit-2.7/_psutil_sunos.so and comm-patched/mozilla/python/psutil/build/lib.solaris-2.11-i86pc.32bit-2.7/_psutil_sunos.so differ
Binary files comm-release/mozilla/python/psutil/build/temp.solaris-2.11-i86pc.32bit-2.7/psutil/_psutil_posix.o and comm-patched/mozilla/python/psutil/build/temp.solaris-2.11-i86pc.32bit-2.7/psutil/_psutil_posix.o differ
Binary files comm-release/mozilla/python/psutil/build/temp.solaris-2.11-i86pc.32bit-2.7/psutil/_psutil_sunos.o and comm-patched/mozilla/python/psutil/build/temp.solaris-2.11-i86pc.32bit-2.7/psutil/_psutil_sunos.o differ
Binary files comm-release/mozilla/python/virtualenv/virtualenv.pyc and comm-patched/mozilla/python/virtualenv/virtualenv.pyc differ
Binary files comm-release/mozilla/python/which/which.pyc and comm-patched/mozilla/python/which/which.pyc differ
diff -ruN comm-release/mozilla/security/manager/ssl/src/JARSignatureVerification.cpp comm-patched/mozilla/security/manager/ssl/src/JARSignatureVerification.cpp
--- comm-release/mozilla/security/manager/ssl/src/JARSignatureVerification.cpp	2014-03-19 01:42:12.000000000 +0000
+++ comm-patched/mozilla/security/manager/ssl/src/JARSignatureVerification.cpp	2014-04-27 14:07:20.272065215 +0100
@@ -596,9 +596,9 @@
   }
 
   // Verify that the signature file is a valid signature of the SF file
-  if (!SEC_PKCS7VerifyDetachedSignatureAtTime(p7_info, certUsageObjectSigner,
-                                              &sfCalculatedDigest.get(),
-                                              HASH_AlgSHA1, false, PR_Now())) {
+  if (!SEC_PKCS7VerifyDetachedSignature(p7_info, certUsageObjectSigner,
+                                        &sfCalculatedDigest.get(), HASH_AlgSHA1,
+                                        false)) {
     PRErrorCode error = PR_GetError();
     const char * errorName = PR_ErrorToName(error);
     PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, ("Failed to verify detached signature: %s",
diff -ruN comm-release/mozilla/security/manager/ssl/src/nsNSSComponent.cpp comm-patched/mozilla/security/manager/ssl/src/nsNSSComponent.cpp
--- comm-release/mozilla/security/manager/ssl/src/nsNSSComponent.cpp	2014-03-19 01:42:13.000000000 +0000
+++ comm-patched/mozilla/security/manager/ssl/src/nsNSSComponent.cpp	2014-04-27 14:07:20.272670267 +0100
@@ -53,6 +53,7 @@
 
 #include "nss.h"
 #include "ssl.h"
+#define NSS_ENABLE_ECC 1
 #include "sslproto.h"
 #include "secmod.h"
 #include "secmime.h"
diff -ruN comm-release/mozilla/storage/src/SQLiteMutex.h comm-patched/mozilla/storage/src/SQLiteMutex.h
--- comm-release/mozilla/storage/src/SQLiteMutex.h	2014-03-19 01:42:14.000000000 +0000
+++ comm-patched/mozilla/storage/src/SQLiteMutex.h	2014-04-27 14:07:20.220117906 +0100
@@ -108,15 +108,19 @@
   void assertCurrentThreadOwns()
   {
     NS_ASSERTION(mMutex, "No mutex associated with this wrapper!");
+#if 0
     NS_ASSERTION(sqlite3_mutex_held(mMutex),
                  "Mutex is not held, but we expect it to be!");
+#endif
   }
 
   void assertNotCurrentThreadOwns()
   {
     NS_ASSERTION(mMutex, "No mutex associated with this wrapper!");
+#if 0
     NS_ASSERTION(sqlite3_mutex_notheld(mMutex),
                  "Mutex is held, but we expect it to not be!");
+#endif
   }
 #endif // ifndef DEBUG
 
diff -ruN comm-release/mozilla/storage/src/mozStorageConnection.cpp comm-patched/mozilla/storage/src/mozStorageConnection.cpp
--- comm-release/mozilla/storage/src/mozStorageConnection.cpp	2014-03-19 01:42:14.000000000 +0000
+++ comm-patched/mozilla/storage/src/mozStorageConnection.cpp	2014-04-27 14:07:20.213515359 +0100
@@ -694,6 +694,11 @@
       break;
   }
 
+  // XXX tnn: the configure script demands that sqlite3 is compiled with
+  // SECURE_DELETE on by default. sqlite3 in pkgsrc does not have that,
+  // so instead we enable secure_delete manually here.
+  (void)ExecuteSimpleSQL(NS_LITERAL_CSTRING("PRAGMA secure_delete = 1;"));
+
   return NS_OK;
 }
 
Binary files comm-release/mozilla/testing/mozbase/manifestdestiny/manifestparser/__init__.pyc and comm-patched/mozilla/testing/mozbase/manifestdestiny/manifestparser/__init__.pyc differ
Binary files comm-release/mozilla/testing/mozbase/manifestdestiny/manifestparser/manifestparser.pyc and comm-patched/mozilla/testing/mozbase/manifestdestiny/manifestparser/manifestparser.pyc differ
Binary files comm-release/mozilla/testing/mozbase/mozfile/mozfile/__init__.pyc and comm-patched/mozilla/testing/mozbase/mozfile/mozfile/__init__.pyc differ
Binary files comm-release/mozilla/testing/mozbase/mozfile/mozfile/mozfile.pyc and comm-patched/mozilla/testing/mozbase/mozfile/mozfile/mozfile.pyc differ
Binary files comm-release/mozilla/testing/mozbase/mozinfo/mozinfo/__init__.pyc and comm-patched/mozilla/testing/mozbase/mozinfo/mozinfo/__init__.pyc differ
Binary files comm-release/mozilla/testing/mozbase/mozinfo/mozinfo/mozinfo.pyc and comm-patched/mozilla/testing/mozbase/mozinfo/mozinfo/mozinfo.pyc differ
Binary files comm-release/mozilla/testing/mozbase/mozprocess/mozprocess/__init__.pyc and comm-patched/mozilla/testing/mozbase/mozprocess/mozprocess/__init__.pyc differ
Binary files comm-release/mozilla/testing/mozbase/mozprocess/mozprocess/processhandler.pyc and comm-patched/mozilla/testing/mozbase/mozprocess/mozprocess/processhandler.pyc differ
diff -ruN comm-release/mozilla/toolkit/components/osfile/modules/osfile_unix_allthreads.jsm comm-patched/mozilla/toolkit/components/osfile/modules/osfile_unix_allthreads.jsm
--- comm-release/mozilla/toolkit/components/osfile/modules/osfile_unix_allthreads.jsm	2014-03-19 01:42:15.000000000 +0000
+++ comm-patched/mozilla/toolkit/components/osfile/modules/osfile_unix_allthreads.jsm	2014-04-27 14:07:20.273120217 +0100
@@ -41,7 +41,7 @@
 // Open libc
 let libc;
 let libc_candidates =  [ "libSystem.B.dylib",
-                         "libc.so.6",
+                         "libc.so.7",
                          "libc.so" ];
 for (let i = 0; i < libc_candidates.length; ++i) {
   try {
diff -ruN comm-release/mozilla/toolkit/components/osfile/modules/osfile_unix_back.jsm comm-patched/mozilla/toolkit/components/osfile/modules/osfile_unix_back.jsm
--- comm-release/mozilla/toolkit/components/osfile/modules/osfile_unix_back.jsm	2014-03-19 01:42:15.000000000 +0000
+++ comm-patched/mozilla/toolkit/components/osfile/modules/osfile_unix_back.jsm	2014-04-27 14:07:20.273498149 +0100
@@ -558,18 +558,19 @@
            return Stat.fxstat(ver, fd, buf);
          };
        } else if (OS.Constants.Sys.Name == "NetBSD") {
-         // NetBSD 5.0 and newer
-         declareLazyFFI(SysFile,  "stat", libc, "__stat50", ctypes.default_abi,
+         // NetBSD 5.0 uses *30, and netbsd-6 uses *50
+         let v = OS.Constants.libc.OSFILE_SIZEOF_TIME_T < 8 ? "30" : "50";
+         declareLazyFFI(SysFile,  "stat", libc, "__stat"+v, ctypes.default_abi,
                       /*return*/ Type.negativeone_or_nothing,
                       /*path*/   Type.path,
                       /*buf*/    Type.stat.out_ptr
                      );
-         declareLazyFFI(SysFile,  "lstat", libc, "__lstat50", ctypes.default_abi,
+         declareLazyFFI(SysFile,  "lstat", libc, "__lstat"+v, ctypes.default_abi,
                       /*return*/ Type.negativeone_or_nothing,
                       /*path*/   Type.path,
                       /*buf*/    Type.stat.out_ptr
                      );
-         declareLazyFFI(SysFile,  "fstat", libc, "__fstat50", ctypes.default_abi,
+         declareLazyFFI(SysFile,  "fstat", libc, "__fstat"+v, ctypes.default_abi,
                       /*return*/ Type.negativeone_or_nothing,
                       /*fd*/     Type.fd,
                       /*buf*/    Type.stat.out_ptr
Binary files comm-release/mozilla/toolkit/components/telemetry/histogram_tools.pyc and comm-patched/mozilla/toolkit/components/telemetry/histogram_tools.pyc differ
diff -ruN comm-release/mozilla/toolkit/library/Makefile.in comm-patched/mozilla/toolkit/library/Makefile.in
--- comm-release/mozilla/toolkit/library/Makefile.in	2014-03-19 01:42:16.000000000 +0000
+++ comm-patched/mozilla/toolkit/library/Makefile.in	2014-04-27 14:07:20.273846968 +0100
@@ -164,6 +164,18 @@
 EXTRA_DSO_LDOPTS += $(MOZ_HUNSPELL_LIBS)
 endif
 
+ifdef MOZ_NATIVE_OGG
+EXTRA_DSO_LDOPTS += $(MOZ_OGG_LIBS)
+endif
+
+ifdef MOZ_NATIVE_VORBIS
+EXTRA_DSO_LDOPTS += $(MOZ_VORBIS_LIBS)
+endif
+
+ifdef MOZ_NATIVE_OPUS
+EXTRA_DSO_LDOPTS += $(MOZ_OPUS_LIBS)
+endif
+
 ifdef MOZ_NATIVE_LIBEVENT
 EXTRA_DSO_LDOPTS += $(MOZ_LIBEVENT_LIBS)
 endif
@@ -176,6 +188,14 @@
 EXTRA_DSO_LDOPTS += $(MOZ_PIXMAN_LIBS)
 endif
 
+ifdef MOZ_NATIVE_GRAPHITE2
+EXTRA_DSO_LDOPTS += $(MOZ_GRAPHITE2_LIBS)
+endif
+
+ifdef MOZ_NATIVE_HARFBUZZ
+EXTRA_DSO_LDOPTS += $(MOZ_HARFBUZZ_LIBS)
+endif
+
 ifdef MOZ_DMD
 EXTRA_DSO_LDOPTS += $(call EXPAND_LIBNAME_PATH,dmd,$(DIST)/lib)
 endif
@@ -183,6 +203,7 @@
 EXTRA_DSO_LDOPTS += $(call EXPAND_LIBNAME_PATH,gkmedias,$(DIST)/lib)
 
 ifdef MOZ_WEBRTC
+EXTRA_DSO_LDOPTS += $(MOZ_LIBV4L2_LIBS)
 ifdef MOZ_WEBRTC_SIGNALING
 SHARED_LIBRARY_LIBS += \
   $(DEPTH)/media/webrtc/signaling/signaling_ecc/$(LIB_PREFIX)ecc.$(LIB_SUFFIX) \
diff -ruN comm-release/mozilla/toolkit/mozapps/installer/packager.mk comm-patched/mozilla/toolkit/mozapps/installer/packager.mk
--- comm-release/mozilla/toolkit/mozapps/installer/packager.mk	2014-03-19 01:42:17.000000000 +0000
+++ comm-patched/mozilla/toolkit/mozapps/installer/packager.mk	2014-04-27 14:07:20.215199207 +0100
@@ -775,7 +775,7 @@
 	$(NSINSTALL) -D $(DESTDIR)$(bindir)
 	$(RM) -f $(DESTDIR)$(bindir)/$(MOZ_APP_NAME)
 	ln -s $(installdir)/$(MOZ_APP_NAME) $(DESTDIR)$(bindir)
-ifdef INSTALL_SDK # Here comes the hard part
+ifeq ($(MOZ_APP_NAME),xulrunner)
 	$(NSINSTALL) -D $(DESTDIR)$(includedir)
 	(cd $(DIST)/include && $(TAR) $(TAR_CREATE_FLAGS) - .) | \
 	  (cd $(DESTDIR)$(includedir) && tar -xf -)
diff -ruN comm-release/mozilla/toolkit/mozapps/update/updater/updater.cpp comm-patched/mozilla/toolkit/mozapps/update/updater/updater.cpp
--- comm-release/mozilla/toolkit/mozapps/update/updater/updater.cpp	2014-03-19 01:42:17.000000000 +0000
+++ comm-patched/mozilla/toolkit/mozapps/update/updater/updater.cpp	2014-04-27 14:07:20.274768248 +0100
@@ -127,7 +127,10 @@
 // declare it here to avoid including that entire header file.
 #define BZ2_CRC32TABLE_UNDECLARED
 
-#if MOZ_IS_GCC
+#if defined(__clang__)
+extern "C"  __attribute__((visibility("default"))) unsigned int BZ2_crc32Table[256];
+#undef BZ2_CRC32TABLE_UNDECLARED
+#elif MOZ_IS_GCC
 #if MOZ_GCC_VERSION_AT_LEAST(3, 3, 0)
 extern "C"  __attribute__((visibility("default"))) unsigned int BZ2_crc32Table[256];
 #undef BZ2_CRC32TABLE_UNDECLARED
diff -ruN comm-release/mozilla/toolkit/toolkit.mozbuild comm-patched/mozilla/toolkit/toolkit.mozbuild
--- comm-release/mozilla/toolkit/toolkit.mozbuild	2014-03-19 01:42:17.000000000 +0000
+++ comm-patched/mozilla/toolkit/toolkit.mozbuild	2014-04-27 14:07:20.275140691 +0100
@@ -44,8 +44,8 @@
 if CONFIG['MOZ_AUTH_EXTENSION']:
     add_tier_dir('platform', 'extensions/auth')
 
-if CONFIG['MOZ_UPDATER']:
-    add_tier_dir('platform', 'other-licenses/bsdiff')
+#if CONFIG['MOZ_UPDATER']:
+#    add_tier_dir('platform', 'other-licenses/bsdiff')
 
 # Gecko/Core components.
 
diff -ruN comm-release/mozilla/toolkit/xre/nsEmbedFunctions.cpp comm-patched/mozilla/toolkit/xre/nsEmbedFunctions.cpp
--- comm-release/mozilla/toolkit/xre/nsEmbedFunctions.cpp	2014-03-19 01:42:17.000000000 +0000
+++ comm-patched/mozilla/toolkit/xre/nsEmbedFunctions.cpp	2014-04-27 14:07:20.275585268 +0100
@@ -230,7 +230,7 @@
 {
 #if defined(XP_WIN) || defined(XP_MACOSX)
   return CrashReporter::SetRemoteExceptionHandler(nsDependentCString(aPipe));
-#elif defined(OS_LINUX)
+#elif defined(OS_LINUX) || defined(OS_SOLARIS)
   return CrashReporter::SetRemoteExceptionHandler();
 #else
 #  error "OOP crash reporter unsupported on this platform"
@@ -368,7 +368,7 @@
     // Bug 684322 will add better visibility into this condition
     NS_WARNING("Could not setup crash reporting\n");
   }
-#  elif defined(OS_LINUX)
+#  elif defined(OS_LINUX) || defined(OS_SOLARIS)
   // on POSIX, |crashReporterArg| is "true" if crash reporting is
   // enabled, false otherwise
   if (0 != strcmp("false", crashReporterArg) && 
diff -ruN comm-release/mozilla/xpcom/base/nsStackWalk.cpp comm-patched/mozilla/xpcom/base/nsStackWalk.cpp
--- comm-release/mozilla/xpcom/base/nsStackWalk.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/base/nsStackWalk.cpp	2014-04-27 14:07:20.276467977 +0100
@@ -23,6 +23,12 @@
 };
 static CriticalAddress gCriticalAddress;
 
+// for _Unwind_Backtrace from libcxxrt or libunwind
+// cxxabi.h from libcxxrt implicitly includes unwind.h first
+#if defined(HAVE__UNWIND_BACKTRACE) && !defined(_GNU_SOURCE)
+#define _GNU_SOURCE
+#endif
+
 #if defined(HAVE_DLOPEN) || defined(XP_MACOSX)
 #include <dlfcn.h>
 #endif
@@ -874,7 +880,7 @@
 }
 
 
-#if NSSTACKWALK_SUPPORTS_SOLARIS
+#if notNSSTACKWALK_SUPPORTS_SOLARIS
 
 /*
  * Stack walking code for Solaris courtesy of Bart Smaalder's "memtrak".
@@ -1223,9 +1229,6 @@
 #elif defined(HAVE__UNWIND_BACKTRACE)
 
 // libgcc_s.so symbols _Unwind_Backtrace@@GCC_3.3 and _Unwind_GetIP@@GCC_3.0
-#ifndef _GNU_SOURCE
-#define _GNU_SOURCE
-#endif
 #include <unwind.h>
 
 struct unwind_info {
diff -ruN comm-release/mozilla/xpcom/base/nscore.h comm-patched/mozilla/xpcom/base/nscore.h
--- comm-release/mozilla/xpcom/base/nscore.h	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/base/nscore.h	2014-04-27 14:07:20.275954509 +0100
@@ -110,7 +110,7 @@
  *           NS_HIDDEN_(int) NS_FASTCALL func2(char *foo);
  */
 
-#if defined(__i386__) && defined(__GNUC__) && !defined(XP_OS2)
+#if defined(__i386__) && defined(__GNUC__) && !defined(XP_OS2) && !(defined(__clang__) && __clang_major__ == 3 && __clang_minor__ == 4 && __clang_patchlevel__ == 0)
 #define NS_FASTCALL __attribute__ ((regparm (3), stdcall))
 #define NS_CONSTRUCTOR_FASTCALL __attribute__ ((regparm (3), stdcall))
 #elif defined(XP_WIN) && !defined(_WIN64)
diff -ruN comm-release/mozilla/xpcom/ds/TimeStamp.h comm-patched/mozilla/xpcom/ds/TimeStamp.h
--- comm-release/mozilla/xpcom/ds/TimeStamp.h	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/ds/TimeStamp.h	2014-04-27 14:07:20.276800757 +0100
@@ -165,11 +165,11 @@
     // NOTE: this MUST be a >= test, because int64_t(double(INT64_MAX))
     // overflows and gives INT64_MIN.
     if (aTicks >= double(INT64_MAX))
-      return TimeDuration::FromTicks(INT64_MAX);
+      return TimeDuration::FromTicks(int64_t(INT64_MAX));
 
     // This MUST be a <= test.
     if (aTicks <= double(INT64_MIN))
-      return TimeDuration::FromTicks(INT64_MIN);
+      return TimeDuration::FromTicks(int64_t(INT64_MIN));
 
     return TimeDuration::FromTicks(int64_t(aTicks));
   }
Binary files comm-release/mozilla/xpcom/idl-parser/header.pyc and comm-patched/mozilla/xpcom/idl-parser/header.pyc differ
Binary files comm-release/mozilla/xpcom/idl-parser/typelib.pyc and comm-patched/mozilla/xpcom/idl-parser/typelib.pyc differ
Binary files comm-release/mozilla/xpcom/idl-parser/xpidl.pyc and comm-patched/mozilla/xpcom/idl-parser/xpidl.pyc differ
diff -ruN comm-release/mozilla/xpcom/io/nsLocalFileUnix.cpp comm-patched/mozilla/xpcom/io/nsLocalFileUnix.cpp
--- comm-release/mozilla/xpcom/io/nsLocalFileUnix.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/io/nsLocalFileUnix.cpp	2014-04-27 14:40:06.990523059 +0100
@@ -28,6 +28,8 @@
 #include <sys/quota.h>
 #endif
 
+#include <limits.h>
+
 #include "xpcom-private.h"
 #include "nsDirectoryServiceDefs.h"
 #include "nsCRT.h"
@@ -382,7 +384,7 @@
         PR_Delete(mPath.get());
     }
 
-#if defined(LINUX) && !defined(ANDROID)
+#if defined(HAVE_POSIX_FADVISE)
     if (flags & OS_READAHEAD) {
         posix_fadvise(PR_FileDesc2NativeHandle(*_retval), 0, 0,
                       POSIX_FADV_SEQUENTIAL);
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/Makefile.in comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/Makefile.in
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/Makefile.in	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/Makefile.in	2014-04-27 14:07:20.227908793 +0100
@@ -83,6 +83,39 @@
 # SPARC
 ######################################################################
 #
+# Linux/SPARC
+#
+ifeq ($(OS_ARCH),Linux)
+ifneq (,$(findstring sparc,$(OS_TEST)))
+ASFILES		:= xptcinvoke_asm_sparc_linux_GCC3.s xptcstubs_asm_sparc_solaris.s
+endif
+endif
+#
+# NetBSD/SPARC
+#
+ifeq ($(OS_ARCH)$(OS_TEST),NetBSDsparc)
+ASFILES		:= xptcinvoke_asm_sparc_netbsd.s xptcstubs_asm_sparc_netbsd.s
+endif
+#
+# OpenBSD/SPARC
+#
+ifeq ($(OS_ARCH)$(OS_TEST),OpenBSDsparc)
+ASFILES		:= xptcinvoke_asm_sparc_openbsd.s xptcstubs_asm_sparc_openbsd.s
+endif
+#
+# OpenBSD/SPARC64
+#
+ifneq (,$(filter OpenBSDsparc64 FreeBSDsparc64,$(OS_ARCH)$(OS_TEST)))
+ASFILES		:= xptcinvoke_asm_sparc64_openbsd.s xptcstubs_asm_sparc64_openbsd.s
+endif
+#
+# NetBSD/SPARC64
+#
+ifeq ($(OS_ARCH)$(OS_TEST),NetBSDsparc64)
+CPPSRCS                := xptcinvoke_sparc64_netbsd.cpp xptcstubs_sparc64_openbsd.cpp
+ASFILES                := xptcinvoke_asm_sparc64_openbsd.s xptcstubs_asm_sparc64_netbsd.s
+endif
+#
 # Solaris/SPARC
 #
 ifeq ($(OS_ARCH),SunOS)
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/moz.build comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/moz.build
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/moz.build	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/moz.build	2014-04-27 14:07:20.277868059 +0100
@@ -19,14 +19,14 @@
     if '86' in CONFIG['OS_TEST'] and CONFIG['OS_TEST'] != 'x86_64':
         DEFINES['MOZ_NEED_LEADING_UNDERSCORE'] = True
 
-if CONFIG['OS_ARCH'] in ('NetBSD', 'OpenBSD', 'GNU'):
+if CONFIG['OS_ARCH'] in ('OpenBSD', 'GNU'):
     if CONFIG['CPU_ARCH'] == 'x86':
         SOURCES += [
             'xptcinvoke_gcc_x86_unix.cpp',
             'xptcstubs_gcc_x86_unix.cpp'
         ]
 
-if CONFIG['OS_ARCH'] in ('Linux', 'FreeBSD') or \
+if CONFIG['OS_ARCH'] in ('Linux', 'FreeBSD', 'NetBSD', 'DragonFly') or \
    CONFIG['OS_ARCH'].startswith('GNU_'):
     if CONFIG['OS_TEST'] == 'x86_64':
         SOURCES += [
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_mips.S comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_mips.S
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_mips.S	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_mips.S	2014-04-27 14:07:20.278138718 +0100
@@ -16,6 +16,47 @@
 #include <sys/asm.h>
 #endif
 
+#ifdef __NetBSD__
+# include <machine/regdef.h>
+# include <machine/asm.h>
+# ifndef fp
+#  define      fp      s8
+# endif
+# ifndef PTRLOG
+#  if SZREG == 4
+#   define     PTRLOG  2
+#  else
+#   define     PTRLOG  3
+#  endif
+# endif
+# ifndef SETUP_GP
+#  if defined(__mips_o32)
+#   define     SETUP_GP        \
+               .set push;      \
+               .set noreorder; \
+               .cpload t9;     \
+               .set pop
+#   define     SAVE_GP(x)      \
+               .cprestore x
+#  else
+#   define     SETUP_GP
+#   define     SAVE_GP(x)
+#  endif
+# endif
+# ifndef ALSZ
+#  if defined(__mips_n32) || defined(__mips_n64)
+#   define     ALSZ    15
+#   define     ALMASK  ~15
+#  else
+#   define     ALSZ    7
+#   define     ALMASK  ~7
+#  endif
+# endif
+#else
+# include <sys/regdef.h>
+# include <sys/asm.h>
+#endif
+
 # NARGSAVE is the argument space in the callers frame, including extra
 # 'shadowed' space for the argument registers. The minimum of 4
 # argument slots is sometimes predefined in the header files.
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_ppc_netbsd.s comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_ppc_netbsd.s
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_ppc_netbsd.s	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_asm_ppc_netbsd.s	2014-04-27 14:07:20.282446165 +0100
@@ -20,15 +20,15 @@
 		      
         .section ".text"
 	.align 2
-	.globl XPTC_InvokeByIndex
-	.type  XPTC_InvokeByIndex,@function
+	.globl NS_InvokeByIndex_P
+	.type  NS_InvokeByIndex_P,@function
 
 #
-# XPTC_InvokeByIndex(nsISupports* that, uint32_t methodIndex,
-#                    uint32_t paramCount, nsXPTCVariant* params)
+# NS_InvokeByIndex_P(nsISupports* that, PRUint32 methodIndex,
+#                    PRUint32 paramCount, nsXPTCVariant* params)
 #
 
-XPTC_InvokeByIndex:
+NS_InvokeByIndex_P:
 	stwu    sp,-32(sp)			# setup standard stack frame
 	mflr    r0				# save LR
 	stw     r3,8(sp)			# r3 <= that
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_gcc_x86_unix.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_gcc_x86_unix.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_gcc_x86_unix.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_gcc_x86_unix.cpp	2014-04-27 14:07:20.278384823 +0100
@@ -9,7 +9,7 @@
 #include "xptc_gcc_x86_unix.h"
 
 extern "C" {
-static void ATTRIBUTE_USED __attribute__ ((regparm(3)))
+void ATTRIBUTE_USED __attribute__ ((regparm(3)))
 invoke_copy_to_stack(uint32_t paramCount, nsXPTCVariant* s, uint32_t* d)
 {
     for(uint32_t i = paramCount; i >0; i--, d++, s++)
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_netbsd_m68k.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_netbsd_m68k.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_netbsd_m68k.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_netbsd_m68k.cpp	2014-04-27 14:07:20.281665043 +0100
@@ -100,6 +100,15 @@
     }
 }
 
+/*
+ * SYMBOL PREFIX must be "_" for aout symbols and "" for ELF
+ */
+#ifndef __ELF__
+#define	SYMBOLPREFIX	"_"
+#else
+#define	SYMBOLPREFIX
+#endif
+
 XPTC_PUBLIC_API(nsresult)
 XPTC_InvokeByIndex(nsISupports* that, uint32_t methodIndex,
                    uint32_t paramCount, nsXPTCVariant* params)
@@ -107,30 +116,30 @@
     uint32_t result;
 
  __asm__ __volatile__(
-    "movl  %4, sp@-\n\t"
-    "movl  %3, sp@-\n\t"
-    "jbsr  _invoke_count_words\n\t"     /* count words */
-    "addql #8, sp\n\t"
-    "lsll  #2, d0\n\t"      /* *= 4 */
-    "movl  sp, a2\n\t"	    /* save original sp */
-    "subl  d0, sp\n\t"      /* make room for params */
-    "movl  sp, a0\n\t"
-    "movl  %4, sp@-\n\t"
-    "movl  %3, sp@-\n\t"
-    "movl  a0, sp@-\n\t"
-    "jbsr  _invoke_copy_to_stack\n\t"   /* copy params */
-    "addl  #12, sp\n\t"
-    "movl  %1, a0\n\t"
-    "movl  a0@, a1\n\t"
-    "movl  %2, d0\n\t"      /* function index */
-    "movl  a0, d1\n\t"
-    "movw  a1@(8,d0:l:8), a0\n\t"
-    "addl  a0, d1\n\t"
-    "movl  a1@(12,d0:l:8), a1\n\t"
-    "movl  d1, sp@-\n\t"
-    "jbsr  a1@\n\t"
-    "movl  a2, sp\n\t"	    /* restore original sp */
-    "movl  d0, %0\n\t"
+    "movl  %4, %%sp@-\n\t"
+    "movl  %3, %%sp@-\n\t"
+    "jbsr  "SYMBOLPREFIX"invoke_count_words\n\t"     /* count words */
+    "addql #8, %%sp\n\t"
+    "lsll  #2, %%d0\n\t"      /* *= 4 */
+    "movl  %%sp, %%a2\n\t"         /* save original sp */
+    "subl  %%d0, %%sp\n\t"      /* make room for params */
+    "movl  %%sp, %%a0\n\t"
+    "movl  %4, %%sp@-\n\t"
+    "movl  %3, %%sp@-\n\t"
+    "movl  %%a0, %%sp@-\n\t"
+    "jbsr  "SYMBOLPREFIX"invoke_copy_to_stack\n\t"   /* copy params */
+    "addl  #12, %%sp\n\t"
+    "movl  %1, %%a0\n\t"
+    "movl  %%a0@, %%a1\n\t"
+    "movl  %2, %%d0\n\t"      /* function index */
+    "movl  %%a0, %%d1\n\t"
+    "movw  %%a1@(8,%%d0:l:8), %%a0\n\t"
+    "addl  %%a0, %%d1\n\t"
+    "movl  %%a1@(12,%%d0:l:8), %%a1\n\t"
+    "movl  %%d1, %%sp@-\n\t"
+    "jbsr  %%a1@\n\t"
+    "movl  %%a2, %%sp\n\t"         /* restore original sp */
+    "movl  %%d0, %0\n\t"
     : "=g" (result)         /* %0 */
     : "g" (that),           /* %1 */
       "g" (methodIndex),    /* %2 */
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_ppc_netbsd.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_ppc_netbsd.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_ppc_netbsd.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_ppc_netbsd.cpp	2014-04-27 14:07:20.278671661 +0100
@@ -5,9 +5,9 @@
 
 // Platform specific code to invoke XPCOM methods on native objects
 
-// The purpose of XPTC_InvokeByIndex() is to map a platform
+// The purpose of NS_InvokeByIndex_P() is to map a platform
 // indepenpent call to the platform ABI. To do that,
-// XPTC_InvokeByIndex() has to determine the method to call via vtable
+// NS_InvokeByIndex_P() has to determine the method to call via vtable
 // access. The parameters for the method are read from the
 // nsXPTCVariant* and prepared for the native ABI.  For the Linux/PPC
 // ABI this means that the first 8 integral and floating point
@@ -69,8 +69,10 @@
                 if ((uint32_t) d & 4) d++; // doubles are 8-byte aligned on stack
                 *((double*) d) = s->val.d;
                 d += 2;
+#if __GXX_ABI_VERSION < 100
 		if (gpr < GPR_COUNT)
 		    gpr += 2;
+#endif
             }
         }
         else if (!s->IsPtrData() && s->type == nsXPTType::T_FLOAT) {
@@ -79,8 +81,10 @@
             else {
                 *((float*) d) = s->val.f;
 		d += 1;
+#if __GXX_ABI_VERSION < 100
 		if (gpr < GPR_COUNT)
 		    gpr += 1;
+#endif
 	    }
         }
         else if (!s->IsPtrData() && (s->type == nsXPTType::T_I64
@@ -107,6 +111,6 @@
 }
 
 extern "C"
-XPTC_PUBLIC_API(nsresult)
-XPTC_InvokeByIndex(nsISupports* that, uint32_t methodIndex,
+EXPORT_XPCOM_API(nsresult)
+NS_InvokeByIndex_P(nsISupports* that, PRUint32 methodIndex,
                    uint32_t paramCount, nsXPTCVariant* params);
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_sparc64_netbsd.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_sparc64_netbsd.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_sparc64_netbsd.cpp	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcinvoke_sparc64_netbsd.cpp	2014-04-27 14:07:20.281189060 +0100
@@ -0,0 +1,84 @@
+/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ *
+ * The contents of this file are subject to the Netscape Public
+ * License Version 1.1 (the "License"); you may not use this file
+ * except in compliance with the License. You may obtain a copy of
+ * the License at http://www.mozilla.org/NPL/
+ *
+ * Software distributed under the License is distributed on an "AS
+ * IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+ * implied. See the License for the specific language governing
+ * rights and limitations under the License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is Netscape
+ * Communications Corporation.  Portions created by Netscape are
+ * Copyright (C) 1998 Netscape Communications Corporation. All
+ * Rights Reserved.
+ *
+ * Contributor(s): 
+ */
+
+/* Platform specific code to invoke XPCOM methods on native objects */
+
+#include "xptcprivate.h"
+
+#if !defined(__sparc64__) && !defined(_LP64)
+#error "This code is for Sparc64 only"
+#endif
+
+extern "C" PRUint32
+invoke_copy_to_stack(PRUint64* d, PRUint32 paramCount, nsXPTCVariant* s)
+{
+  /*
+    We need to copy the parameters for this function to locals and use them
+    from there since the parameters occupy the same stack space as the stack
+    we're trying to populate.
+  */
+  PRUint64 *l_d = d;
+  nsXPTCVariant *l_s = s;
+  PRUint64 l_paramCount = paramCount;
+  PRUint64 regCount = 0;  // return the number of registers to load from the stack
+
+  for(PRUint64 i = 0; i < l_paramCount; i++, l_d++, l_s++)
+  {
+    if (regCount < 5) regCount++;
+
+    if (l_s->IsPtrData())
+    {
+      *l_d = (PRUint64)l_s->ptr;
+      continue;
+    }
+    switch (l_s->type)
+    {
+      case nsXPTType::T_I8    : *((PRInt64*)l_d)     = l_s->val.i8;    break;
+      case nsXPTType::T_I16   : *((PRInt64*)l_d)     = l_s->val.i16;   break;
+      case nsXPTType::T_I32   : *((PRInt64*)l_d)     = l_s->val.i32;   break;
+      case nsXPTType::T_I64   : *((PRInt64*)l_d)     = l_s->val.i64;   break;
+      
+      case nsXPTType::T_U8    : *((PRUint64*)l_d)    = l_s->val.u8;    break;
+      case nsXPTType::T_U16   : *((PRUint64*)l_d)    = l_s->val.u16;   break;
+      case nsXPTType::T_U32   : *((PRUint64*)l_d)    = l_s->val.u32;   break;
+      case nsXPTType::T_U64   : *((PRUint64*)l_d)    = l_s->val.u64;   break;
+
+      /* in the case of floats, we want to put the bits in to the
+         64bit space right justified... floats in the paramter array on
+         sparcv9 use odd numbered registers.. %f1, %f3, so we have to skip
+         the space that would be occupied by %f0, %f2, etc.
+      */
+      case nsXPTType::T_FLOAT : *(((float*)l_d) + 1) = l_s->val.f;     break;
+      case nsXPTType::T_DOUBLE: *((double*)l_d)      = l_s->val.d;     break;
+      case nsXPTType::T_BOOL  : *((PRInt64*)l_d)      = l_s->val.b;     break;
+      case nsXPTType::T_CHAR  : *((PRUint64*)l_d)    = l_s->val.c;     break;
+      case nsXPTType::T_WCHAR : *((PRInt64*)l_d)     = l_s->val.wc;    break;
+
+      default:
+        // all the others are plain pointer types
+        *((void**)l_d) = l_s->val.p;
+        break;
+    }
+  }
+  
+  return regCount;
+}
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_arm_netbsd.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_arm_netbsd.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_arm_netbsd.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_arm_netbsd.cpp	2014-04-27 14:07:20.282183638 +0100
@@ -86,18 +86,23 @@
  * so they are contiguous with values passed on the stack, and then calls
  * PrepareAndDispatch() to do the dirty work.
  */
+#ifndef	__ELF__
+#define	SYMBOLPREFIX	"_"
+#else
+#define	SYMBOLPREFIX
+#endif
 
 #define STUB_ENTRY(n)							\
 __asm__(								\
-    ".global	_Stub"#n"__14nsXPTCStubBase\n\t"			\
-"_Stub"#n"__14nsXPTCStubBase:\n\t"					\
+    ".global	"SYMBOLPREFIX"Stub"#n"__14nsXPTCStubBase\n\t"		\
+SYMBOLPREFIX"Stub"#n"__14nsXPTCStubBase:\n\t"				\
     "stmfd	sp!, {r1, r2, r3}	\n\t"				\
     "mov	ip, sp			\n\t"				\
     "stmfd	sp!, {fp, ip, lr, pc}	\n\t"				\
     "sub	fp, ip, #4		\n\t"				\
     "mov	r1, #"#n"		\n\t"    /* = methodIndex 	*/ \
     "add	r2, sp, #16		\n\t"				\
-    "bl		_PrepareAndDispatch__FP14nsXPTCStubBaseUiPUi   \n\t"	\
+    "bl		"SYMBOLPREFIX"PrepareAndDispatch__FP14nsXPTCStubBaseUiPUi   \n\t"	\
     "ldmea	fp, {fp, sp, lr}	\n\t"				\
     "add	sp, sp, #12		\n\t"				\
     "mov	pc, lr			\n\t"				\
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_mips.S comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_mips.S
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_mips.S	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_mips.S	2014-04-27 14:07:20.278931459 +0100
@@ -14,6 +14,47 @@
 #include <sys/asm.h>
 #endif
 
+#ifdef __NetBSD__
+# include <machine/regdef.h>
+# include <machine/asm.h>
+# ifndef fp
+#  define      fp      s8
+# endif
+# ifndef PTRLOG
+#  if SZREG == 4
+#   define     PTRLOG  2
+#  else
+#   define     PTRLOG  3
+#  endif
+# endif
+# ifndef SETUP_GP
+#  if defined(__mips_o32)
+#   define     SETUP_GP        \
+               .set push;      \
+               .set noreorder; \
+               .cpload t9;     \
+               .set pop
+#   define     SAVE_GP(x)      \
+               .cprestore x
+#  else
+#   define     SETUP_GP
+#   define     SAVE_GP(x)
+#  endif
+# endif
+# ifndef ALSZ
+#  if defined(__mips_n32) || defined(__mips_n64)
+#   define     ALSZ    15
+#   define     ALMASK  ~15
+#  else
+#   define     ALSZ    7
+#   define     ALMASK  ~7
+#  endif
+# endif
+#else
+# include <sys/regdef.h>
+# include <sys/asm.h>
+#endif
+
 # NARGSAVE is the argument space in the callers frame, including extra
 # 'shadowed' space for the argument registers. The minimum of 4
 # argument slots is sometimes predefined in the header files.
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_sparc64_netbsd.s comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_sparc64_netbsd.s
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_sparc64_netbsd.s	1970-01-01 01:00:00.000000000 +0100
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_asm_sparc64_netbsd.s	2014-04-27 14:07:20.281409063 +0100
@@ -0,0 +1,66 @@
+/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ *
+ * The contents of this file are subject to the Netscape Public
+ * License Version 1.1 (the "License"); you may not use this file
+ * except in compliance with the License. You may obtain a copy of
+ * the License at http://www.mozilla.org/NPL/
+ *
+ * Software distributed under the License is distributed on an "AS
+ * IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+ * implied. See the License for the specific language governing
+ * rights and limitations under the License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is Netscape
+ * Communications Corporation.  Portions created by Netscape are
+ * Copyright (C) 1999 Netscape Communications Corporation. All
+ * Rights Reserved.
+ *
+ * Contributor(s): 
+ */
+
+        .global SharedStub
+
+/*
+    in the frame for the function that called SharedStub are the
+    rest of the parameters we need
+
+*/
+
+SharedStub:
+! we don't create a new frame yet, but work within the frame of the calling
+! function to give ourselves the other parameters we want
+
+	mov	%o0, %o1	       ! shuffle the index up to 2nd place
+	mov	%i0, %o0	       ! the original 'this'
+	add	%fp, 0x7ff + 136, %o2  ! previous stack top adjusted to the first argument slot (beyond 'this')
+
+! save off the original incoming parameters that arrived in 
+! registers, the ABI guarantees the space for us to do this
+	stx	%i1, [%fp + 0x7ff + 136]
+	stx	%i2, [%fp + 0x7ff + 144]
+	stx	%i3, [%fp + 0x7ff + 152]
+	stx	%i4, [%fp + 0x7ff + 160]
+	stx	%i5, [%fp + 0x7ff + 168]
+! now we can build our own stack frame
+	save	%sp,-(128 + 64),%sp    ! room for the register window and
+				       ! struct pointer, rounded up to 0 % 64
+! our function now appears to have been called
+! as SharedStub(nsISupports* that, PRUint32 index, PRUint32* args)
+! so we can just copy these through
+
+	mov	%i0, %o0
+	mov	%i1, %o1
+	mov	%i2, %o2
+	call	PrepareAndDispatch
+	 nop
+	mov	%o0,%i0 	    ! propagate return value
+	b .LL1
+	 nop
+.LL1:
+	ret
+	 restore
+
+       .size	SharedStub, .-SharedStub
+       .type	SharedStub, #function
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_gcc_x86_unix.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_gcc_x86_unix.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_gcc_x86_unix.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_gcc_x86_unix.cpp	2014-04-27 14:07:20.279177191 +0100
@@ -10,7 +10,7 @@
 #include "xptc_gcc_x86_unix.h"
 
 extern "C" {
-static nsresult ATTRIBUTE_USED
+nsresult ATTRIBUTE_USED
 __attribute__ ((regparm (3)))
 PrepareAndDispatch(uint32_t methodIndex, nsXPTCStubBase* self, uint32_t* args)
 {
diff -ruN comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_netbsd_m68k.cpp comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_netbsd_m68k.cpp
--- comm-release/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_netbsd_m68k.cpp	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xpcom/reflect/xptcall/src/md/unix/xptcstubs_netbsd_m68k.cpp	2014-04-27 14:07:20.281928315 +0100
@@ -91,17 +91,27 @@
     }
 }
 
+/*
+ * Beware: use % instead of %% for register identifiers in a preprocessor macro
+ * SYMBOL PREFIX must be "_" for aout and "" for ELF 
+ */
+#ifndef	__ELF__
+#define	SYMBOLPREFIX	"_"
+#else
+#define	SYMBOLPREFIX
+#endif
+
 #define STUB_ENTRY(n)							\
 __asm__(								\
-    ".global	_Stub"#n"__14nsXPTCStubBase\n\t"			\
-"_Stub"#n"__14nsXPTCStubBase:\n\t"					\
-    "link  a6,#0			\n\t"				\
-    "lea   a6@(12), a0			\n\t"	/* pointer to args */	\
-    "movl  a0, sp@-			\n\t"				\
-    "movl  #"#n", sp@-			\n\t"	/* method index */	\
-    "movl  a6@(8), sp@-			\n\t"	/* this */		\
-    "jbsr  _PrepareAndDispatch		\n\t"				\
-    "unlk  a6				\n\t"				\
+    ".global   "SYMBOLPREFIX"Stub"#n"__14nsXPTCStubBase\n\t"           \
+SYMBOLPREFIX"Stub"#n"__14nsXPTCStubBase:\n\t"                          \
+    "link  %a6,#0                      \n\t"                           \
+    "lea   %a6@(12), %a0               \n\t"   /* pointer to args */   \
+    "movl  %a0, %sp@-                  \n\t"                           \
+    "movl  #"#n", %sp@-                        \n\t"   /* method index */      \
+    "movl  %a6@(8), %sp@-              \n\t"   /* this */              \
+    "jbsr  "SYMBOLPREFIX"PrepareAndDispatch\n\t"                       \
+    "unlk  %a6                         \n\t"                           \
     "rts				\n\t"				\
 );
 
Binary files comm-release/mozilla/xpcom/typelib/xpt/tools/xpt.pyc and comm-patched/mozilla/xpcom/typelib/xpt/tools/xpt.pyc differ
diff -ruN comm-release/mozilla/xulrunner/installer/Makefile.in comm-patched/mozilla/xulrunner/installer/Makefile.in
--- comm-release/mozilla/xulrunner/installer/Makefile.in	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xulrunner/installer/Makefile.in	2014-04-27 14:07:20.279452306 +0100
@@ -86,7 +86,7 @@
 
 install:: $(pkg_config_files)
 	@echo pkg_config_file: $(pkg_config_files)
-	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(libdir)/pkgconfig
+	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)${PREFIX}/lib/${MOZILLA_PKG_NAME}/pkgconfig
 
 GARBAGE += $(pkg_config_files)
 
diff -ruN comm-release/mozilla/xulrunner/installer/libxul-embedding.pc.in comm-patched/mozilla/xulrunner/installer/libxul-embedding.pc.in
--- comm-release/mozilla/xulrunner/installer/libxul-embedding.pc.in	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xulrunner/installer/libxul-embedding.pc.in	2014-04-27 14:07:20.279910350 +0100
@@ -6,5 +6,6 @@
 Name: libxul-embedding
 Description: Static library for version-independent embedding of the Mozilla runtime
 Version: %MOZILLA_VERSION%
-Libs: -L${sdkdir}/lib -lxpcomglue -ldl
+# XXXtnn -ldl removed
+Libs: -Wl,-R${prefix}/lib/xulrunner -Wl,-R${prefix}/lib/xulrunner -Wl,-R${prefix}/lib/xulrunner -Wl,-R${prefix}/lib/xulrunner -L${prefix}/lib/xulrunner -lxpcomglue
 Cflags: -DXPCOM_GLUE -I${includedir} %WCHAR_CFLAGS%
diff -ruN comm-release/mozilla/xulrunner/installer/libxul.pc.in comm-patched/mozilla/xulrunner/installer/libxul.pc.in
--- comm-release/mozilla/xulrunner/installer/libxul.pc.in	2014-03-19 01:42:18.000000000 +0000
+++ comm-patched/mozilla/xulrunner/installer/libxul.pc.in	2014-04-27 14:07:20.279694964 +0100
@@ -7,5 +7,5 @@
 Description: The Mozilla Runtime and Embedding Engine
 Version: %MOZILLA_VERSION%
 Requires: %NSPR_NAME% >= %NSPR_VERSION%
-Libs: -L${sdkdir}/lib %MOZ_XUL_LINK%
+Libs: -Wl,-R${prefix}/lib/xulrunner -Wl,-R${prefix}/lib/xulrunner -Wl,-R${prefix}/lib/xulrunner -Wl,-R${prefix}/lib/xulrunner -L${prefix}/lib/xulrunner %MOZ_XUL_LINK%
 Cflags: -I${includedir} %WCHAR_CFLAGS%
diff -ruN comm-release/suite/installer/Makefile.in comm-patched/suite/installer/Makefile.in
--- comm-release/suite/installer/Makefile.in	2014-03-19 01:33:05.000000000 +0000
+++ comm-patched/suite/installer/Makefile.in	2014-04-27 14:07:20.280451402 +0100
@@ -18,7 +18,7 @@
 MOZ_PKG_MANIFEST_P = $(srcdir)/package-manifest.in
 # Be fatal, except when building with XULRunner which already bundles some files.
 ifndef SYSTEM_LIBXUL
-MOZ_PKG_FATAL_WARNINGS = 1
+MOZ_PKG_FATAL_WARNINGS = 0
 endif
 
 MOZ_NONLOCALIZED_PKG_LIST = \
diff -ruN comm-release/suite/installer/package-manifest.in comm-patched/suite/installer/package-manifest.in
--- comm-release/suite/installer/package-manifest.in	2014-03-19 01:33:05.000000000 +0000
+++ comm-patched/suite/installer/package-manifest.in	2014-04-27 14:07:20.280877472 +0100
@@ -884,14 +884,11 @@
 @BINPATH@/extensions/inspector@mozilla.org/chrome.manifest
 @BINPATH@/extensions/inspector@mozilla.org/chrome/inspector@JAREXT@
 #ifdef MOZ_GTK2
-@BINPATH@/extensions/inspector@mozilla.org/platform/Linux/chrome/icons/default/winInspectorMain16.xpm
-@BINPATH@/extensions/inspector@mozilla.org/platform/Linux/chrome/icons/default/winInspectorMain.xpm
 #elifdef XP_WIN32
 @BINPATH@/extensions/inspector@mozilla.org/platform/WINNT/chrome/icons/default/winInspectorMain.ico
 #elifdef XP_OS2
 @BINPATH@/extensions/inspector@mozilla.org/platform/OS2/chrome/icons/default/winInspectorMain.ico
 #endif
-@BINPATH@/extensions/inspector@mozilla.org/components/components.list
 @BINPATH@/extensions/inspector@mozilla.org/components/inspector-cmdline.js
 @BINPATH@/extensions/inspector@mozilla.org/defaults/preferences/inspector.js
 #endif
